<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestão Integrada do Parceiro Ton</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
        /* ----------------------------------------------------
        * (A) ESTILOS GERAIS
        * ---------------------------------------------------*/
* {
          box-shadow: none !important;
        }
        body {
          font-family: 'Poppins', sans-serif;
          background: linear-gradient(to bottom, #003b00, #00d700);
          min-height: 100vh;
          background-attachment: fixed;
          background-repeat: no-repeat;
          background-size: cover;
          margin: 0;
          padding: 0;
          color: #000;
        }
        body, label, p, h1, h2, h3, h4, h5, h6, span {
          color: #000 !important;
        }
        h1, h2, h3 {
          font-weight: 600;
          color: #000;
        }
        .hidden { display: none !important; }

        body .card {
          padding: 16px;
          border-radius: 8px;
          margin-bottom: 24px;
          border: 1px solid #ccc;
        }


        /* Estilos para inputs dos modais de gerenciamento */
        .modal input[type="text"],
        .modal input[type="password"],
        .modal input[type="number"],
        .modal input[type="date"],
        .modal select,
        .modal textarea {
          display: inline-block;
          margin: 10px 0;
          width: 80%;
          max-width: 300px;
          padding: 10px;
          min-height: 40px;
          box-sizing: border-box;
          background: #fff !important;
          color: #000 !important;
          border-radius: 6px;
          border: 1px solid #ccc;
        }

        input,
        select,
        textarea {
          background: #fff !important;
          color: #000 !important;
          padding: 10px;
          min-height: 40px;
          border-radius: 6px;
          border: 1px solid #ccc;
        }


        /* Botão para toggle de senha – usará os ícones SVG */
        .toggle-password {
          width: 24px;
          height: 24px;
          border: none;
          cursor: pointer;
          vertical-align: middle;
          margin-left: 5px;
          padding: 0;
        }
        .toggle-password svg {
          width: 100%;
          height: 100%;
        }


        /* ----------------------------------------------------
        * (B) MODAIS E OVERLAY
        * ---------------------------------------------------*/
        .modal {
          position: fixed;
          top: 50%; left: 50%;
          transform: translate(-50%, -50%);
          padding: 20px;
          border: 1px solid #ccc;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          z-index: 1000;
          max-height: 80%;
          width: 80%;
          max-width: 900px;
          overflow-y: auto;
          font-size: 0.9rem;
          background: rgba(255, 255, 255, 0.97);
          color: #000;
        }
        .overlay {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          z-index: 900;
        }
        /* Redução do tamanho e centralização do modal de confirmação (usado para logout, etc.) */
        #modal-confirm .modal {
          max-width: 350px;
          width: 90%;
          padding: 15px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
        }
        /* Novo estilo para centralizar os botões dentro do modal de confirmação */
        #modal-confirm .modal-confirm-buttons {
          display: flex;
          justify-content: center;
          gap: 10px;
          width: 100%;
          margin-top: 15px;
        }
        #modal-confirm .modal-confirm-buttons button {
          flex: 1 1 auto;
          max-width: 150px;
          margin: 0;
        }


        /* ----------------------------------------------------
        * (C) TABELAS
        * ---------------------------------------------------*/
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 10px;
        }
        table th, table td {
          border: 1px solid #ccc;
          padding: 8px;
          text-align: left;
        }


        /* ----------------------------------------------------
        * (D) MODAL DE LOG
        * ---------------------------------------------------*/
        #modal-logs .scroll-area {
          max-height: 400px;
          overflow-y: auto;
          border: 1px solid #ddd;
          margin-top: 10px;
        }
        #modal-logs button.close-log {
          margin-top: 10px;
          padding: 6px 12px;
          cursor: pointer;
          border: none;
          font-weight: bold;
        }


        /* ----------------------------------------------------
        * (E) BOTÕES ADM – CONTAINER
        * ---------------------------------------------------*/
        .btn-container {
          position: fixed;
          bottom: 20px;
          right: 10px;
          display: flex;
          flex-direction: column;
          gap: 10px;
          z-index: 50;
        }
        .btn-container button {
          font-size: 0.8rem;
          padding: 6px 10px;
          cursor: pointer;
          opacity: 0.7;
          width: 150px;
        }
        .btn-container button:hover { opacity: 1; }
        #btn-funcoes-adm {
          color: #000;
          font-weight: bold;
        }


        /* ----------------------------------------------------
        * (F) DROPDOWNS (EDITAR/REMOVER) - ACTIONS
        * ---------------------------------------------------*/
        .action-options, .history-actions, .chip-actions {
          position: relative;
          display: inline-block;
        }
        .action-options .dropdown,
        .history-actions .dropdown,
        .chip-actions .dropdown {
          position: absolute;
          top: 100%;
          left: 0;
          border: 1px solid #ccc;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          z-index: 1000;
          display: none;
          opacity: 0;
          transition: opacity 0.3s ease;
        }
        .action-options .dropdown.visible,
        .history-actions .dropdown.visible,
        .chip-actions .dropdown.visible {
          display: block;
          opacity: 1;
        }
        .action-options .dropdown button,
        .history-actions .dropdown button,
        .chip-actions .dropdown button {
          display: block;
          width: 100%;
          border: none;
          padding: 4px;
          cursor: pointer;
          font-size: 0.8rem;
          text-align: left;
          margin: 2px 0;
          box-sizing: border-box;
        }
        .action-options .dropdown button:hover,
        .history-actions .dropdown button:hover,
        .chip-actions .dropdown button:hover {
        }
        .toggle-actions {
          padding: 4px;
          font-size: 0.8rem;
          cursor: pointer;
        }


        /* ----------------------------------------------------
        * (G) CABEÇALHO DE CATEGORIA
        * ---------------------------------------------------*/
        .category-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-top: 20px;
          margin-bottom: 5px;
        }
        .toggle-btn {
          cursor: pointer;
          padding: 2px 6px;
          border: none;
          font-weight: bold;
        }


        /* ----------------------------------------------------
        * (H) ÁREA ROLÁVEL
        * ---------------------------------------------------*/
        .scroll-area {
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid #ddd;
          margin-bottom: 10px;
        }


        /* ----------------------------------------------------
        * (I) BOTÕES DE AÇÃO PRINCIPAIS
        * ---------------------------------------------------*/
        .action-buttons {
          margin-top: 20px;
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
        }
        .action-buttons button {
          padding: 8px 12px;
          font-size: 0.9rem;
          cursor: pointer;
          opacity: 0.8;
          flex: 1 1 200px;
          max-width: 220px;
        }
        .action-buttons button:hover { opacity: 1; }


        /* ----------------------------------------------------
        * (J) BOTÃO "ENTRADA DE MÁQUININHAS"
        * ---------------------------------------------------*/
        #toggle-cadastro-btn {
          margin-bottom: 10px;
          padding: 6px 10px;
          font-size: 0.9rem;
          cursor: pointer;
          border: 1px solid #ccc;
          width: 200px;
          color: #fff;
        }
        body:not(.dark-mode) #toggle-cadastro-btn:hover {
        }


        /* ----------------------------------------------------
        * (K) LISTAS DE ITENS + BOTÕES EMPILHADOS
        * ---------------------------------------------------*/
        .lista-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid #ddd;
          padding: 4px 0;
        }
        .lista-item-buttons button {
          margin: 2px 0;
          cursor: pointer;
          font-size: 0.8rem;
          padding: 2px 6px;
        }


        /* ----------------------------------------------------
        * (L) FORMULÁRIO DE LOGIN
        * ---------------------------------------------------*/
        #login-form {
          max-width: 300px;
          margin: 0 auto;
          padding: 20px;
          border: 1px solid #ccc;
          border-radius: 5px;
          autocomplete: off;
        }
        #login-form input {
          display: inline-block;
          width: 80%;
          margin-bottom: 10px;
          padding: 10px;
          min-height: 40px;
        }
        /* Estilo para o aviso de login inválido */
        #login-error {
          font-size: 0.9rem;
          margin-top: 5px;
        }


        /* ----------------------------------------------------
        * (M) DASHBOARD DO CONSULTOR
        * ---------------------------------------------------*/
        #modal-dashboard-consultor table th,
        #modal-dashboard-consultor table td {
          padding: 4px;
          border: 1px solid #999;
        }
        #dash-data-personalizada {
          display: none;
          margin-bottom: 10px;
        }


        /* =====================================================
        * AJUSTES FINOS PARA OS BOTÕES DENTRO DOS MODAIS DA CENTRAL DO CADASTRO
        * -----------------------------------------------------*/
        .central-btn {
          display: block;
          margin: 12px auto;
          padding: 10px 15px;
          width: 80%;
          max-width: 300px;
          box-sizing: border-box;
          font-size: 1rem;
          cursor: pointer;
          min-width: 200px;
        }
        .fechar-btn {
          margin-top: 20px;
          color: #fff;
          border: 1px solid #f44336;
        }
        .modal-btn-small {
          padding: 5px 10px;
          font-size: 0.8rem;
          margin-left: 5px;
          min-width: 120px;
        }


        /* ----------------------------------------------------
        * (N) ESTILOS PARA MODAL PROMPT
        * ---------------------------------------------------*/
        #modal-prompt input {
          width: 90%;
          height: 50px;
          font-size: 1.1rem;
        }
        #modal-prompt .modal-buttons {
          position: absolute;
          bottom: 10px;
          right: 10px;
        }
        #modal-prompt textarea {
          width: 90%;
          height: 150px;
          font-size: 1.1rem;
          overflow-y: auto;
          resize: vertical;
          box-sizing: border-box;
          margin: 10px 0;
        }


        /* ----------------------------------------------------
        * (O) MODOS ESCURO
        * ---------------------------------------------------*/


        .central-custo-btn {
          font-size: 0.8rem;
          white-space: nowrap;
        }


        /* ----------------------------------------------------
        * (P) BARRA DE PROGRESSO (USADA NO RANKING)
        * ---------------------------------------------------*/
        .progress-bar {
          border-radius: 5px;
          margin: 5px 0;
          position: relative;
          height: 25px;
          width: 100%;
        }
        .progress-fill {
          height: 100%;
          border-radius: 5px;
          text-align: center;
          color: white;
          line-height: 25px;
          transition: width 0.5s ease;
        }


        /* ----------------------------------------------------
        * (R) AJUSTE PARA O MODAL DE ALERTA
        * ---------------------------------------------------*/
        #modal-alert {
          z-index: 5000 !important;
        }
        #modal-alert .overlay {
          z-index: 4990 !important;
        }
        #modal-alert .modal {
          z-index: 5000 !important;
        }


        /* ----------------------------------------------------
        * (S) AJUSTE PARA O MODAL PROMPT
        * ---------------------------------------------------*/
        #modal-prompt {
          z-index: 5000 !important;
        }
        #modal-prompt .overlay {
          z-index: 4990 !important;
        }
        #modal-prompt .modal {
          z-index: 5000 !important;
        }


        /* ----------------------------------------------------
        * (T) BONUS ALCANCADO EM BATCH DE 3
        * ---------------------------------------------------*/
        .bonus-alcancado {
          color: #fff !important;
        }


        /* ----------------------------------------------------
        * (U) ESTILO PARA A LISTA EXPANDIDA DOS CAMPEÕES
        * ---------------------------------------------------*/
        .campeoes-detalhe-list {
          margin-top: 5px;
          border: 1px solid #ddd;
          padding: 5px;
        }
        .campeoes-detalhe-list p {
          margin: 4px 0;
          font-size: 0.85rem;
        }
        .toggle-consultor-detalhe {
          cursor: pointer;
          margin-left: 8px;
          font-weight: bold;
          font-size: 0.9rem;
        }
        /* Ajuste para a lista expandida em modo escuro */
        .dark-mode .campeoes-detalhe-list {
          color: #fff;
          border-color: #666;
        }
  
/* ==== Ajuste visual Top Modelos ==== */
#modal-top-modelos .modal{
  display:flex;
  flex-direction:column;
  align-items:center;
}
#top-modelos-filtros{
  order:3;
  margin-top:16px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:center;
}
#top-modelos-filtros .central-btn{
  padding:4px 8px;
  font-size:0.75rem;
  width:auto;
  min-width:80px;
}
#modal-top-modelos .modal .fechar-btn{
  order:4;
  margin-top:12px;
}

/* Ajuste leve da pizza e resumo */
#topm-chart{
  margin-left:-30px;
}
#topm-summary p{
  margin:2px 0;
}

/* ==== Top Modelos visual layout ==== */
.topm-visual{
  margin-top:16px;
  display:flex;
  align-items:flex-start;
  gap:20px;
}
#topm-chart{
  flex:0 0 280px;
  max-width:280px;
}
#topm-summary{
  flex:1 1 auto;
  text-align:left;
  font-size:0.85rem;
}
#topm-summary p{ margin:4px 0; }

#topm-chart{
  width:280px !important;
  height:280px !important;
  flex:0 0 280px;
}

/* ==== Novos estilos globais para botões no modo claro ==== */
button,
.btn {
  background-color: #d8ff00 !important;
  color: #003b00 !important;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  padding: 10px 20px;
  transition: background-color 0.3s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;
  cursor: pointer;
}
button:hover {
  background-color: #c2e500 !important;
}

footer {
  background: transparent;
  backdrop-filter: blur(0);
}

/* 🌙 ESTILO GLOBAL PARA MODO ESCURO */
body.dark-mode {
  background: linear-gradient(to bottom, #0a0a0a, #1a1a1a) !important;
  color: #ffffff !important;
}

/* ✅ TEXTOS EM GERAL */
body.dark-mode h1,
body.dark-mode h2,
body.dark-mode h3,
body.dark-mode h4,
body.dark-mode h5,
body.dark-mode h6,
body.dark-mode p,
body.dark-mode span,
body.dark-mode label,
body.dark-mode td,
body.dark-mode th,
body.dark-mode strong {
  color: #ffffff !important;
}

/* ✅ INPUTS, SELECTS E TEXTAREAS */
body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
  background-color: #222 !important;
  color: #ffffff !important;
  border: 1px solid #444;
  border-radius: 6px;
}
body.dark-mode input::placeholder,
body.dark-mode textarea::placeholder {
  color: #888888 !important;
}

/* ✅ BOTÕES AMARELOS COM TEXTO PRETO */
body.dark-mode button,
body.dark-mode input[type="button"],
body.dark-mode input[type="submit"],
body.dark-mode .btn {
  background-color: #d8ff00 !important;
  color: #000000 !important;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  transition: transform 0.15s ease-in-out;
}
body.dark-mode .btn:hover,
body.dark-mode button:hover {
  transform: scale(1.03);
  filter: brightness(1.1);
}

/* ✅ MODAIS E CAIXAS */
body.dark-mode .modal,
body.dark-mode .card,
body.dark-mode .box {
  background-color: rgba(30, 30, 30, 0.95) !important;
  color: #ffffff !important;
  border-radius: 8px;
  padding: 20px;
  border: 1px solid #333;
}

/* ✅ TABELAS */
body.dark-mode table {
  background: transparent !important;
  color: #ffffff !important;
  border-color: #555;
}
body.dark-mode table td,
body.dark-mode table th {
  color: #ffffff !important;
}

/* ✅ COLUNA STATUS */
body.dark-mode td.status {
  color: #ffffff !important;
  font-weight: bold;
}
body.dark-mode td.status:has(span:contains("RESERVADO")),
body.dark-mode td.status span:contains("RESERVADO") {
  color: red !important;
}

/* ✅ Corrige botões "Mais", "Cadastrar", "Funções Adm" */
body.dark-mode button,
body.dark-mode input[type="submit"],
body.dark-mode .btn,
body.dark-mode .acao {
  background-color: #d8ff00 !important;
  color: #000 !important;
  font-weight: bold;
}
</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
["estoque", "vendas", "usuarios", "baixas", "consultores"].forEach(chave => {
  if (!localStorage.getItem(chave)) {
    localStorage.setItem(chave, JSON.stringify([]));
  }
});
window.addEventListener('DOMContentLoaded', () => {

/* =====================================================
* TOP MODELOS (RANKING) – MODAL & LÓGICA
* -----------------------------------------------------*/
const topModelosBtnsPeriod = {
  'hoje': document.getElementById('topm-hoje'),
  'ontem': document.getElementById('topm-ontem'),
  'esta-semana': document.getElementById('topm-esta-semana'),
  'semana-passada': document.getElementById('topm-semana-passada'),
  'este-mes': document.getElementById('topm-este-mes')
};
const topModelosRankingDiv = document.getElementById('topm-ranking');
const topModelosChartCanvas = document.getElementById('topm-chart');
let topModelosChart = null;

  const toggleDarkModeBtn = document.getElementById('toggle-dark-mode');
  const savedMode = localStorage.getItem('darkMode');
  if (savedMode === 'on') {
    document.body.classList.add('dark-mode');
    toggleDarkModeBtn.textContent = 'Modo Claro';
  }
  toggleDarkModeBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    if (document.body.classList.contains('dark-mode')) {
      localStorage.setItem('darkMode', 'on');
      toggleDarkModeBtn.textContent = 'Modo Claro';
    } else {
      localStorage.setItem('darkMode', 'off');
      toggleDarkModeBtn.textContent = 'Modo Escuro';
    }
  });

function abrirModalTopModelos(){
  document.getElementById('modal-top-modelos').classList.remove('hidden');
  filtrarTopModelosPorPeriodo('hoje');
}
function fecharModalTopModelos(){
  document.getElementById('modal-top-modelos').classList.add('hidden');
  if(topModelosChart){ topModelosChart.destroy(); topModelosChart = null; }
}

document.getElementById('btn-top-modelos').addEventListener('click', abrirModalTopModelos);
document.getElementById('fechar-modal-top-modelos').addEventListener('click', fecharModalTopModelos);

// Listeners de período
Object.entries(topModelosBtnsPeriod).forEach(([key,btn])=>{
  btn.addEventListener('click', ()=>filtrarTopModelosPorPeriodo(key));
});
document.getElementById('topm-personalizado').addEventListener('click', ()=>{
  document.getElementById('topm-data-personalizada').classList.toggle('hidden');
});
document.getElementById('topm-filtrar-personalizado').addEventListener('click', ()=>{
  filtrarTopModelosPorPeriodo('personalizado');
});


function periodDates(key){
  const now = new Date();
  // helper
  const atStart = (d)=>{ const n=new Date(d); n.setHours(0,0,0,0); return n; };
  const atEnd = (d)=>{ const n=new Date(d); n.setHours(23,59,59,999); return n; };

  let start, end;
  switch(key){
    case 'hoje':
      start = atStart(now);
      end   = atEnd(now);
      break;
    case 'ontem':
      const y = new Date(now);
      y.setDate(now.getDate()-1);
      start = atStart(y);
      end   = atEnd(y);
      break;
    case 'esta-semana':{
      const d = now.getDay() || 7; // domingo=0 ->7
      const monday = new Date(now);
      monday.setDate(now.getDate() - d + 1);
      start = atStart(monday);
      end   = atEnd(now);
      break;}
    case 'semana-passada':{
      const d = now.getDay() || 7;
      const lastSunday = new Date(now);
      lastSunday.setDate(now.getDate() - d);
      const mondayLast = new Date(lastSunday);
      mondayLast.setDate(lastSunday.getDate() - 6);
      start = atStart(mondayLast);
      end   = atEnd(lastSunday);
      break;}
    case 'este-mes':{
      const first = new Date(now.getFullYear(), now.getMonth(), 1);
      start = atStart(first);
      end   = atEnd(now);
      break;}
    
    case 'personalizado':
    default:{
      const sVal = document.getElementById('topm-data-inicio').value;
      const eVal = document.getElementById('topm-data-fim').value;
      if(!sVal || !eVal) return {start:null, end:null};
      let sDate = new Date(sVal);
      let eDate = new Date(eVal);
      // se usuário inverter datas, corrige automaticamente
      if(sDate > eDate){
        const tmp = sDate;
        sDate = eDate;
        eDate = tmp;
      }
      start = atStart(sDate);
      end   = atEnd(eDate);
      break;}

  }
  return {start, end};
}



// ================= HUB DE DADOS TOP MODELOS ================= //
function parseDateString(dataStr){
  if(!dataStr) return null;
  // formatos possíveis: dd/mm/yyyy, yyyy-mm-dd ou Date object
  if (dataStr instanceof Date) return dataStr;
  if (dataStr.includes('/')){
    const [d,m,y] = dataStr.split('/');
    return new Date(parseInt(y,10), parseInt(m,10)-1, parseInt(d,10));
  }
  return new Date(dataStr); // tenta ISO
}




function hubTopModelos(){
  let base = [];
  if (Array.isArray(window.historico) && window.historico.length){
    base = window.historico.slice();
  } else if (Array.isArray(window.historicoBaixas) && window.historicoBaixas.length){
    base = window.historicoBaixas.slice();
  } else {
    try{
      const ls = localStorage.getItem('historico');
      if(ls){ base = JSON.parse(ls); }
    }catch(e){ base = []; }
  }

  return base
    .filter(item => item && item.modelo && item.modelo.trim() !== '' &&
                    (!item.status || item.status.toUpperCase() !== 'BAD'))
    .map(item => {
      const parsed = parseDateString(item.data || item.dataBaixa || item.data_baixa);
      if (!parsed || isNaN(parsed)) return null;
      return {...item, _parsedDate: parsed};
    })
    .filter(Boolean);
}
function filtrarTopModelosPorPeriodo(key){
  const base = hubTopModelos();
  const {start,end} = periodDates(key);
  if(!start || !end){ alert('Defina as datas corretamente.'); return; }

  const lista = base.filter(h=> h._parsedDate >= start && h._parsedDate <= end);

  const map = {};
  lista.forEach(h=>{
    const label = normalizeModelo(h.modelo || '');
    map[label] = (map[label] || 0) + 1;
  });

  const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  renderTopModelosRanking(sorted);
  renderTopModelosChart(sorted);
}


function renderTopModelosRanking(arr){
  let html = '<table style="width:100%;"><thead><tr><th>#</th><th>Modelo</th><th>Qtd</th></tr></thead><tbody>';
  arr.forEach((item,idx)=>{
    html += `<tr><td>${idx+1}</td><td>${item[0]}</td><td>${item[1]}</td></tr>`;
  });
  html += '</tbody></table>';
  topModelosRankingDiv.innerHTML = html;
}



function renderTopModelosChart(arr){
  const labels = arr.map(i=>i[0]);
  const counts = arr.map(i=>i[1]);
  const total = counts.reduce((s,v)=>s+v,0);
  if(topModelosChart){ topModelosChart.destroy(); }
  const summaryDiv = document.getElementById('topm-summary');
  if(labels.length===0){
    topModelosRankingDiv.innerHTML = '<p style="text-align:center;">Nenhum dado no período selecionado.</p>';
    if(summaryDiv){ summaryDiv.innerHTML = ''; }
    return;
  }
  topModelosChart = new Chart(topModelosChartCanvas,{
    type:'pie',
    data:{
      labels,
      datasets:[{
        data:counts,
        backgroundColor: labels.map((_,i)=>`hsl(${Math.floor((360/labels.length)*i)},70%,60%)`)
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      aspectRatio:1,
      plugins:{
        tooltip:{ callbacks:{ 
          label:(ctx)=>{
            const val = ctx.parsed;
            const pct = ((val/total)*100).toFixed(1);
            return `${ctx.label}: ${val} (${pct}%)`;
          }
        }},
        legend:{ position:'bottom'}
      }
    }
  });

  // resumo textual
  if(summaryDiv){
    let html='';
    arr.forEach(([label,val])=>{
      const pct=((val/total)*100).toFixed(1);
      html += `<p><strong>${label}</strong>: ${val} (${pct}%)</p>`;
    });
    summaryDiv.innerHTML = html;
  }
}



});
</script>
</head>
<body>
  <!-- Botão para alternar entre modo claro e escuro -->
  <button id="toggle-dark-mode" style="position: fixed; bottom: 20px; left: 10px; opacity: 0.7; z-index: 100; padding: 4px 7px; font-size: 0.7rem;">
        Modo Escuro
  </button>


  <!-- NOVO BOTÃO para ocultar/exibir Ton na Mão -->
  <button id="toggle-ton-layout" style="position: fixed; bottom: 20px; left: 110px; opacity: 0.7; z-index: 100; padding: 4px 7px; font-size: 0.7rem;">
        Ocultar Ton na Mão
  </button>


  <!-- Título -->
  <h1 style="font-size:18px; text-align:center;">Gestão Integrada do Parceiro Ton</h1>


  <!-- CONTÊINER DE ACESSO: Cadastro Inicial e Login -->
  <div id="access-container">
        <!-- Cadastro Inicial -->
        <div id="firstAccessModal" class="card">
          <h2>Cadastro Inicial</h2>
          <form id="firstAccessForm">
            <label for="firstName">Nome:</label>
            <input type="text" id="firstName" required>
            <label for="firstEmail">E-mail:</label>
            <input type="email" id="firstEmail" required>
            <label for="firstPhone">Telefone:</label>
            <input type="tel" id="firstPhone" required>
            <button type="submit">Salvar Dados</button>
          </form>
        </div>


        <!-- Formulário de Login -->
        <form id="login-form" class="card hidden" autocomplete="off">
          <label for="username">Usuário:</label>
          <input type="text" id="username" required autocomplete="off" />
          <label for="password">Senha:</label>
          <input type="password" id="password" required autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" />
          <button type="submit">Login 👤</button>
          <div id="login-error" class="hidden"></div>
        </form>
  </div>


  <!-- (2) ÁREA PRINCIPAL (OCULTA ATÉ O LOGIN) -->
  <div id="app" class="hidden">
        <!-- Botão "Entrada de Máquininhas" -->
        <button id="toggle-cadastro-btn" type="button">Entrada de Máquininhas</button>


        <!-- Formulário de Cadastro -->
        <div id="cadastro-container" class="card hidden">
          <h2>Cadastrar Maquininha</h2>
          <form id="cadastro-form">
            <label>Tipo de Inclusão:</label><br />
            <input type="radio" name="tipo-inclusao" id="inclusao-unica" value="unica" checked> Única&nbsp;&nbsp;
            <input type="radio" name="tipo-inclusao" id="inclusao-lote" value="lote"> Em Lote<br /><br />


            <!-- Container para cadastro único -->
            <div id="unica-serial-container">
              <label>Serial:</label>
              <input type="text" id="serial" required /><br />
            </div>
            <!-- Container para cadastro em lote -->
            <div id="lote-serial-container" class="hidden">
              <label>Seriais (separe por vírgula):</label>
              <textarea id="serial-lote" rows="4" style="overflow-y: auto;" placeholder="Ex.: ABC123, DEF456, GHI789"></textarea><br />
            </div>


            <label>Modelo:</label>
            <select id="modelo" required></select><br />
            <label>Plano:</label>
            <select id="plano" required></select><br />
            <label>Categoria:</label>
            <select id="categoria" required>
              <option value="Pronta Entrega">Pronta Entrega</option>
              <option value="Ton Na Mão">Ton Na Mão</option>
            </select><br />
            <label>Cadastro (Exibição):</label>
            <select id="cadastro" required></select><br />
            <label>Data do Cadastro:</label>
            <input type="date" id="data" required /><br />
            <div id="grupo-custo-venda">
              <label>Valor de Custo:</label>
              <input type="number" step="0.01" id="custo" readonly /><br />
              <label>Valor de Venda:</label>
              <input type="number" step="0.01" id="venda" readonly /><br />
            </div>
            <label>Operadora do Chip:</label>
            <select id="chip-operadora" required>
              <option value="TIM">TIM</option>
              <option value="VIVO">VIVO</option>
              <option value="CLARO">CLARO</option>
            </select><br />
            <label>Local de Alocação (Loja):</label>
            <select id="alocacao" required></select><br />
            <label>Status:</label>
            <select id="status-maquina">
              <option value="GOOD">Good</option>
              <option value="BAD">Bad</option>
                  <option value="RESERVADO">Reservado</option>
            </select><br />
            <button id="cadastrar-btn" type="button">Cadastrar ✅</button>
          </form>
        </div>


        <!-- Listagem de Estoque -->
        <h2>Estoque (Listagem Agrupada)</h2>
        <!-- Tabela para Pronta Entrega -->
        <div class="category-header">
          <h3>Categoria: Pronta Entrega</h3>
          <button id="toggle-pronta" class="toggle-btn" type="button">[+]</button>
          <label>Filtrar Modelo:</label>
          <select id="filter-model-pronta"></select>
          <label>Tipo Cad.:</label>
          <select id="filter-tipo-cadastro-pronta">
            <option value="">[Todos]</option>
            <option value="CPF">CPF</option>
            <option value="CNPJ">CNPJ</option>
          </select>
          <label>Exibir somente BAD?</label>
          <input type="checkbox" id="filter-bad-pronta" />
          <label>Exibir somente RESERVADO?</label>
          <input type="checkbox" id="filter-reservado-pronta" />
        </div>
        <div id="pronta-entrega-container" class="card hidden">
          <div class="scroll-area">
            <table id="table-pronta">
              <thead>
                <tr>
                  <th>Serial</th>
                  <th>Modelo</th>
                  <th>Plano</th>
                  <th>Cadastro</th>
                  <th>Data</th>
                  <th>Custo</th>
                  <th>Venda</th>
                  <th>Chip</th>
                  <th>Alocação</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>


        <!-- Tabela para Ton Na Mão -->
        <div class="category-header">
          <h3>Categoria: Ton Na Mão</h3>
          <button id="toggle-ton" class="toggle-btn" type="button">[+]</button>
          <label>Filtrar Modelo:</label>
          <select id="filter-model-ton"></select>
          <label>Exibir somente BAD?</label>
          <input type="checkbox" id="filter-bad-ton" />
          <label>Exibir somente RESERVADO?</label>
          <input type="checkbox" id="filter-reservado-ton" />
        </div>
        <div id="ton-na-mao-container" class="card hidden">
          <div class="scroll-area">
            <table id="table-ton">
              <thead>
                <tr>
                  <th>Serial</th>
                  <th>Modelo</th>
                  <th>Plano</th>
                  <th>Cadastro</th>
                  <th>Data</th>
                  <th>Venda</th>
                  <th>Comissão</th>
                  <th>Chip</th>
                  <th>Alocação</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>


        <!-- Botões de Ação Principais -->
        <div class="action-buttons">
          <button id="ver-historico-btn" type="button">Ver Histórico de Baixas 📜</button>
          <button id="btn-baixar-item" type="button">Baixar Item ⬇️</button>
          <button id="btn-controle-chip" type="button">Controle de Chip 📱</button>
          <button id="btn-central-custo" type="button">Central de Custo 💰</button>
          <button id="btn-dashboard-consultor" type="button">Dashboard do Consultor 📊</button>
          <button id="btn-campeoes-mes" type="button">Campeões de Mês 🏆</button>
          <button id="btn-user-info" type="button">Usuário: ???</button>
          <button id="btn-acompanhar" type="button">Acompanhar ⚠️</button>
          <button id="btn-busca-serial" type="button">Busca Serial 🔍</button>
          <button id="btn-visualizar-concluidos" type="button">Visualizar Concluídos ✅</button>
        </div>


        <!-- Botões ADM -->
        <div class="btn-container" id="adm-container">
          <button id="btn-funcoes-adm" type="button">Funções Adm</button>
          <button id="btn-ads" type="button" class="hidden">ADS</button>
          <button id="btn-reservas" type="button" class="hidden">Reservas</button>
          <button id="btn-consultar-logs" type="button" class="hidden">Consultar Log</button>
          <button id="btn-central-cadastro" type="button" class="hidden">Central do Cadastro</button>
          <button id="btn-detalhes-lojas" type="button" class="hidden">Detalhes por Loja</button>
          <button id="btn-backup-dados" type="button" class="hidden">Backup Dados</button>
          <button id="btn-refresh" type="button" class="hidden">Refresh Dados</button>
          <button id="btn-top-modelos" type="button" class="hidden">Top Modelos</button>
        </div>


        <!-- Modal ADS -->
        <div id="modal-ads" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>ADS - Campanhas</h2>
            <label>Filtrar por Período:</label><br/>
            <!-- ORDEM: HOJE, ONTEM, ESTA SEMANA, SEMANA PASSADA, ESTE MÊS E FILTRO PERSONALIZADO -->
            <button id="ads-hoje" type="button" class="central-btn">Hoje</button>
            <button id="ads-ontem" type="button" class="central-btn">Ontem</button>
            <button id="ads-esta-semana" type="button" class="central-btn">Esta Semana</button>
            <button id="ads-semana-passada" type="button" class="central-btn">Semana Passada</button>
            <button id="ads-mes" type="button" class="central-btn">Este Mês</button>
            <button id="ads-personalizado" type="button" class="central-btn">Personalizado</button>


            <div id="ads-data-personalizada" class="hidden">
              <label>Data Início:</label>
              <input type="date" id="ads-data-inicio" />
              <label>Data Fim:</label>
              <input type="date" id="ads-data-fim" />
              <button id="ads-filtrar-personalizado" type="button" class="central-btn">Filtrar</button>
            </div>
            <br/>
            <label>Valor Investido na Campanha (R$):</label>
            <input type="number" step="0.01" id="ads-valor-investido" placeholder="Digite o valor" /><br/>
            <button id="ads-calcular" type="button" class="central-btn">Calcular CPL</button>
            <div id="ads-resultados" style="margin-top:10px;"></div>
            <!-- Exibição dos resultados das comissões -->
            <div id="ads-vendas-tnm" style="margin-top:10px;"></div>
            <div id="ads-vendas-tnm-org" style="margin-top:10px;"></div>
            <button id="fechar-modal-ads" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Campeões de Mês -->
        <div id="modal-campeoes-mes" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Campeões de Mês</h2>
            <div id="campeoes-filtros" style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
              <div>
                <label for="campeoes-mes">Mês:</label>
                <select id="campeoes-mes"></select>
              </div>
              <div>
                <label for="campeoes-ano">Ano:</label>
                <select id="campeoes-ano"></select>
              </div>
              <div>
                <button id="filtrar-campeoes-btn" type="button" class="central-btn">Filtrar</button>
              </div>
            </div>
            <div id="campeoes-ranking"></div>
            <button id="fechar-modal-campeoes" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Baixar Item -->
        <div id="modal-baixa" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Baixar Item</h2>
            <label>Tipo de Baixa:</label>
            <input type="radio" name="baixa-tipo" id="baixa-estoque" value="estoque" checked> Via Estoque
            <input type="radio" name="baixa-tipo" id="baixa-adlink" value="adlink"> Ad Link
            <input type="radio" name="baixa-tipo" id="baixa-devolucao-bad" value="devolucao_bad"> Devolução Bad
            <br/><br/>
            <div id="baixa-estoque-container">
              <label>Serial:</label>
              <input type="text" id="baixa-serial" /><br />
            </div>
            <div id="baixa-adlink-container" class="hidden">
              <label>Modelo:</label>
              <select id="baixa-modelo-adlink"></select><br />
              <label>Plano:</label>
              <select id="baixa-plano-adlink"></select><br />
            </div>
            <label>Nome do Cliente:</label>
            <input type="text" id="baixa-cliente" /><br />
            <label>Vendedor/Consultor:</label>
            <select id="baixa-consultor"></select><br />
            <button id="confirmar-baixa" type="button" class="central-btn">Confirmar Baixa</button>
            <button id="fechar-modal-baixa" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Histórico de Baixas -->
        <div id="modal-historico" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Histórico de Baixas</h2>
            <div style="margin-bottom:10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
              <div>
                <label>Filtrar Categoria:</label>
                <select id="filter-historico-categoria">
                  <option value="">[Todos]</option>
                  <option value="Pronta Entrega">Pronta Entrega</option>
                  <option value="Ton Na Mão">Ton Na Mão</option>
                </select>
              </div>
              <div>
                <label>Filtrar Cadastro:</label>
                <select id="filter-historico-cadastro">
                  <option value="">[Todos]</option>
                </select>
              </div>
              <div>
                <label>Filtrar Status:</label>
                <select id="filter-historico-status">
                  <option value="">[Todos]</option>
                  <option value="OK">OK</option>
                  <option value="BAD">BAD</option>
                </select>
              </div>
              <div>
                <label>Filtrar Data da Baixa:</label>
                <select id="filter-historico-data"></select>
              </div>
            </div>
            <div class="scroll-area">
              <table id="historico-table">
                <thead>
                  <tr>
                    <th>Serial</th>
                    <th>Data</th>
                    <th>Horário</th>
                    <th>Cliente</th>
                    <th>Categoria</th>
                    <th>Status</th>
                    <th>Cadastro</th>
                    <th>Modelo</th>
                    <th>Plano</th>
                    <th>Chip</th>
                    <th>Loja</th>
                    <th>Consultor</th>
                    <th>Comissão</th>
                    <th>ADS</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button id="fechar-modal-historico" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Controle de Chip -->
        <div id="modal-controle-chip" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Controle de Chip</h2>
            <h3>Resumo de Chips por Categoria (Contagem)</h3>
            <div class="scroll-area">
              <table>
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th>Quantidade</th>
                    <th>Última Atualização</th>
                  </tr>
                </thead>
                <tbody id="chips-pronta-table-body"></tbody>
              </table>
              <hr/>
              <table>
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th>Quantidade</th>
                    <th>Última Atualização</th>
                  </tr>
                </thead>
                <tbody id="chips-ton-table-body"></tbody>
              </table>
            </div>
            <hr/>
            <h3>Listagem Detalhada (Itens com Chip - PE)</h3>
            <div class="scroll-area">
              <table id="chips-detalhado-table">
                <thead>
                  <tr>
                    <th>Serial</th>
                    <th>Operadora</th>
                    <th>Categoria</th>
                    <th>Alocação</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button id="fechar-modal-controle-chip" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Central de Custo -->
        <div id="modal-central-custo" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Central de Custo</h2>
            <div id="modal-central-custo-content"></div>
          </div>
        </div>


        <!-- Modal Edição de Item -->
        <div id="modal-edicao" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Editar Item</h2>
            <label>Serial:</label>
            <input type="text" id="edit-serial" readonly /><br />
            <label>Modelo:</label>
            <select id="edit-modelo"></select><br />
            <label>Plano:</label>
            <select id="edit-plano"></select><br />
            <label>Categoria:</label>
            <select id="edit-categoria">
              <option value="Pronta Entrega">Pronta Entrega</option>
              <option value="Ton Na Mão">Ton Na Mão</option>
            </select><br />
            <label>Cadastro (Exibição):</label>
            <select id="edit-cadastro"></select><br />
            <label>Data do Cadastro:</label>
            <input type="date" id="edit-data" /><br />
            <div id="edit-grupo-custo-venda">
              <label>Valor de Custo:</label>
              <input type="number" step="0.01" id="edit-custo" readonly /><br />
              <label>Valor de Venda:</label>
              <input type="number" step="0.01" id="edit-venda" readonly /><br />
            </div>
            <label>Operadora do Chip:</label>
            <select id="edit-chip-operadora">
              <option value="TIM">TIM</option>
              <option value="VIVO">VIVO</option>
              <option value="CLARO">CLARO</option>
              <option value="SEM_CHIP">SEM CHIP</option>
            </select><br />
            <label>Local de Alocação (Loja):</label>
            <select id="edit-alocacao"></select><br />
            <label>Status:</label>
            <select id="edit-status-maquina">
              <option value="GOOD">Good</option>
              <option value="BAD">Bad</option>
                  <option value="RESERVADO">Reservado</option>
            </select><br />
            <label>Anotações:</label><br />
            <textarea id="edit-anotacoes" rows="4" cols="50"></textarea><br /><br />
            <label>ADS (Como o cliente chegou):</label>
            <select id="edit-ads">
              <option value="ORG">Orgânico (ORG)</option>
              <option value="TP">Tráfego Pago (TP)</option>
            </select><br /><br />
            <button id="confirmar-edicao" type="button" class="central-btn">Salvar</button>
            <button id="fechar-modal-edicao" type="button" class="central-btn fechar-btn">Cancelar</button>
          </div>
        </div>


        <!-- Modal Edição Histórico -->
        <div id="modal-editar-historico" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Editar Histórico de Baixa</h2>
            <form>
              <label>Serial:</label>
              <input type="text" id="edit-historico-serial" readonly /><br />
              <label>Data:</label>
              <input type="date" id="edit-historico-data" /><br />
              <label>Horário:</label>
              <input type="text" id="edit-historico-horario" /><br />
              <label>Cliente:</label>
              <input type="text" id="edit-historico-cliente" /><br />
              <label>Categoria:</label>
              <select id="edit-historico-categoria">
                <option value="Pronta Entrega">Pronta Entrega</option>
                <option value="Ton Na Mão">Ton Na Mão</option>
              </select><br />
              <label>Status:</label>
              <select id="edit-historico-status">
                <option value="OK">OK</option>
                <option value="BAD">BAD</option>
              </select><br />
              <label>Cadastro:</label>
              <select id="edit-historico-cadastro"></select><br />
              <label>Modelo:</label>
              <select id="edit-historico-modelo"></select><br />
              <label>Plano:</label>
              <select id="edit-historico-plano"></select><br />
              <label>Chip:</label>
              <input type="text" id="edit-historico-chip" /><br />
              <label>Loja:</label>
              <select id="edit-historico-loja"></select><br /><br />
              <label>Consultor:</label>
              <input type="text" id="edit-historico-consultor" readonly /><br />
              <label>Comissão (R$):</label>
              <input type="number" step="0.01" id="edit-historico-comissao" readonly /><br /><br />
              <label>ADS:</label>
              <select id="edit-historico-ads">
                <option value="ORG">Orgânico (ORG)</option>
                <option value="TP">Tráfego Pago (TP)</option>
              </select><br /><br />
              <button id="confirmar-editar-historico" type="button" class="central-btn">Salvar</button>
              <button id="cancelar-editar-historico" type="button" class="central-btn fechar-btn">Cancelar</button>
            </form>
          </div>
        </div>


        <!-- Modal Detalhes por Loja -->
        <div id="modal-detalhes-lojas" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Lojas – Resumo</h2>
            <div id="detalhes-lojas-content"></div>
            <button id="fechar-detalhes-lojas" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Backup -->
        <div id="modal-backup" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Backup de Dados</h2>
            <p>Para exportar, clique no botão abaixo.</p>
            <button id="backup-export-btn" type="button" class="central-btn">Exportar Backup</button>
            <hr />
            <p>Para importar, selecione o arquivo de backup JSON:</p>
            <input type="file" id="file-input-backup" accept=".json" /><br /><br/>
            <button id="fechar-modal-backup" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Central do Cadastro -->
        <div id="modal-usuario" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Central do Cadastro (Configurações)</h2>
            <div id="license-info" style="font-size:12px; margin-bottom:10px;"></div>
            <label>Nome do Usuário do Sistema:</label>
            <input type="text" id="system-username" readonly /><br /><br/>
            <hr />
            <p>Gerencie configurações avançadas:</p>
            <button id="abrir-modal-cadastros" type="button" class="central-btn">Gerenciar Cadastros</button>
            <button id="abrir-modal-planos" type="button" class="central-btn">Gerenciar Planos</button>
            <button id="abrir-modal-modelos" type="button" class="central-btn">Gerenciar Modelos</button>
            <button id="abrir-modal-lojas" type="button" class="central-btn">Gerenciar Lojas</button>
            <button id="abrir-modal-usuarios" type="button" class="central-btn">Gerenciar Usuários</button>
            <button id="abrir-modal-gerenciador-valores" type="button" class="central-btn">Gerenciar Valores</button>
            <button id="abrir-modal-consultores" type="button" class="central-btn">Gerenciar Consultores</button>
            <hr />
            <div id="cadastro-plugins">
              <button id="plugin-central-senhas" type="button" class="central-btn">Central de Senhas</button>
            </div>
            <hr />
            <button id="abrir-edicao-lote" type="button" class="central-btn">Editar Planos em Lote</button>
            <button id="abrir-edicao-lojas" type="button" class="central-btn">Editar Lojas em Lote</button>
            <button id="salvar-config" type="button" class="central-btn">Salvar Configurações</button>
            <button id="fechar-modal-usuario" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Gerenciar Cadastros -->
        <div id="modal-cadastros" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Cadastros</h2>
            <div id="lista-cadastros"></div>
            <input type="text" id="novo-cadastro" placeholder="Novo cadastro" />
            <button id="adicionar-cadastro" type="button" class="central-btn">Adicionar</button>
            <button id="fechar-modal-cadastros" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Gerenciar Planos -->
        <div id="modal-planos" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Planos</h2>
            <div id="lista-planos"></div>
            <input type="text" id="novo-plano" placeholder="Novo plano" />
            <button id="adicionar-plano" type="button" class="central-btn">Adicionar</button>
            <button id="fechar-modal-planos" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Gerenciar Modelos -->
        <div id="modal-modelos" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Modelos</h2>
            <div id="lista-modelos"></div>
            <input type="text" id="novo-modelo" placeholder="Novo modelo" />
            <button id="adicionar-modelo" type="button" class="central-btn">Adicionar</button>
            <button id="fechar-modal-modelos" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Gerenciar Lojas -->
        <div id="modal-lojas" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Lojas</h2>
            <div id="lista-lojas"></div>
            <input type="text" id="nova-loja" placeholder="Nova loja" />
            <button id="adicionar-loja" type="button" class="central-btn">Adicionar</button>
            <button id="fechar-modal-lojas" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Gerenciar Usuários -->
        <div id="modal-usuarios" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Usuários</h2>
            <div id="lista-usuarios"></div>
            <input type="text" id="novo-usuario" placeholder="Novo usuário" />
            <input type="password" id="nova-senha" placeholder="Senha" />
            <label>Permissão (1 = Admin, 2 = Restrito):</label>
            <select id="novo-usuario-nivel">
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
            <button id="adicionar-usuario" type="button" class="central-btn">Adicionar</button>
            <button id="fechar-modal-usuarios" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Gerenciar Consultores -->
        <div id="modal-consultores" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Consultores</h2>
            <div id="lista-consultores" class="scroll-area"></div>
            <input type="text" id="novo-consultor-nome" placeholder="Nome" />
            <input type="text" id="novo-consultor-loja" placeholder="Loja" />
            <input type="number" id="novo-consultor-comissao" placeholder="Comissão (%)" />
            <label>Tipo de bônus do mês:</label>
            <select id="novo-consultor-bonus">
              <option value="comum">COMUM (R$100)</option>
              <option value="upton">UPTON (R$150)</option>
              <option value="sem">SEM BONUS</option>
            </select>
            <button id="adicionar-consultor" type="button" class="central-btn">Adicionar Consultor</button>
          <label for="bonus-mode-select">Modo de Bônus:</label>
          <select id="bonus-mode-select" style="margin-left: 8px;">
            <option value="porConsultor">Por Consultor (atual)</option>
            <option value="global">Global (a cada 3 adesões no total)</option>
          </select>
          <button id="salvar-bonus-mode" type="button" class="central-btn">Salvar Modo de Bônus</button>
            <button id="fechar-modal-consultores" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Logs -->
        <div id="modal-logs" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Logs de Execução</h2>
            <div class="scroll-area" id="log-container-modal"></div>
            <button id="fechar-modal-logs" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Dashboard do Consultor -->
        
<div id="modal-dashboard-consultor" class="hidden">
  <div class="overlay"></div>
  <div class="modal">
    <label>Consultor:</label>
    <select id="dash-consultor-select">
      <option value="">Todos</option>
    </select><br/><br/>
    <table id="dash-tabela">
      <thead>
        <tr>
          <th>Data</th>
          <th>Cliente</th>
          <th>Consultor</th>
          <th>Valor da Venda</th>
          <th>Comissão</th>
          <th>Bônus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

<h3 id="dash-adesoes-tnm" style="display:none;">ADESÕES TNM: R$ 0,00</h3>
<h3 id="dash-adesoes-pe" style="display:none;">ADESÕES PE: R$ 0,00</h3>
<h3 id="dash-adesoes-adlink" style="display:none;">ADESÕES AD LINK: R$ 0,00</h3>


    <div id="comissao-tnm">COMISSÃO TNM: R$ 0,00</div>
  <div id="comissao-pe">COMISSÃO PE: R$ 0,00</div>
  <div id="comissao-adlink">COMISSÃO AD LINK: R$ 0,00</div>

  


  <h3 id="dash-total-comissao">Total de Comissão: R$ 0,00</h3>
    <h3 id="dash-total-bonus">Bônus do Consultor: R$ 0,00</h3>
    <h3 id="dash-total-bonus-loja">Bônus da Loja: R$ 0,00</h3>
    <h3 id="dash-soma-comissao-bonus-loja">Valor total = R$ 0,00</h3>

    <div id="dash-consultor-bonus-list">
    </div>
    <br/>

    <button id="dash-hoje-btn" type="button" class="central-btn">Hoje</button>
    <button id="dash-ontem-btn" type="button" class="central-btn">Ontem</button>
    <button id="dash-esta-semana-btn" type="button" class="central-btn">Esta Semana</button>
    <button id="dash-semana-passada-btn" type="button" class="central-btn">Semana Passada</button>
    <button id="dash-este-mes-btn" type="button" class="central-btn">Este Mês</button>
    <button id="dash-toggle-personalizado" type="button" class="central-btn">Filtro Personalizado</button>
    <div id="dash-data-personalizada">
      <br/>
      <label>Data Início:</label>
      <input type="date" id="dash-consultor-data-inicio" />
      <label>Data Fim:</label>
      <input type="date" id="dash-consultor-data-fim" /><br/><br/>
      <button id="dash-filtrar-btn" type="button" class="central-btn">Filtrar</button>
    </div>
    <button id="fechar-dashboard-consultor" type="button" class="central-btn fechar-btn">Fechar</button>
  </div>
</div>



        <!-- Modal Acompanhar Anotações -->
        <div id="modal-acompanhar" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Acompanhar Anotações ⚠️</h2>
            <div id="filtros-acompanhar" style="margin-bottom: 10px;">
              <label for="filtro-serial">Filtrar por Serial:</label>
              <input type="text" id="filtro-serial" placeholder="Digite o serial" style="margin-right: 10px;">
              <label for="filtro-categoria">Categoria:</label>
              <select id="filtro-categoria" style="margin-right: 10px;">
                <option value="">Todos</option>
                <option value="Pronta Entrega">Pronta Entrega</option>
                <option value="Ton Na Mão">Ton Na Mão</option>
              </select>
              <label for="filtro-cadastro">Cadastro:</label>
              <select id="filtro-cadastro">
                <option value="">Todos</option>
              </select>
              <button id="aplicar-filtros-acompanhar" type="button" class="central-btn">Filtrar</button>
            </div>
            <div id="acompanhar-lista" class="scroll-area"></div>
            <button id="fechar-modal-acompanhar" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Visualizar Concluídos -->
        <div id="modal-concluidos" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Itens Concluídos ✅</h2>
            <div id="lista-concluidos" class="scroll-area"></div>
            <button id="fechar-modal-concluidos" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Central de Senhas -->
        <div id="modal-central-senhas" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Central de Senhas</h2>
            <form id="senha-form">
              <fieldset>
                <legend>Senha de Login</legend>
                <label>Alterar senha de login?</label>
                <select id="alterar-login">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
                <div id="senha-login-div" class="hidden">
                  <label>Insira a senha atual:</label>
                  <input type="password" id="senha-login-atual">
                  <label>Nova senha:</label>
                  <input type="password" id="senha-login-nova">
                  <label>Confirmar nova senha:</label>
                  <input type="password" id="senha-login-confirmar">
                </div>
              </fieldset>
              <fieldset>
                <legend>Senha de Backup</legend>
                <label>Nova senha de backup:</label>
                <input type="password" id="senha-backup-nova">
                <label>Confirmar nova senha de backup:</label>
                <input type="password" id="senha-backup-confirmar">
              </fieldset>
              <fieldset>
                <legend>Senha Central de Custo</legend>
                <label>Nova senha da Central de Custo:</label>
                <input type="password" id="senha-central-nova">
                <label>Confirmar nova senha da Central de Custo:</label>
                <input type="password" id="senha-central-confirmar">
              </fieldset>
              <button id="salvar-senhas" type="button" class="central-btn">Salvar Senhas</button>
              <button id="btn-reset-dados" type="button" class="central-btn">Resetar Dados do Sistema</button>
              <button id="fechar-modal-central-senhas" type="button" class="central-btn fechar-btn">Fechar</button>
            </form>
          </div>
        </div>


        <!-- Modal Edição em Lote de Planos -->
        <div id="modal-edicao-lote" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Edição em Lote de Planos</h2>
            <label for="novo-plano-lote">Novo Plano:</label>
            <select id="novo-plano-lote"></select>
            <div id="grupo-edicao-lote-container">
              <table id="tabela-edicao-lote">
                <thead>
                  <tr>
                    <th>Modelo</th>
                    <th>Plano Atual</th>
                    <th>Categoria</th>
                    <th>Cadastro</th>
                    <th>Quantidade</th>
                    <th>Ação</th>
                  </tr>
                </thead>
                <tbody id="grupo-edicao-lote"></tbody>
              </table>
            </div>
            <button id="fechar-modal-edicao-lote" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Reserva -->
  <div id="modal-reserva" class="hidden">
        <div class="overlay"></div>
        <div class="modal">
          <h2>Itens Reservados</h2>
          <div id="lista-reservas" class="scroll-area"></div>
          <button id="fechar-modal-reserva" type="button" class="central-btn fechar-btn">Fechar</button>
        </div>
  </div>


  <!-- Modal Edição em Lote de Lojas -->
        <div id="modal-edicao-lojas" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Edição em Lote de Lojas</h2>
            <label for="nova-loja-lote">Nova Loja:</label>
            <select id="nova-loja-lote"></select>
            <div id="grupo-edicao-lojas-container">
              <table id="tabela-edicao-lojas">
                <thead>
                  <tr>
                    <th>Loja Atual</th>
                    <th>Quantidade</th>
                    <th>Ação</th>
                  </tr>
                </thead>
                <tbody id="grupo-edicao-lojas"></tbody>
              </table>
            </div>
            <button id="fechar-modal-edicao-lojas" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- Modal Busca Serial -->
        <div id="modal-busca-serial" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Busca Rápida de Serial 🔍</h2>
            <label for="busca-serial-input">Digite o Serial:</label>
            <input type="text" id="busca-serial-input" />
            <button id="buscar-serial-btn" type="button" class="central-btn">Buscar</button>
            <div id="resultado-busca-serial" style="margin-top:10px;"></div>
            <button id="fechar-modal-busca-serial" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>
<!-- Modal Top Modelos -->
<div id="modal-top-modelos" class="hidden">
  <div class="overlay"></div>
  <div class="modal">
    <h2>Top Modelos</h2>
    <div id="top-modelos-filtros" style="margin-bottom:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <button id="topm-hoje" type="button" class="central-btn">Hoje</button>
      <button id="topm-ontem" type="button" class="central-btn">Ontem</button>
      <button id="topm-esta-semana" type="button" class="central-btn">Esta Semana</button>
      <button id="topm-semana-passada" type="button" class="central-btn">Semana Passada</button>
      <button id="topm-este-mes" type="button" class="central-btn">Este Mês</button>
      <button id="topm-personalizado" type="button" class="central-btn">Personalizado</button>
      <div id="topm-data-personalizada" class="hidden">
        <label>Data Início:</label>
        <input type="date" id="topm-data-inicio" />
        <label>Data Fim:</label>
        <input type="date" id="topm-data-fim" />
        <button id="topm-filtrar-personalizado" type="button" class="central-btn">Filtrar</button>
      </div>
    </div>
    <h3>Ranking de Modelos (Repasse)</h3>
    <div id="topm-ranking" class="scroll-area" style="max-height:200px;"></div>
    
<div id="topm-visual" class="topm-visual">
  <canvas id="topm-chart" width="280" height="280"></canvas>
  <div id="topm-summary"></div>
</div>

    <button id="fechar-modal-top-modelos" type="button" class="central-btn fechar-btn">Fechar</button>
  </div>
</div>


        <!-- ================= Modais Customizados: Alert, Confirm e Prompt ================= -->
        <!-- Modal Alert -->
        <div id="modal-alert" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Alerta</h2>
            <div id="modal-alert-message"></div>
            <button id="modal-alert-close" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>
        <!-- Modal Confirm -->
        <div id="modal-confirm" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Confirmação</h2>
            <div id="modal-confirm-message"></div>
            <div class="modal-confirm-buttons">
              <button id="modal-confirm-yes" type="button" class="central-btn modal-btn-small">Sim</button>
              <button id="modal-confirm-no" type="button" class="central-btn modal-btn-small fechar-btn">Não</button>
            </div>
          </div>
        </div>
        <!-- Modal Prompt -->
        <div id="modal-prompt" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Entrada</h2>
            <div id="modal-prompt-message"></div>
            <input type="password" id="modal-prompt-input" />
            <textarea id="modal-prompt-textarea" class="hidden" style="width:90%; height:150px; overflow-y:auto;"></textarea>
            <button id="toggle-prompt-password" class="toggle-password" type="button"></button>
            <div class="modal-buttons">
              <button id="modal-prompt-ok" type="button" class="central-btn modal-btn-small">Confirmar</button>
              <button id="modal-prompt-cancel" type="button" class="central-btn modal-btn-small fechar-btn">Cancelar</button>
            </div>
          </div>
        </div>


        <!-- ================= MODAL GERENCIADOR DE VALORES ================= -->
        <div id="modal-gerenciador-valores" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Gerenciar Valores</h2>


            <!-- NOVO SELECT PARA ESCOLHER O NÍVEL DO CONSULTOR (INICIANTES, ESPECIALISTA I, ETC.) -->
            <div style="margin-bottom:10px;">
              <label for="consultor-level-select"><strong>Nível do Consultor:</strong></label>
              <select id="consultor-level-select" style="min-width:200px;">
                <option value="">[Selecionar Nível]</option>
                <option value="Iniciantes">Iniciantes</option>
                <option value="Especialista I">Especialista I</option>
                <option value="Especialista II e III">Especialista II e III</option>
                <option value="Referência e Embaixador">Referência e Embaixador</option>
              </select>
            </div>


            <div id="tabela-gerenciador-valores"></div>


            <button id="copiar-gerenciador-valores" type="button" class="central-btn">Copiar Valores</button>
            <button id="colar-gerenciador-valores" type="button" class="central-btn">Colar Valores</button>
            <button id="salvar-gerenciador-valores" type="button" class="central-btn">Salvar Valores</button>
            <button id="fechar-modal-gerenciador-valores" type="button" class="central-btn fechar-btn">Fechar</button>
          </div>
        </div>


        <!-- NOVO MODAL PARA EDIÇÃO DE QUANTIDADE NO CONTROLE DE CHIP -->
        <div id="modal-editar-chip" class="hidden">
          <div class="overlay"></div>
          <div class="modal">
            <h2>Editar Quantidade de Chips</h2>
            <label>Quantidade:</label>
            <input type="number" id="chip-edit-quantity" />
            <button id="chip-edit-confirm" type="button" class="central-btn">Salvar</button>
            <button id="chip-edit-cancel" type="button" class="central-btn fechar-btn">Cancelar</button>
          </div>
        </div>
  </div>


  <script>
        // Função para normalizar o valor do campo "modelo"
        function normalizeModelo(modelo) {
          return modelo.replace(/[\s\W_]+/g, "").toUpperCase();
        }


        // Função para alternar visibilidade do dropdown (usada em “Mais”)
        function toggleActions(btn) {
          const dropdown = btn.nextElementSibling;
          if(dropdown.classList.contains('visible')){
            dropdown.classList.remove('visible');
          } else {
            dropdown.classList.add('visible');
          }
        }


        let loggedInUser = null; // Declaração global para controle ADM


        // Ícones SVG para toggle de senha
        const iconEyeOpen = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zm0 13c-3.04 0-5.5-2.46-5.5-5.5S8.96 6.5 12 6.5 17.5 8.96 17.5 12 15.04 17.5 12 17.5zM12 8.5c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5S13.93 8.5 12 8.5z"/>
        </svg>`;
        const iconEyeClosed = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 6.5c-2.76 0-5.26 1.12-7.07 2.93l1.41 1.41C7.29 9.17 9.52 8 12 8c2.48 0 4.71 1.17 5.66 2.91l1.41-1.41C17.26 7.62 14.76 6.5 12 6.5z"/>
        </svg>`;


        function adicionarToggleSenha(){
          const passwordFields = document.querySelectorAll("input[type='password']");
          passwordFields.forEach(input => {
            if(input.dataset.toggleAdded) return;
            if(input.id === "modal-prompt-input"){
              input.dataset.toggleAdded = "true";
              return;
            }
            if(input.parentNode.querySelector('.toggle-password')){
              input.dataset.toggleAdded = "true";
              return;
            }
            const btn = document.createElement("button");
            btn.type = "button";
            btn.innerHTML = iconEyeOpen;
            btn.classList.add("toggle-password");
            btn.addEventListener("click", function(){
              if(input.type === "password"){
                input.type = "text";
                btn.innerHTML = iconEyeClosed;
              } else {
                input.type = "password";
                btn.innerHTML = iconEyeOpen;
              }
            });
            input.parentNode.insertBefore(btn, input.nextSibling);
            input.dataset.toggleAdded = "true";
          });
        }


        window.showSelectPrompt = function(message, optionsArray, defaultValue, callback) {
          let modal = document.getElementById('modal-select-prompt');
          if(!modal) {
            modal = document.createElement('div');
            modal.id = 'modal-select-prompt';
            modal.className = 'hidden';
            modal.innerHTML = `
              <div class="overlay"></div>
              <div class="modal">
                <h2>Entrada</h2>
                <div id="modal-select-prompt-message"></div>
                <select id="modal-select-prompt-select"></select>
                <div class="modal-buttons">
                  <button id="modal-select-prompt-ok" type="button" class="central-btn modal-btn-small">Confirmar</button>
                  <button id="modal-select-prompt-cancel" type="button" class="central-btn modal-btn-small fechar-btn">Cancelar</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
          }
          document.getElementById('modal-select-prompt-message').textContent = message;
          const selectElem = document.getElementById('modal-select-prompt-select');
          selectElem.innerHTML = "";
          optionsArray.forEach(opt => {
            const optionElem = document.createElement('option');
            optionElem.value = opt.value;
            optionElem.textContent = opt.text;
            selectElem.appendChild(optionElem);
          });
          selectElem.value = defaultValue;
          modal.classList.remove('hidden');
          document.getElementById('modal-select-prompt-ok').onclick = function() {
            modal.classList.add('hidden');
            callback(selectElem.value);
          };
          document.getElementById('modal-select-prompt-cancel').onclick = function(){
            modal.classList.add('hidden');
            callback(null);
          };
        };


        function preencherFiltroHistoricoData() {
          const select = document.getElementById('filter-historico-data');
          select.innerHTML = "";
          const now = new Date();
          for(let i = 0; i < 12; i++){
            let date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            let month = date.getMonth() + 1;
            let year = date.getFullYear();
            let monthStr = month < 10 ? "0" + month : month;
            let optionText = monthStr + "/" + year;
            let option = document.createElement("option");
            option.value = optionText;
            option.textContent = optionText;
            select.appendChild(option);
          }
          select.value = (now.getMonth()+1 < 10 ? "0" + (now.getMonth()+1) : now.getMonth()+1) + "/" + now.getFullYear();
        }


        // Função auxiliar para converter uma data ISO (yyyy-mm-dd) para o formato dd/mm/yyyy
        function formatDateBRFromISO(isoStr) {
          if(!isoStr) return "";
          const parts = isoStr.split("-");
          if(parts.length !== 3) return isoStr;
          return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }


        window.showPrompt = function(message, defaultValue, callback, useTextarea) {
          const modal = document.getElementById('modal-prompt');
          const messageDiv = document.getElementById('modal-prompt-message');
          messageDiv.textContent = message;
          if(useTextarea) {
            document.getElementById('modal-prompt-input').classList.add('hidden');
            document.getElementById('toggle-prompt-password').classList.add('hidden');
            const textarea = document.getElementById('modal-prompt-textarea');
            textarea.classList.remove('hidden');
            textarea.value = defaultValue || "";
            modal.classList.remove('hidden');
            document.getElementById('modal-prompt-ok').onclick = function(){
              modal.classList.add('hidden');
              callback(textarea.value);
            };
            document.getElementById('modal-prompt-cancel').onclick = function(){
              modal.classList.add('hidden');
              callback(null);
            };
          } else {
            document.getElementById('modal-prompt-input').classList.remove('hidden');
            document.getElementById('toggle-prompt-password').classList.remove('hidden');
            document.getElementById('modal-prompt-textarea').classList.add('hidden');
            const input = document.getElementById('modal-prompt-input');
            input.value = defaultValue || "";
            modal.classList.remove('hidden');
            document.getElementById('modal-prompt-ok').onclick = function(){
              modal.classList.add('hidden');
              callback(input.value);
            };
            document.getElementById('modal-prompt-cancel').onclick = function(){
              modal.classList.add('hidden');
              callback(null);
            };
          }
        };


        // ================= Variáveis Globais =================


        let estoque = [];
        let historico = [];
        let chipsCount = {};
        let chipsDateLastUpdate = {};
        let systemConfig = {};
        let valores = {};

        function corrigirValoresEstoque(){
          let atualizado = false;
          if(Array.isArray(estoque)){
            estoque.forEach(item => {
              if(item && item.plano === 'PJ MEI'){
                if(item.modelo === 'T3 SMART' && Number(item.venda) !== 171.00){
                  item.venda = 171.00;
                  atualizado = true;
                } else if(item.modelo === 'T3' && Number(item.venda) !== 160.92){
                  item.venda = 160.92;
                  atualizado = true;
                }
              }
            });
          }
          return atualizado;
        }


        document.addEventListener("DOMContentLoaded", function(){


const btnReservas = document.getElementById('btn-reservas');
btnReservas.addEventListener('click', ()=>{
  atualizarModalReservas();
  document.getElementById('modal-reserva').classList.remove('hidden');
});
document.getElementById('fechar-modal-reserva').addEventListener('click', ()=>{
  document.getElementById('modal-reserva').classList.add('hidden');
});


        document.getElementById("salvar-bonus-mode").addEventListener("click", () => {
          const bonusModeSelect = document.getElementById("bonus-mode-select");
          systemConfig.bonusMode = bonusModeSelect.value;
          localStorage.setItem("systemConfig", JSON.stringify(systemConfig));
          showAlert("Modo de Bônus atualizado para: " + systemConfig.bonusMode);
        });


        if (document.getElementById("bonus-mode-select")) {
          document.getElementById("bonus-mode-select").value = systemConfig.bonusMode;
        }
          adicionarToggleSenha();
          const btnTogglePrompt = document.getElementById('toggle-prompt-password');
          btnTogglePrompt.innerHTML = iconEyeOpen;
          btnTogglePrompt.addEventListener('click', function(){
            const input = document.getElementById('modal-prompt-input');
            if(input.type === "password"){
              input.type = "text";
              btnTogglePrompt.innerHTML = iconEyeClosed;
            } else {
              input.type = "password";
              btnTogglePrompt.innerHTML = iconEyeOpen;
            }
          });


          // Alternar entre Inclusão Única e Em Lote
          const radioUnica = document.getElementById('inclusao-unica');
          const radioLote = document.getElementById('inclusao-lote');
          const containerUnica = document.getElementById('unica-serial-container');
          const containerLote = document.getElementById('lote-serial-container');


          radioUnica.addEventListener('change', function() {
            if (this.checked) {
              containerUnica.classList.remove('hidden');
              containerLote.classList.add('hidden');
            }
          });
          radioLote.addEventListener('change', function() {
            if (this.checked) {
              containerUnica.classList.add('hidden');
              containerLote.classList.remove('hidden');
            }
          });




          // Carregar/inicializar do localStorage
          estoque = JSON.parse(localStorage.getItem('estoque')) || [];
          historico = JSON.parse(localStorage.getItem('historico')) || [];
          chipsCount = JSON.parse(localStorage.getItem('chipsCount')) || {};
          chipsDateLastUpdate = JSON.parse(localStorage.getItem('chipsDateLastUpdate')) || {};
          systemConfig = JSON.parse(localStorage.getItem('systemConfig')) || {};
        if (!systemConfig.bonusMode) {
          systemConfig.bonusMode = "porConsultor";
        }
          valores = JSON.parse(localStorage.getItem('valores')) || {};


          // Se itens já baixados estiverem no estoque, removê-los
          estoque = estoque.filter(item => !historico.some(h => h.serial === item.serial));
          corrigirValoresEstoque();


          // Garante consultores
          if(!systemConfig.consultores){ systemConfig.consultores = []; }
          if(systemConfig.consultores.length === 0){
            systemConfig.consultores.push({name:"Leandro", loja:"Loja A", comissao:10, bonusType:"comum"});
          }
          // Garante username e senhas mínimas
          if(!systemConfig.username){ systemConfig.username = "sistema"; }
          if(!systemConfig.password){ systemConfig.password = "12345"; }
          if(!systemConfig.backupPassword){ systemConfig.backupPassword = "0"; }
          if(!systemConfig.centralCustoPassword){ systemConfig.centralCustoPassword = "0"; }


          // Exclusão de "TON ULTRA" e definição de planos permitidos
          systemConfig.planos = ["Super","Mega","Pro","Ton Pro MEI e PJ","Turbo"];


          // Garante cadastros, modelos
          if(!systemConfig.cadastros){ systemConfig.cadastros = ["CPF LEANDRO","CNPJ ANARTHISAND"]; }
          if(!systemConfig.modelos){ systemConfig.modelos = ["T1","T2","T3 SMART"]; }


          // Garante usuários
          if(!systemConfig.users || systemConfig.users.length === 0) {
            systemConfig.users = [{
              name: "sistema",
              password: "12345",
              createDate: new Date().toLocaleDateString(),
              nivel: 1
            }];
          } else {
            let sistemaUser = systemConfig.users.find(u => u.name.toLowerCase() === "sistema");
            if(sistemaUser) {
              sistemaUser.nivel = 1;
              sistemaUser.password = "12345";
            } else {
              systemConfig.users.push({
                name: "sistema",
                password: "12345",
                createDate: new Date().toLocaleDateString(),
                nivel: 1
              });
            }
            systemConfig.users = systemConfig.users.map(u => {
              if(u.nivel === undefined) {
                u.nivel = 2;
              }
              return u;
            });
          }


          // Se 'alocacoes' não existir, criamos um array vazio.
          if(!systemConfig.alocacoes){
            systemConfig.alocacoes = [];
          }


          // Garante chips
          if(!chipsCount["Ton Na Mão"]){
            chipsCount["Ton Na Mão"] = { TIM: 0, VIVO: 0, CLARO: 0, SEM_CHIP: 0 };
          }
          if(!chipsCount["Pronta Entrega"]){
            chipsCount["Pronta Entrega"] = { TIM: 0, VIVO: 0, CLARO: 0, SEM_CHIP: 0 };
          }
          if(!chipsDateLastUpdate["Ton Na Mão"]){
            chipsDateLastUpdate["Ton Na Mão"] = { TIM: null, VIVO: null, CLARO: null, SEM_CHIP: null };
          }
          if(!chipsDateLastUpdate["Pronta Entrega"]){
            chipsDateLastUpdate["Pronta Entrega"] = { TIM: null, VIVO: null, CLARO: null, SEM_CHIP: null };
          }


          // === AQUI ADICIONAMOS OS VALORES PADRÕES PARA PRONTA ENTREGA (Custo=Compra de estoque, Venda=Repasse mínimo) ===
          // Caso o "valores" do localStorage não possua essas combinações, iremos criá-las
          const defaultProntaEntrega = {
            "Super": {
              "T1": { custo:12.00,   venda:16.80 },
              "T2": { custo:49.00,   venda:59.40 },
              "T3": { custo:89.00,   venda:106.92 },
              "T3 SMART": { custo:104.00,  venda:125.28 }
            },
            "Mega": {
              "T1": { custo:11.00,   venda:20.52 },
              "T2": { custo:34.00,   venda:62.64 },
              "T3": { custo:77.00,   venda:139.32 },
              "T3 SMART": { custo:89.00,   venda:160.92 }
            },
            "Turbo": {
              "T1": { custo:6.00,        venda:35.64 },
              "T2": { custo:11.00,   venda:66.96 },
              "T3": { custo:28.00,   venda:189.00 },
              "T3 SMART": { custo:34.00,   venda:220.32 }
            },
            "Ton Pro MEI e PJ": {
              "T3": { custo:28.00,   venda:160.92 },
              "T3 SMART": { custo:34.00,  venda:171.00 }
            }
          };


          // Injetar caso não exista no objeto "valores"
          Object.keys(defaultProntaEntrega).forEach(plano => {
            Object.keys(defaultProntaEntrega[plano]).forEach(modelo => {
              if(!valores[modelo]) valores[modelo] = {};
              if(!valores[modelo][plano]){
                valores[modelo][plano] = {
                  custo: defaultProntaEntrega[plano][modelo].custo,
                  venda: defaultProntaEntrega[plano][modelo].venda,
                  tnmComissao: 0 // default 0
                };
              }
            });
          });


          // Salvar de volta no localStorage
          localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
          localStorage.setItem('estoque', JSON.stringify(estoque));
          localStorage.setItem('historico', JSON.stringify(historico));
          localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
          localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
          localStorage.setItem('valores', JSON.stringify(valores));


          let ordemExec = 0;
          const logsExecucao = [];
          function registrarLog(acao, detalhes=""){
            ordemExec++;
            const user = systemConfig.username || "Desconhecido";
            const msg = `[${ordemExec}] Usuário: ${user} | Ação: ${acao} | Detalhes: ${detalhes}`;
            console.log(msg);
            logsExecucao.push(msg);
          }
          function atualizarLogs(){
            const logContainer = document.getElementById('log-container-modal');
            logContainer.innerHTML = "";
            logsExecucao.forEach(msg => {
              const p = document.createElement('p');
              p.textContent = msg;
              logContainer.appendChild(p);
            });
          }
          function parseDateBR(dateStr) {
            const parts = dateStr.split('/');
            if(parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            return new Date(year, month - 1, day);
          }
          function formatDateBR(dateStr) {
            if (!dateStr) return "";
            if(dateStr.includes("-")){
              let parts = dateStr.split("-");
              if(parts.length === 3){
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
              }
            }
            return dateStr;
          }


          const cadastroKey = 'usuarioCadastro';
          const firstAccessForm = document.getElementById('firstAccessForm');
          const firstAccessModal = document.getElementById('firstAccessModal');
          const loginForm = document.getElementById('login-form');
          const app = document.getElementById('app');

          const savedCadastro = localStorage.getItem(cadastroKey);

          if(savedCadastro){
            firstAccessModal.classList.add('hidden');
            loginForm.classList.remove('hidden');
          } else {
            loginForm.classList.add('hidden');
            app.classList.add('hidden');
          }

          if(firstAccessForm){
            firstAccessForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const data = {
                nome: document.getElementById('firstName').value.trim(),
                email: document.getElementById('firstEmail').value.trim(),
                telefone: document.getElementById('firstPhone').value.trim()
              };
              localStorage.setItem(cadastroKey, JSON.stringify(data));
              firstAccessModal.classList.add('hidden');
              loginForm.classList.remove('hidden');
            });
          }


          // =========== LOGIN ============
          let adminMenuOpen = false;
          loginForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            const usernameVal = document.getElementById('username').value.trim();
            const passVal = document.getElementById('password').value;
            const userFound = systemConfig.users.find(u => u.name.toLowerCase() === usernameVal.toLowerCase());
            if(userFound && userFound.password === passVal){
              const loginError = document.getElementById('login-error');
              loginError.classList.add('hidden');
              loginError.textContent = "";
              systemConfig.username = userFound.name;
              loggedInUser = userFound;
              registrarLog("Login", `Usuário ${userFound.name} logado (Nível ${userFound.nivel})`);
              loginForm.classList.add('hidden');
              app.classList.remove('hidden');
              document.getElementById('btn-user-info').textContent = `Usuário: ${systemConfig.username}`;
              inicializarCombos();
              popularModelFilters();
              registrarLog("Inicialização", "Dados carregados");
              const storedUserData = localStorage.getItem('usuarioCadastro');
              if(storedUserData){
                const uData = JSON.parse(storedUserData);
                const licenseText = `ESTE PROGRAMA ESTÁ LICENCIADO PARA ${uData.nome} (${uData.email}, ${uData.telefone})`;
                document.getElementById('license-info').textContent = licenseText;
              }
              if(loggedInUser.nivel === 1){
                document.getElementById('btn-ads').classList.remove('hidden');
              }
            } else {
              const loginError = document.getElementById('login-error');
              loginError.textContent = "Usuário/senha incorretos!";
              loginError.style.color = "red";
              loginError.classList.remove('hidden');
            }
          });
          const btnUserInfo = document.getElementById('btn-user-info');
          btnUserInfo.addEventListener('click', ()=>{
            showConfirm("Deseja fazer logout?", function(confirmado){
              if(confirmado){
                app.classList.add('hidden');
                loginForm.reset();
                loginForm.classList.remove('hidden');
                registrarLog("Logout", `Usuário ${systemConfig.username} fez logout`);
                btnUserInfo.textContent = "Usuário: ???";
              }
            });
          });


          // =========== FUNÇÕES ADM ============
          const btnFuncoesAdm = document.getElementById('btn-funcoes-adm');
          btnFuncoesAdm.addEventListener('click', (e)=>{
            e.stopPropagation();
            if(loggedInUser && loggedInUser.nivel !== 1){
              showAlert("Você não tem permissão de acesso.");
              return;
            }
            adminMenuOpen = !adminMenuOpen;
            const adminBtns = document.querySelectorAll('.btn-container button:not(#btn-funcoes-adm)');
            adminBtns.forEach(b=>{
              if(adminMenuOpen) b.classList.remove('hidden');
              else b.classList.add('hidden');
            });
          });
          document.addEventListener('click', (e)=>{
            if(adminMenuOpen && !e.target.closest('#adm-container')){
              const adminBtns = document.querySelectorAll('.btn-container button:not(#btn-funcoes-adm)');
              adminBtns.forEach(b=>b.classList.add('hidden'));
              adminMenuOpen = false;
            }
          });


          const btnRefresh = document.getElementById('btn-refresh');
          btnRefresh.addEventListener('click', ()=>{
            inicializarCombos();
            popularModelFilters();
            registrarLog("Refresh", "Dados atualizados sem recarregar a página");
          });


          function preencherCombosCadastro(){
            const sel = document.getElementById('cadastro');
            sel.innerHTML = "";
            systemConfig.cadastros.forEach(cad=>{
              let o = document.createElement('option');
              o.value = cad; o.textContent = cad;
              sel.appendChild(o);
            });
          }
          function preencherCombosAlocacao(){
            const sel = document.getElementById('alocacao');
            sel.innerHTML = "";
            systemConfig.alocacoes.forEach(a=>{
              let o = document.createElement('option');
              o.value = a; o.textContent = a;
              sel.appendChild(o);
            });
          }
          function preencherCombosModelos(){
            const sel = document.getElementById('modelo');
            sel.innerHTML = "";
            systemConfig.modelos.forEach(m=>{
              let o = document.createElement('option');
              o.value = m; o.textContent = m;
              sel.appendChild(o);
            });
          }
          function preencherCombosPlanos(){
            const sel = document.getElementById('plano');
            sel.innerHTML = "";
            systemConfig.planos.forEach(p=>{
              let o = document.createElement('option');
              o.value = p; o.textContent = p;
              sel.appendChild(o);
            });
          }
          function preencherCombosEdicao(){
            const selCad = document.getElementById('edit-cadastro');
            selCad.innerHTML = "";
            systemConfig.cadastros.forEach(c=>{
              let o = document.createElement('option');
              o.value = c; o.textContent = c;
              selCad.appendChild(o);
            });
            const selAloc = document.getElementById('edit-alocacao');
            selAloc.innerHTML = "";
            systemConfig.alocacoes.forEach(a=>{
              let o = document.createElement('option');
              o.value = a; o.textContent = a;
              selAloc.appendChild(o);
            });
            const selModelo = document.getElementById('edit-modelo');
            selModelo.innerHTML = "";
            systemConfig.modelos.forEach(m=>{
              let o = document.createElement('option');
              o.value = m; o.textContent = m;
              selModelo.appendChild(o);
            });
            const selPlano = document.getElementById('edit-plano');
            selPlano.innerHTML = "";
            systemConfig.planos.forEach(p=>{
              let o = document.createElement('option');
              o.value = p; o.textContent = p;
              selPlano.appendChild(o);
            });
          }
          function inicializarCombos(){
            preencherCombosCadastro();
            preencherCombosAlocacao();
            preencherCombosModelos();
            preencherCombosPlanos();
            preencherCombosEdicao();
          }


          const toggleCadastroBtn = document.getElementById('toggle-cadastro-btn');
          const cadastroContainer = document.getElementById('cadastro-container');
          toggleCadastroBtn.addEventListener('click', ()=>{
            if(cadastroContainer.classList.contains('hidden')){
              cadastroContainer.classList.remove('hidden');
              toggleCadastroBtn.style.backgroundColor = "red";
              toggleCadastroBtn.textContent = "Ocultar";
            } else {
              cadastroContainer.classList.add('hidden');
              toggleCadastroBtn.style.backgroundColor = "green";
              toggleCadastroBtn.textContent = "Entrada de Máquininhas";
            }
          });


          const categoriaSelect = document.getElementById('categoria');
          const grupoCustoVenda = document.getElementById('grupo-custo-venda');
          categoriaSelect.addEventListener('change', ()=>{
            if(categoriaSelect.value === "Ton Na Mão"){
              grupoCustoVenda.style.display = "none";
            } else {
              grupoCustoVenda.style.display = "block";
              const selModel = document.getElementById('modelo').value;
              const selPlano = document.getElementById('plano').value;
              if(valores[selModel] && valores[selModel][selPlano]){
                document.getElementById('custo').value = valores[selModel][selPlano].custo || "";
                document.getElementById('venda').value = valores[selModel][selPlano].venda || "";
              }
            }
          });
          function atualizarValorVenda(){
            const modeloSel = document.getElementById('modelo').value;
            const planoSel = document.getElementById('plano').value;
            if((planoSel === 'PJ MEI' || planoSel === 'Ton Pro MEI e PJ') && modeloSel === 'T3 SMART'){
              document.getElementById('venda').value = '171.00';
            } else if((planoSel === 'PJ MEI' || planoSel === 'Ton Pro MEI e PJ') && modeloSel === 'T3'){
              document.getElementById('venda').value = '160.92';
            }
          }
          document.getElementById('modelo').addEventListener('change', ()=>{
            if(categoriaSelect.value === "Pronta Entrega"){
              const md = document.getElementById('modelo').value;
              const pl = document.getElementById('plano').value;
              if(valores[md] && valores[md][pl]){
                document.getElementById('custo').value = valores[md][pl].custo || "";
                document.getElementById('venda').value = valores[md][pl].venda || "";
              }
            }
            atualizarValorVenda();
          });
          document.getElementById('plano').addEventListener('change', ()=>{
            if(categoriaSelect.value === "Pronta Entrega"){
              const md = document.getElementById('modelo').value;
              const pl = document.getElementById('plano').value;
              if(valores[md] && valores[md][pl]){
                document.getElementById('custo').value = valores[md][pl].custo || "";
                document.getElementById('venda').value = valores[md][pl].venda || "";
              }
            }
            atualizarValorVenda();
          });


          const cadastrarBtn = document.getElementById('cadastrar-btn');
          cadastrarBtn.addEventListener('click', ()=>{
            const modeloVal = document.getElementById('modelo').value;
            const planoVal = document.getElementById('plano').value;
            const catVal = document.getElementById('categoria').value;
            const cadVal = document.getElementById('cadastro').value;
            let dataVal = "";
            const dtInput = document.getElementById('data').value;
            if(dtInput){
              let parts = dtInput.split("-");
              if(parts.length === 3){
                dataVal = `${parts[2]}/${parts[1]}/${parts[0]}`;
              }
            }
            let custoVal = 0, vendaVal = 0;
            if(catVal === "Pronta Entrega"){
              const valoresItem = (valores[modeloVal] && valores[modeloVal][planoVal]) || {};
              custoVal = parseFloat(valoresItem.custo) || 0;
              vendaVal = parseFloat(valoresItem.venda) || 0;
            }
            const chipVal = document.getElementById('chip-operadora').value;
            const alocVal = document.getElementById('alocacao').value;
            const stVal = document.getElementById('status-maquina').value;
            const tipoInclusao = document.querySelector('input[name="tipo-inclusao"]:checked').value;


            if(tipoInclusao === "unica"){
              const serialVal = document.getElementById('serial').value.trim();
              if(!serialVal || estoque.some(i => i.serial === serialVal)){
                showAlert("Serial já cadastrada ou inválida!");
                return;
              }
              estoque.push({
                serial: serialVal,
                modelo: modeloVal,
                plano: planoVal,
                categoria: catVal,
                cadastro: cadVal,
                data: dataVal,
                custo: custoVal,
                venda: vendaVal,
                chipOperadora: chipVal,
                alocacao: alocVal,
                status: stVal,
                notas: "",
                ads: ""
              });
              localStorage.setItem('estoque', JSON.stringify(estoque));
              if(chipVal !== ""){
                chipsCount[catVal][chipVal]++;
                chipsDateLastUpdate[catVal][chipVal] = new Date().toLocaleDateString();
                localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
                localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
              }
              document.getElementById('cadastro-form').reset();
              grupoCustoVenda.style.display = "block";
              showAlert("Maquininha cadastrada com sucesso!");
              registrarLog("Cadastro", `Serial ${serialVal} cadastrada`);
              popularModelFilters();
            } else {
              const serialsText = document.getElementById('serial-lote').value;
              const serialsArray = serialsText.split(",").map(s => s.trim()).filter(s => s !== "");
              if(serialsArray.length === 0){
                showAlert("Nenhum serial informado!");
                return;
              }
              let duplicates = serialsArray.filter(s => estoque.some(i => i.serial === s));
              if(duplicates.length > 0){
                showAlert("Alguns seriais já cadastrados: " + duplicates.join(", "));
                return;
              }
              showConfirm("Deseja realizar a inclusão em Lote?", function(confirmado) {
                if(!confirmado) return;
                serialsArray.forEach(serial => {
                  estoque.push({
                    serial: serial,
                    modelo: modeloVal,
                    plano: planoVal,
                    categoria: catVal,
                    cadastro: cadVal,
                    data: dataVal,
                    custo: custoVal,
                    venda: vendaVal,
                    chipOperadora: chipVal,
                    alocacao: alocVal,
                    status: stVal,
                    notas: "",
                    ads: ""
                  });
                  registrarLog("Cadastro em Lote", `Serial ${serial} cadastrada`);
                  if(chipVal !== ""){
                    chipsCount[catVal][chipVal]++;
                    chipsDateLastUpdate[catVal][chipVal] = new Date().toLocaleDateString();
                  }
                });
                localStorage.setItem('estoque', JSON.stringify(estoque));
                localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
                localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
                showAlert(`Maquininha(s) cadastrada(s) com sucesso! Total: ${serialsArray.length}`, function(){
                  document.getElementById('cadastro-form').reset();
                  document.getElementById('inclusao-unica').checked = true;
                  containerUnica.classList.remove('hidden');
                  containerLote.classList.add('hidden');
                  grupoCustoVenda.style.display = "block";
                  popularModelFilters();
                });
              });
            }
          });


          const toggleProntaBtn = document.getElementById('toggle-pronta');
          const prontaContainer = document.getElementById('pronta-entrega-container');
          const tableProntaBody = document.querySelector('#table-pronta tbody');
          const filterModelPronta = document.getElementById('filter-model-pronta');
          const filterTipoCadPronta = document.getElementById('filter-tipo-cadastro-pronta');
          const filterBadPronta = document.getElementById('filter-bad-pronta');


          const filterReservadoPronta = document.getElementById('filter-reservado-pronta');
          const filterReservadoTon = document.getElementById('filter-reservado-ton');
const toggleTonBtn = document.getElementById('toggle-ton');
          const tonContainer = document.getElementById('ton-na-mao-container');
          const tableTonBody = document.querySelector('#table-ton tbody');
          const filterModelTon = document.getElementById('filter-model-ton');
          const filterBadTon = document.getElementById('filter-bad-ton');


          toggleProntaBtn.addEventListener('click', ()=>{
            if(prontaContainer.classList.contains('hidden')){
              prontaContainer.classList.remove('hidden');
              toggleProntaBtn.textContent = "[-]";
              atualizarTabelaPronta();
            } else {
              prontaContainer.classList.add('hidden');
              toggleProntaBtn.textContent = "[+]";
            }
          });


          // Controle exibir/ocultar Ton layout
          let tonVisivel = true;
          const toggleTonLayoutBtn = document.getElementById('toggle-ton-layout');
          const tonNaMaoHeader = document.querySelector('#ton-na-mao-container').previousElementSibling;


          toggleTonLayoutBtn.addEventListener('click', function(){
            if(tonVisivel){
              // Ocultar Ton
              tonNaMaoHeader.classList.add('hidden');
              tonContainer.classList.add('hidden');
              toggleTonLayoutBtn.textContent = 'Exibir Ton na Mão';
              tonVisivel = false;
            } else {
              // Exibir Ton
              tonNaMaoHeader.classList.remove('hidden');
              tonContainer.classList.remove('hidden');
              toggleTonLayoutBtn.textContent = 'Ocultar Ton na Mão';
              toggleTonBtn.textContent = '[-]';
              tonContainer.classList.remove('hidden');
              atualizarTabelaTon();
              tonVisivel = true;
            }
          });


          toggleTonBtn.addEventListener('click', ()=>{
            if(tonContainer.classList.contains('hidden')){
              tonContainer.classList.remove('hidden');
              toggleTonBtn.textContent = "[-]";
              atualizarTabelaTon();
            } else {
              tonContainer.classList.add('hidden');
              toggleTonBtn.textContent = "[+]";
            }
          });


          filterModelPronta.addEventListener('change', atualizarTabelaPronta);
          filterTipoCadPronta.addEventListener('change', atualizarTabelaPronta);
          filterBadPronta.addEventListener('change', atualizarTabelaPronta);
          filterReservadoPronta.addEventListener('change', atualizarTabelaPronta);
filterModelTon.addEventListener('change', atualizarTabelaTon);
          filterBadTon.addEventListener('change', atualizarTabelaTon);
          filterReservadoTon.addEventListener('change', atualizarTabelaTon);
function extrairTipoCadastro(cadastroStr){
            if(!cadastroStr) return "N/A";
            const str = cadastroStr.toUpperCase();
            if(str.includes("CNPJ")) return "CNPJ";
            if(str.includes("CPF")) return "CPF";
            return "N/A";
          }


          function popularModelFilters(){
            const totalPronta = estoque.filter(i => i.categoria === "Pronta Entrega").length;
            filterModelPronta.innerHTML = `<option value="">[Todos] (${totalPronta})</option>`;
            const countsProntaDetailed = {};
            estoque.forEach(i=>{
              if(i.categoria === "Pronta Entrega"){
                const key = i.modelo + "||" + i.cadastro;
                if(!countsProntaDetailed[key]) countsProntaDetailed[key] = 0;
                countsProntaDetailed[key]++;
              }
            });
            Object.keys(countsProntaDetailed).forEach(k=>{
              const parts = k.split("||");
              const model = parts[0];
              const cad = parts[1];
              const count = countsProntaDetailed[k];
              let opt = document.createElement('option');
              opt.value = k;
              opt.textContent = `${model} (${cad}) (${count})`;
              filterModelPronta.appendChild(opt);
            });


            const totalTon = estoque.filter(i => i.categoria === "Ton Na Mão").length;
            filterModelTon.innerHTML = `<option value="">[Todos] (${totalTon})</option>`;
            const countsTon = {};
            estoque.forEach(i=>{
              if(i.categoria === "Ton Na Mão"){
                countsTon[i.modelo] = (countsTon[i.modelo] || 0) + 1;
              }
            });
            Object.keys(countsTon).forEach(md=>{
              let opt = document.createElement('option');
              opt.value = md;
              opt.textContent = `${md} (${countsTon[md]})`;
              filterModelTon.appendChild(opt);
            });
          }


          function atualizarTabelaPronta(){
            tableProntaBody.innerHTML = "";
            const selectedVal = filterModelPronta.value;
            const selectedTipoCad = filterTipoCadPronta.value;
            const onlyBad = filterBadPronta.checked;
            const onlyReservado = filterReservadoPronta.checked;


            const list = estoque.filter(i=>{
              if(i.categoria !== "Pronta Entrega") return false;
              if(selectedVal){
                const itemKey = i.modelo + "||" + i.cadastro;
                if(itemKey !== selectedVal) return false;
              }
              if(selectedTipoCad){
                const tc = extrairTipoCadastro(i.cadastro);
                if(tc !== selectedTipoCad) return false;
              }
              if(onlyBad && !onlyReservado && i.status !== "BAD") return false;
              if(onlyReservado && !onlyBad && i.status !== "RESERVADO") return false;
              if(onlyBad && onlyReservado && ["BAD","RESERVADO"].indexOf(i.status) === -1) return false;
              return true;
            });


            if(list.length === 0){
              const tr = document.createElement('tr');
              tr.innerHTML = `<td colspan="11" style="text-align:center;">Sem itens de Pronta Entrega</td>`;
              tableProntaBody.appendChild(tr);
              return;
            }
            list.forEach(item=>{
              const color = (item.status === "GOOD") ? "green" : "red";
              const idx = estoque.indexOf(item);
              const valoresItem = (valores[item.modelo] && valores[item.modelo][item.plano]) || {};
              const custoExibir = (typeof valoresItem.custo !== "undefined") ? parseFloat(valoresItem.custo).toFixed(2) : "";
              const vendaExibir = (typeof valoresItem.venda !== "undefined") ? parseFloat(valoresItem.venda).toFixed(2) : "";
              const tr = document.createElement('tr');
              tr.innerHTML =
                `<td>${item.serial}</td>
                 <td>${item.modelo}</td>
                 <td>${item.plano}</td>
                 <td>${item.cadastro}</td>
                 <td>${formatDateBR(item.data)}</td>
                 <td>${custoExibir}</td>
                 <td>${vendaExibir}</td>
                 <td>${item.chipOperadora}</td>
                 <td>${item.alocacao}</td>
                 <td><span style="color:${color};font-weight:bold;">${item.status}</span></td>
                 <td>
                   <div class="action-options">
                     <button class="toggle-actions" onclick="toggleActions(this)">Mais</button>
                     <div class="dropdown">
                       <button onclick="abrirModalEdicao(${idx})">Editar</button>
                       <button onclick="removerItem(${idx})">Remover</button>
                <button onclick="reservarItem(${idx})">Reservar</button>
                     </div>
                   </div>
                 </td>`;
              tableProntaBody.appendChild(tr);
            });
          }


          function atualizarTabelaTon(){
            tableTonBody.innerHTML = "";
            const selectedModel = filterModelTon.value;
            const onlyBad = filterBadTon.checked;
            const onlyReservado = filterReservadoTon.checked;
            const list = estoque.filter(i=>{
              if(i.categoria !== "Ton Na Mão") return false;
              if(selectedModel && i.modelo !== selectedModel) return false;
              if(onlyBad && !onlyReservado && i.status !== "BAD") return false;
              if(onlyReservado && !onlyBad && i.status !== "RESERVADO") return false;
              if(onlyBad && onlyReservado && ["BAD","RESERVADO"].indexOf(i.status) === -1) return false;
              return true;
            });
            if(list.length === 0){
              const tr = document.createElement('tr');
              tr.innerHTML = `<td colspan="11" style="text-align:center;">Sem itens de Ton Na Mão</td>`;
              tableTonBody.appendChild(tr);
              return;
            }
            list.forEach(item=>{
              const color = (item.status === "GOOD") ? "green" : "red";
              const idx = estoque.indexOf(item);
              const valoresItem = (valores[item.modelo] && valores[item.modelo][item.plano]) || {};
              let vendaExibir = "";
              let comissaoExibir = "";
              if(valoresItem.venda !== undefined){
                vendaExibir = parseFloat(valoresItem.venda).toFixed(2);
              }
              if(valoresItem.tnmComissao !== undefined){
                comissaoExibir = parseFloat(valoresItem.tnmComissao).toFixed(2);
              }
              const tr = document.createElement('tr');
              tr.innerHTML =
                `<td>${item.serial}</td>
                 <td>${item.modelo}</td>
                 <td>${item.plano}</td>
                 <td>${item.cadastro}</td>
                 <td>${formatDateBR(item.data)}</td>
                 <td>${vendaExibir}</td>
                 <td>${comissaoExibir}</td>
                 <td>${item.chipOperadora}</td>
                 <td>${item.alocacao}</td>
                 <td><span style="color:${color};font-weight:bold;">${item.status}</span></td>
                 <td>
                   <div class="action-options">
                     <button class="toggle-actions" onclick="toggleActions(this)">Mais</button>
                     <div class="dropdown">
                       <button onclick="abrirModalEdicao(${idx})">Editar</button>
                       <button onclick="removerItem(${idx})">Remover</button>
                <button onclick="reservarItem(${idx})">Reservar</button>
                     </div>
                   </div>
                 </td>`;
              tableTonBody.appendChild(tr);
            });
          }


          window.removerItem = function(idx){
            if(!loggedInUser || loggedInUser.nivel !== 1){
              showAlert("Você não tem permissão para excluir itens!");
              return;
            }
            const item = estoque[idx];
  if(item.status === "RESERVADO"){
        showAlert("Item reservado. Indisponível para esta ação!");
        return;
  }
            showConfirm(`Deseja remover o item serial: ${item.serial}?`, function(confirmado){
              if(!confirmado) return;
              if(item.status === "RESERVADO") {
  showAlert("Este item está RESERVADO e não pode ser baixado!");
  return;
}
estoque.splice(idx,1);
              localStorage.setItem('estoque', JSON.stringify(estoque));
              recalcularChipsCount();
              localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
              localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
              showAlert("Item removido!");
              registrarLog("Remoção", `Serial ${item.serial} removida`);
              popularModelFilters();
              atualizarTabelaPronta();
              atualizarTabelaTon();
              atualizarHistorico();
            });
          };
          function recalcularChipsCount() {
            const operators = ["TIM", "VIVO", "CLARO", "SEM_CHIP"];
            let novoCount = { TIM: 0, VIVO: 0, CLARO: 0, SEM_CHIP: 0 };
            estoque.forEach(item => {
              if(item.categoria === "Pronta Entrega" && item.chipOperadora && operators.includes(item.chipOperadora)){
                novoCount[item.chipOperadora]++;
              }
            });
            chipsCount["Pronta Entrega"] = novoCount;
          }


          let editIndex = null;
          window.abrirModalEdicao = function(idx){
            editIndex = idx;
            preencherCombosEdicao();
            const item = estoque[idx];
            document.getElementById('edit-serial').value = item.serial;
            document.getElementById('edit-modelo').value = item.modelo;
            document.getElementById('edit-plano').value = item.plano;
            document.getElementById('edit-categoria').value = item.categoria;
            document.getElementById('edit-cadastro').value = item.cadastro;
            if(item.data){
              let parts = item.data.split('/');
              if(parts.length === 3){
                const iso = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                document.getElementById('edit-data').value = iso;
              } else {
                document.getElementById('edit-data').value = "";
              }
            } else {
              document.getElementById('edit-data').value = "";
            }
            if(item.categoria === "Pronta Entrega"){
              const md = item.modelo;
              const pl = item.plano;
              if(valores[md] && valores[md][pl]){
                document.getElementById('edit-custo').value = valores[md][pl].custo || 0;
                document.getElementById('edit-venda').value = valores[md][pl].venda || 0;
              } else {
                document.getElementById('edit-custo').value = item.custo || 0;
                document.getElementById('edit-venda').value = item.venda || 0;
              }
              document.getElementById('edit-grupo-custo-venda').style.display = "block";
            } else {
              document.getElementById('edit-grupo-custo-venda').style.display = "none";
            }
            document.getElementById('edit-chip-operadora').value = item.chipOperadora;
            document.getElementById('edit-alocacao').value = item.alocacao;
            document.getElementById('edit-status-maquina').value = item.status;
            document.getElementById('edit-anotacoes').value = item.notas || "";
            document.getElementById('edit-ads').value = item.ads || "ORG";
            document.getElementById('modal-edicao').classList.remove('hidden');
          };
          var fecharModalEdicao = document.getElementById('fechar-modal-edicao');
          if(fecharModalEdicao){
            fecharModalEdicao.addEventListener('click', ()=>{
              document.getElementById('modal-edicao').classList.add('hidden');
            });
          }


          document.getElementById('confirmar-edicao').addEventListener('click', function(){
            if(editIndex === null) return;
            const item = estoque[editIndex];
            item.modelo = document.getElementById('edit-modelo').value;
            item.plano = document.getElementById('edit-plano').value;
            item.categoria = document.getElementById('edit-categoria').value;
            item.cadastro = document.getElementById('edit-cadastro').value;
            const dataIso = document.getElementById('edit-data').value;
            if(dataIso){
              const parts = dataIso.split("-");
              if(parts.length === 3){
                item.data = `${parts[2]}/${parts[1]}/${parts[0]}`;
              }
            } else {
              item.data = "";
            }
            item.chipOperadora = document.getElementById('edit-chip-operadora').value;
            item.alocacao = document.getElementById('edit-alocacao').value;
            item.status = document.getElementById('edit-status-maquina').value;
            item.notas = document.getElementById('edit-anotacoes').value;
            item.ads = document.getElementById('edit-ads').value;
            localStorage.setItem('estoque', JSON.stringify(estoque));
            showAlert("Item atualizado com sucesso!");
            document.getElementById('modal-edicao').classList.add('hidden');
            popularModelFilters();
            atualizarTabelaPronta();
            atualizarTabelaTon();
          });


          // BAIXAR ITEM
          const btnBaixarItem = document.getElementById('btn-baixar-item');
          const modalBaixa = document.getElementById('modal-baixa');
          const fecharModalBaixaBtn = document.getElementById('fechar-modal-baixa');
          const confirmarBaixaBtn = document.getElementById('confirmar-baixa');
          const baixaConsultorSelect = document.getElementById('baixa-consultor');


          btnBaixarItem.addEventListener('click', ()=>{
            baixaConsultorSelect.innerHTML = "";
            systemConfig.consultores.forEach(cons=>{
              let opt = document.createElement('option');
              opt.value = cons.name;
              opt.textContent = `${cons.name} - ${cons.loja} (${cons.comissao}%)`;
              baixaConsultorSelect.appendChild(opt);
            });
            document.getElementById('baixa-serial').value = "";
            document.getElementById('baixa-cliente').value = "";
            modalBaixa.classList.remove('hidden');
          });
          if(fecharModalBaixaBtn){
            fecharModalBaixaBtn.addEventListener('click', ()=>{
              modalBaixa.classList.add('hidden');
            });
          }


          function alternarTipoBaixa() {
            const tipo = document.querySelector('input[name="baixa-tipo"]:checked').value;
            if(tipo === "estoque" || tipo === "devolucao_bad"){
              document.getElementById('baixa-estoque-container').classList.remove('hidden');
              document.getElementById('baixa-adlink-container').classList.add('hidden');
            } else {
              document.getElementById('baixa-estoque-container').classList.add('hidden');
              document.getElementById('baixa-adlink-container').classList.remove('hidden');
              let selModelo = document.getElementById('baixa-modelo-adlink');
              let selPlano = document.getElementById('baixa-plano-adlink');
              selModelo.innerHTML = "";
              systemConfig.modelos.forEach(m => {
                let opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                selModelo.appendChild(opt);
              });
              selPlano.innerHTML = "";
              systemConfig.planos.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                selPlano.appendChild(opt);
              });
            }
          }
          document.querySelectorAll('input[name="baixa-tipo"]').forEach(input => {
            input.addEventListener('change', alternarTipoBaixa);
            input.addEventListener('click', alternarTipoBaixa);
          });


          confirmarBaixaBtn.addEventListener('click', ()=>{
            const tipoBaixa = document.querySelector('input[name="baixa-tipo"]:checked').value;
            const now = new Date();
            const dataBaixa = now.toLocaleDateString('pt-BR');
            const horarioBaixa = now.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
            let comissaoFinal = 0;
            let valorVenda = 0;


            if(tipoBaixa === "estoque"){
              const serialVal = document.getElementById('baixa-serial').value.trim();
              if(!serialVal){
                showAlert("Informe o serial!");
                return;
              }
              const idx = estoque.findIndex(e => e.serial === serialVal);
              if(idx === -1){
                showAlert("Serial não encontrado!");
                return;
              }
              const item = estoque[idx];


              if(item.categoria === "Ton Na Mão"){
                if(valores[item.modelo] && valores[item.modelo][item.plano]){
                  valorVenda = parseFloat(valores[item.modelo][item.plano].venda) || 0;
                  const consultorObj = systemConfig.consultores.find(c => c.name.trim().toLowerCase() === baixaConsultorSelect.value.trim().toLowerCase());
                  if(consultorObj){
                    const pct = consultorObj.comissao / 100;
                    const tnmRef = parseFloat(valores[item.modelo][item.plano].tnmComissao) || 0;
                    comissaoFinal = tnmRef * pct;
                  }
                }
                const consultorName = baixaConsultorSelect.value;
                const clienteVal = document.getElementById('baixa-cliente').value.trim() || "Cliente Final";
                let planosOptions = systemConfig.planos.map(p => { return {value: p, text: p}; });
                showSelectPrompt("Selecione o plano do cliente:", planosOptions, systemConfig.planos[0] || "", function(planoSelecionado){
                  if(planoSelecionado===null) return;
                  showSelectPrompt("Como o cliente chegou? ('ORG' para orgânico ou 'TP' para tráfego pago)",
                    [{value:"ORG", text:"Orgânico (ORG)"}, {value:"TP", text:"Tráfego Pago (TP)"}], "ORG", function(adsChoice){
                      if(adsChoice===null) return;
                      if(item.status === "RESERVADO") {
                        showAlert("Este item está RESERVADO e não pode ser baixado!");
                        return;
                      }
                      historico.push({
                        serial: item.serial,
                        data: dataBaixa,
                        horario: horarioBaixa,
                        cliente: clienteVal,
                        categoria: item.categoria,
                        cadastro: item.cadastro,
                        modelo: item.modelo,
                        plano: planoSelecionado,
                        chip: item.chipOperadora,
                        loja: item.alocacao,
                        consultor: consultorName,
                        comissao: comissaoFinal.toFixed(2),
                        valorVenda: valorVenda.toFixed(2),
                        status: "OK",
                        origem: "TNM",
                        ads: adsChoice,
                        // IMPLEMENTAÇÃO #2 (manter notas)
                        notas: item.notas
                      });
estoque.splice(idx, 1);
                      if(item.chipOperadora !== ""){
                        chipsCount[item.categoria][item.chipOperadora]--;
                        chipsDateLastUpdate[item.categoria][item.chipOperadora] = new Date().toLocaleDateString();
                        localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
                        localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
                      }
                      localStorage.setItem('historico', JSON.stringify(historico));
                      showAlert("Baixa computada com sucesso!", function(){
                        registrarLog("Baixa", "Baixa via estoque realizada (TNM)");
                        modalBaixa.classList.add('hidden');
                        popularModelFilters();
                        atualizarTabelaPronta();
                        atualizarTabelaTon();
                        atualizarHistorico();
                        recalcularChipsCount();
                      });
                    });
                });
              }
              else {
                valorVenda = item.venda || 0;
                let valorCusto = item.custo || 0;
                if(valores[item.modelo] && valores[item.modelo][item.plano]){
                  valorVenda = valores[item.modelo][item.plano].venda || valorVenda;
                  valorCusto = valores[item.modelo][item.plano].custo || valorCusto;
                }
                const consultorObj = systemConfig.consultores.find(c => c.name.trim().toLowerCase() === baixaConsultorSelect.value.trim().toLowerCase());
                if(consultorObj){
                  const pct = consultorObj.comissao / 100;
                  let base = valorVenda - valorCusto;
                  if(base < 0) base = 0;
                  comissaoFinal = base * pct;
                }
                const consultorName = baixaConsultorSelect.value;
                const clienteVal = document.getElementById('baixa-cliente').value.trim() || "Cliente Final";
                showConfirm("É a 1ª Adesão? (Sim=1ª / Não=2ª)", function(ehPrimeira){
                  let registroOrigem = ehPrimeira ? "PE-1" : "PE-2";
                  showSelectPrompt("Como o cliente chegou? ('ORG' ou 'TP')",
                    [{value:"ORG", text:"Orgânico (ORG)"}, {value:"TP", text:"Tráfego Pago (TP)"}], "ORG", function(adsChoice){
                      if(adsChoice===null) return;
                      let record = {
                        serial: item.serial,
                        data: dataBaixa,
                        horario: horarioBaixa,
                        cliente: clienteVal,
                        categoria: item.categoria,
                        cadastro: item.cadastro,
                        modelo: item.modelo,
                        plano: item.plano,
                        chip: item.chipOperadora,
                        loja: item.alocacao,
                        consultor: consultorName,
                        comissao: comissaoFinal.toFixed(2),
                        valorVenda: valorVenda.toFixed(2),
                        status: "OK",
                        origem: registroOrigem,
                        ads: adsChoice,
                        // IMPLEMENTAÇÃO #2 (manter notas)
                        notas: item.notas
                      };
                      if(item.status === "RESERVADO") {
                        showAlert("Este item está RESERVADO e não pode ser baixado!");
                        return;
                      }
                      historico.push(record);
estoque.splice(idx, 1);
                      localStorage.setItem('estoque', JSON.stringify(estoque));
                      if(item.chipOperadora !== ""){
                        chipsCount[item.categoria][item.chipOperadora]--;
                        chipsDateLastUpdate[item.categoria][item.chipOperadora] = new Date().toLocaleDateString();
                        localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
                        localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
                      }
                      localStorage.setItem('historico', JSON.stringify(historico));
                      showAlert("Baixa computada com sucesso!", function(){
                        registrarLog("Baixa", "Baixa via estoque realizada (PE)");
                        modalBaixa.classList.add('hidden');
                        popularModelFilters();
                        atualizarTabelaPronta();
                        atualizarTabelaTon();
                        atualizarHistorico();
                        recalcularChipsCount();
                      });
                    });
                });
              }
            }
            else if(tipoBaixa === "adlink"){
              const modeloAdlink = document.getElementById('baixa-modelo-adlink').value;
              const planoAdlink = document.getElementById('baixa-plano-adlink').value;
              if(!modeloAdlink || !planoAdlink){
                showAlert("Selecione modelo e plano para Ad Link!");
                return;
              }
              const consultorName = document.getElementById('baixa-consultor').value;
              const clienteVal = document.getElementById('baixa-cliente').value.trim() || "Cliente Final";
              const consultorObj = systemConfig.consultores.find(c => c.name.trim().toLowerCase() === consultorName.trim().toLowerCase());
              let comissaoFinal = 0;
              let valorVenda = 0;
              if(valores[modeloAdlink] && valores[modeloAdlink][planoAdlink] && valores[modeloAdlink][planoAdlink].tnmComissao && consultorObj){
                const pct = consultorObj.comissao / 100;
                let tnmRef = parseFloat(valores[modeloAdlink][planoAdlink].tnmComissao) || 0;
                comissaoFinal = tnmRef * pct;
                valorVenda = valores[modeloAdlink][planoAdlink].venda || 0;
              }
              showSelectPrompt("Como o cliente chegou? ('ORG' ou 'TP')",
                [{value:"ORG", text:"Orgânico (ORG)"}, {value:"TP", text:"Tráfego Pago (TP)"}], "ORG", function(adsChoice){
                  if(adsChoice===null) return;
                  historico.push({
                    serial: "",
                    data: dataBaixa,
                    horario: horarioBaixa,
                    cliente: clienteVal,
                    categoria: "Ton Na Mão",
                    cadastro: "",
                    modelo: modeloAdlink,
                    plano: planoAdlink,
                    chip: "",
                    loja: "",
                    consultor: consultorName,
                    comissao: comissaoFinal.toFixed(2),
                    valorVenda: valorVenda.toFixed(2),
                    status: "OK",
                    origem: "AD LINK",
                    ads: adsChoice
                    // sem 'notas', pois não há item original no estoque
                  });
                  localStorage.setItem('historico', JSON.stringify(historico));
                  showAlert("Baixa Ad Link computada com sucesso!", function(){
                    registrarLog("Baixa", "Baixa Ad Link realizada");
                    modalBaixa.classList.add('hidden');
                    atualizarHistorico();
                  });
              });
            }
            else if(tipoBaixa === "devolucao_bad"){
              const serialVal = document.getElementById('baixa-serial').value.trim();
              if(!serialVal){
                showAlert("Informe o serial!");
                return;
              }
              const idx = estoque.findIndex(e => e.serial === serialVal);
              if(idx === -1){
                showAlert("Serial não encontrada!");
                return;
              }
              const item = estoque[idx];
              // IMPLEMENTAÇÃO #2: Manter a anotação anterior e concatenar a info de devolução:
              const originalNotas = item.notas || "";
              item.notas = originalNotas ? (originalNotas + " | CONCLUÍDIDO - BAIXADO POR DEVOLUÇÃO") : "CONCLUÍDIDO - BAIXADO POR DEVOLUÇÃO";


              historico.push({
                serial: item.serial,
                data: dataBaixa,
                horario: horarioBaixa,
                cliente: "",
                categoria: item.categoria,
                cadastro: item.cadastro,
                modelo: item.modelo,
                plano: item.plano,
                chip: item.chipOperadora,
                loja: item.alocacao,
                consultor: loggedInUser ? loggedInUser.name : "",
                comissao: "0.00",
                valorVenda: "0.00",
                status: "BAD",
                origem: "DEVOLUÇÃO BAD",
                ads: "",
                notas: item.notas
              });
              if(item.status === "RESERVADO") {
                showAlert("Este item está RESERVADO e não pode ser baixado!");
                return;
              }
              estoque.splice(idx,1);
              localStorage.setItem('estoque', JSON.stringify(estoque));
              if(item.chipOperadora !== ""){
                chipsCount[item.categoria][item.chipOperadora]--;
                chipsDateLastUpdate[item.categoria][item.chipOperadora] = new Date().toLocaleDateString();
                localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
                localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
              }
              localStorage.setItem('historico', JSON.stringify(historico));
              showAlert("Baixa computada com sucesso!", function(){
                registrarLog("Baixa", "Baixa Devolução Bad realizada");
                modalBaixa.classList.add('hidden');
                popularModelFilters();
                atualizarTabelaPronta();
                atualizarTabelaTon();
                atualizarHistorico();
                recalcularChipsCount();
              });
            }
          });


          // HISTÓRICO DE BAIXAS
          const btnVerHistorico = document.getElementById('ver-historico-btn');
          const modalHistorico = document.getElementById('modal-historico');
          const fecharHistoricoBtn = document.getElementById('fechar-modal-historico');
          const filterHistoricoCat = document.getElementById('filter-historico-categoria');
          const filterHistoricoCad = document.getElementById('filter-historico-cadastro');
          const filterHistoricoStatus = document.getElementById('filter-historico-status');
          const filterHistoricoData = document.getElementById('filter-historico-data');


          filterHistoricoData.addEventListener('change', atualizarHistorico);
          btnVerHistorico.addEventListener('click', ()=>{
            preencherFiltroHistoricoData();
            atualizarHistorico();
            modalHistorico.classList.remove('hidden');
          });
          if(fecharHistoricoBtn){
            fecharHistoricoBtn.addEventListener('click', ()=>{
              modalHistorico.classList.add('hidden');
            });
          }
          filterHistoricoCat.addEventListener('change', atualizarHistorico);
          filterHistoricoCad.addEventListener('change', atualizarHistorico);
          filterHistoricoStatus.addEventListener('change', atualizarHistorico);


          function atualizarHistorico(){
            const tbody = document.querySelector('#historico-table tbody');
            if(!tbody) return;
            tbody.innerHTML = "";
            const currentCadastro = filterHistoricoCad.value;
            filterHistoricoCad.innerHTML = `<option value="">[Todos]</option>`;
            systemConfig.cadastros.forEach(cad=>{
              let opt = document.createElement('option');
              opt.value = cad;
              opt.textContent = cad;
              filterHistoricoCad.appendChild(opt);
            });
            filterHistoricoCad.value = currentCadastro;
            if(historico.length === 0){
              let tr = document.createElement('tr');
              tr.innerHTML = `<td colspan="15" style="text-align:center;">Sem histórico de baixas</td>`;
              tbody.appendChild(tr);
              return;
            }
            let catVal = filterHistoricoCat.value;
            let cadVal = filterHistoricoCad.value;
            let statusVal = filterHistoricoStatus.value;
            const dataFilter = filterHistoricoData.value;
            let selectedMonth = null, selectedYear = null;
            if(dataFilter){
              const parts = dataFilter.split("/");
              if(parts.length === 2){
                selectedMonth = parseInt(parts[0],10);
                selectedYear = parseInt(parts[1],10);
              }
            }
            let registros = historico.filter(r=>{
              if(selectedMonth && selectedYear){
                let rDate = parseDateBR(r.data);
                if(!rDate) return false;
                if((rDate.getMonth()+1) !== selectedMonth || rDate.getFullYear() !== selectedYear)
                  return false;
              }
              if(catVal){
                if(r.categoria !== catVal) return false;
              }
              if(cadVal && r.cadastro !== cadVal) return false;
              if(statusVal && r.status !== statusVal) return false;
              return true;
            });
            if(registros.length === 0){
              let tr = document.createElement('tr');
              tr.innerHTML = `<td colspan="15" style="text-align:center;">Nenhum registro encontrado.</td>`;
              tbody.appendChild(tr);
              return;
            }
            registros.forEach((r)=>{
              let originalIndex = historico.indexOf(r);
              let tr = document.createElement('tr');
              tr.innerHTML =
                `<td>${r.serial}</td>
                 <td>${r.data || ""}</td>
                 <td>${r.horario || ""}</td>
                 <td>${r.cliente || ""}</td>
                 <td>${r.categoria || ""}</td>
                 <td>${r.status || ""}</td>
                 <td>${r.cadastro || ""}</td>
                 <td>${r.modelo || ""}</td>
                 <td>${r.plano || ""}</td>
                 <td>${r.chip || ""}</td>
                 <td>${r.loja || ""}</td>
                 <td>${(r.consultor || r.vendedor || "").trim()}</td>
                 <td>${r.comissao ? "R$ " + parseFloat(r.comissao).toFixed(2) : ""}</td>
                 <td>${r.ads || ""}</td>
                 <td>
                   <div class="history-actions">
                     <button class="toggle-actions" onclick="toggleActions(this)">Mais</button>
                     <div class="dropdown">
                       <button onclick="editarHistorico(${originalIndex})">Editar</button>
                       <button onclick="removerHistorico(${originalIndex})">Remover</button>
                     </div>
                   </div>
                 </td>`;
              tbody.appendChild(tr);
            });
          }


          let historicoEditIndex = null;
          const editHistoricoModelo = document.getElementById('edit-historico-modelo');
          const editHistoricoPlano = document.getElementById('edit-historico-plano');
          const editHistoricoCategoria = document.getElementById('edit-historico-categoria');


          function refreshEditHistoricoComissao(){
            if(historicoEditIndex === null) return;
            let reg = historico[historicoEditIndex];
            let cat = document.getElementById('edit-historico-categoria').value;
            let md = document.getElementById('edit-historico-modelo').value;
            let pl = document.getElementById('edit-historico-plano').value;
            let consultorNome = document.getElementById('edit-historico-consultor').value.trim();
            let comissaoNova = 0;


            let consultorObj = systemConfig.consultores.find(c => c.name.trim().toLowerCase() === consultorNome.toLowerCase());
            if(!consultorObj){
              document.getElementById('edit-historico-comissao').value = "0";
              return;
            }


            if(reg.origem === "AD LINK" || cat === "Ton Na Mão"){
              if(valores[md] && valores[md][pl] && valores[md][pl].tnmComissao){
                let baseTnm = parseFloat(valores[md][pl].tnmComissao) || 0;
                let pct = consultorObj.comissao / 100;
                comissaoNova = baseTnm * pct;
              }
              document.getElementById('edit-historico-comissao').value = comissaoNova.toFixed(2);
              return;
            } else {
              if(valores[md] && valores[md][pl]){
                let v = parseFloat(valores[md][pl].venda) || 0;
                let c = parseFloat(valores[md][pl].custo) || 0;
                let base = v - c;
                if(base < 0) base = 0;
                let pct = consultorObj.comissao / 100;
                comissaoNova = base * pct;
              }
              document.getElementById('edit-historico-comissao').value = comissaoNova.toFixed(2);
            }
          }


          editHistoricoModelo.addEventListener('change', refreshEditHistoricoComissao);
          editHistoricoPlano.addEventListener('change', refreshEditHistoricoComissao);
          editHistoricoCategoria.addEventListener('change', refreshEditHistoricoComissao);


          window.editarHistorico = function(idx){
            historicoEditIndex = idx;
            const r = historico[idx];
            document.getElementById('edit-historico-serial').value = r.serial;
            if(r.data){
              let parts = r.data.split('/');
              if(parts.length === 3){
                let ds = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                document.getElementById('edit-historico-data').value = ds;
              } else {
                document.getElementById('edit-historico-data').value = "";
              }
            } else {
              document.getElementById('edit-historico-data').value = "";
            }
            document.getElementById('edit-historico-horario').value = r.horario || "";
            document.getElementById('edit-historico-cliente').value = r.cliente || "";
            document.getElementById('edit-historico-categoria').value = r.categoria || "Pronta Entrega";
            preencherCombosEdicaoHistorico();
            document.getElementById('edit-historico-cadastro').value = r.cadastro || "";
            document.getElementById('edit-historico-modelo').value = r.modelo || "";
            document.getElementById('edit-historico-plano').value = r.plano || "";
            document.getElementById('edit-historico-chip').value = r.chip || "";
            document.getElementById('edit-historico-loja').value = r.loja || "";
            document.getElementById('edit-historico-consultor').value = r.consultor || "";
            document.getElementById('edit-historico-comissao').value = r.comissao || 0;
            document.getElementById('edit-historico-status').value = r.status || "OK";
            document.getElementById('edit-historico-ads').value = r.ads || "ORG";
            refreshEditHistoricoComissao();
            document.getElementById('modal-editar-historico').classList.remove('hidden');
          };


          function preencherCombosEdicaoHistorico(){
            const selCad = document.getElementById('edit-historico-cadastro');
            selCad.innerHTML = "";
            systemConfig.cadastros.forEach(c=>{
              let o = document.createElement('option');
              o.value = c;
              o.textContent = c;
              selCad.appendChild(o);
            });
            const selLoja = document.getElementById('edit-historico-loja');
            selLoja.innerHTML = "";
            systemConfig.alocacoes.forEach(l=>{
              let opt = document.createElement('option');
              opt.value = l;
              opt.textContent = l;
              selLoja.appendChild(opt);
            });
            const selModelo = document.getElementById('edit-historico-modelo');
            selModelo.innerHTML = "";
            systemConfig.modelos.forEach(m=>{
              let opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m;
              selModelo.appendChild(opt);
            });
            const selPlano = document.getElementById('edit-historico-plano');
            selPlano.innerHTML = "";
            systemConfig.planos.forEach(p=>{
              let opt = document.createElement('option');
              opt.value = p;
              opt.textContent = p;
              selPlano.appendChild(opt);
            });
          }


          window.removerHistorico = function(idx){
            showConfirm("Deseja excluir este registro do histórico?", function(confirmado){
              if(!confirmado) return;
              historico.splice(idx, 1);
              localStorage.setItem('historico', JSON.stringify(historico));
              showAlert("Registro excluído!");
              atualizarHistorico();
            });
          };
          var cancelarEditarHistorico = document.getElementById('cancelar-editar-historico');
          if(cancelarEditarHistorico){
            cancelarEditarHistorico.addEventListener('click', ()=>{
              document.getElementById('modal-editar-historico').classList.add('hidden');
            });
          }
          var confirmarEditarHistorico = document.getElementById('confirmar-editar-historico');
          if(confirmarEditarHistorico){
            confirmarEditarHistorico.addEventListener('click', ()=>{
              if(historicoEditIndex === null) return;
              const dtVal = document.getElementById('edit-historico-data').value;
              let novaData = "";
              if(dtVal){
                const [yyyy, mm, dd] = dtVal.split("-");
                novaData = `${dd}/${mm}/${yyyy}`;
              }
              const newObj = {
                serial: document.getElementById('edit-historico-serial').value,
                data: novaData,
                horario: document.getElementById('edit-historico-horario').value,
                cliente: document.getElementById('edit-historico-cliente').value,
                categoria: document.getElementById('edit-historico-categoria').value,
                status: document.getElementById('edit-historico-status').value,
                cadastro: document.getElementById('edit-historico-cadastro').value,
                modelo: document.getElementById('edit-historico-modelo').value,
                plano: document.getElementById('edit-historico-plano').value,
                chip: document.getElementById('edit-historico-chip').value,
                loja: document.getElementById('edit-historico-loja').value,
                consultor: document.getElementById('edit-historico-consultor').value,
                comissao: document.getElementById('edit-historico-comissao').value,
                origem: historico[historicoEditIndex].origem,
                ads: document.getElementById('edit-historico-ads').value
              };
              historico[historicoEditIndex] = newObj;
              localStorage.setItem('historico', JSON.stringify(historico));
              document.getElementById('modal-editar-historico').classList.add('hidden');
              showAlert("Registro atualizado!");
              atualizarHistorico();
            });
          }


          // CONTROLE DE CHIP
          const btnControleChip = document.getElementById('btn-controle-chip');
          const modalControleChip = document.getElementById('modal-controle-chip');
          const fecharControleChipBtn = document.getElementById('fechar-modal-controle-chip');
          btnControleChip.addEventListener('click', ()=>{
            atualizarTabelaChips();
            atualizarTabelaChipsDetalhado();
            modalControleChip.classList.remove('hidden');
          });
          if(fecharControleChipBtn){
            fecharControleChipBtn.addEventListener('click', ()=>{
              modalControleChip.classList.add('hidden');
            });
          }
          function atualizarTabelaChips(){
            const operators = ["TIM", "VIVO", "CLARO", "SEM_CHIP"];
            const prontaTbody = document.getElementById('chips-pronta-table-body');
            const tonTbody = document.getElementById('chips-ton-table-body');
            prontaTbody.innerHTML = "";
            tonTbody.innerHTML = "";
            let tr = document.createElement('tr');
            tr.innerHTML = `<th colspan="3">Pronta Entrega</th>`;
            prontaTbody.appendChild(tr);
            operators.forEach(op=>{
              let row = document.createElement('tr');
              let qtd = chipsCount["Pronta Entrega"][op] || 0;
              let dt = chipsDateLastUpdate["Pronta Entrega"][op] || "N/A";
              row.innerHTML = `<td>${op}</td>
                               <td>${qtd} <button class="editar-chip" data-operadora="${op}" data-categoria="Pronta Entrega">Editar</button></td>
                               <td>${dt}</td>`;
              prontaTbody.appendChild(row);
            });
            let trx = document.createElement('tr');
            trx.innerHTML = `<th colspan="3">Ton Na Mão</th>`;
            tonTbody.appendChild(trx);
            operators.forEach(op=>{
              let row = document.createElement('tr');
              let qtd = chipsCount["Ton Na Mão"][op] || 0;
              let dt = chipsDateLastUpdate["Ton Na Mão"][op] || "N/A";
              row.innerHTML = `<td>${op}</td>
                               <td>${qtd} <button class="editar-chip" data-operadora="${op}" data-categoria="Ton Na Mão">Editar</button></td>
                               <td>${dt}</td>`;
              tonTbody.appendChild(row);
            });


            document.querySelectorAll('.editar-chip').forEach(btn => {
              btn.addEventListener('click', function(){
                const operadora = this.getAttribute('data-operadora');
                const categoria = this.getAttribute('data-categoria');
                openChipEditModal(operadora, categoria);
              });
            });
          }
          function atualizarTabelaChipsDetalhado(){
            const chipsDetalhadoBody = document.getElementById('chips-detalhado-table').querySelector('tbody');
            chipsDetalhadoBody.innerHTML = "";
            const list = estoque.filter(i => i.categoria === "Pronta Entrega" && i.chipOperadora && i.chipOperadora !== "SEM_CHIP");
            if(list.length === 0){
              let tr = document.createElement('tr');
              tr.innerHTML = `<td colspan="5" style="text-align:center;">Nenhuma máquina com chip alocada</td>`;
              chipsDetalhadoBody.appendChild(tr);
              return;
            }
            list.forEach(item=>{
              const idx = estoque.indexOf(item);
              let tr = document.createElement('tr');
              tr.innerHTML =
                `<td>${item.serial}</td>
                 <td>${item.chipOperadora}</td>
                 <td>${item.categoria}</td>
                 <td>${item.alocacao}</td>
                 <td>
                   <div class="chip-actions">
                     <button class="toggle-actions" onclick="toggleActions(this)">Mais</button>
                     <div class="dropdown">
                       <button onclick="abrirModalEdicao(${idx})">Editar</button>
                       <button onclick="removerItem(${idx})">Excluir</button>
                     </div>
                   </div>
                 </td>`;
              chipsDetalhadoBody.appendChild(tr);
            });
          }


          let chipEditOperator = "";
          let chipEditCategory = "";
          function openChipEditModal(operadora, categoria){
            chipEditOperator = operadora;
            chipEditCategory = categoria;
            const oldVal = chipsCount[categoria][operadora] || 0;
            document.getElementById('chip-edit-quantity').value = oldVal;
            document.getElementById('modal-editar-chip').classList.remove('hidden');
          }
          document.getElementById('chip-edit-confirm').addEventListener('click', ()=>{
            let newVal = parseInt(document.getElementById('chip-edit-quantity').value,10);
            if(isNaN(newVal) || newVal < 0){
              showAlert("Informe um número válido!");
              return;
            }
            chipsCount[chipEditCategory][chipEditOperator] = newVal;
            chipsDateLastUpdate[chipEditCategory][chipEditOperator] = new Date().toLocaleDateString();
            localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
            localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
            showAlert("Quantidade atualizada!");
            document.getElementById('modal-editar-chip').classList.add('hidden');
            atualizarTabelaChips();
          });
          document.getElementById('chip-edit-cancel').addEventListener('click', ()=>{
            document.getElementById('modal-editar-chip').classList.add('hidden');
          });


          // Central de Custo
          const btnCentralCusto = document.getElementById('btn-central-custo');
          const modalCentralCusto = document.getElementById('modal-central-custo');
          const contentDiv = document.getElementById('modal-central-custo-content');
          btnCentralCusto.addEventListener('click', ()=>{
            showPrompt("Digite a senha para ver a Central de Custo:", "", function(s){
              if(s !== systemConfig.centralCustoPassword){
                showAlert("Senha incorreta!");
                return;
              }
              exibirCentralCusto();
            });
          });
          function exibirCentralCusto(){
            const aggregator = {};
            let totalCusto = 0, totalVenda = 0;
            estoque.forEach(e=>{
              if(!aggregator[e.alocacao]) aggregator[e.alocacao] = { items: [] };
              aggregator[e.alocacao].items.push(e);
            });
            let html = `<h2>Central de Custo - Itens em Estoque</h2>`;
            for(let loja in aggregator){
              let items = aggregator[loja].items;
              html += `<h3>Loja: ${loja}</h3>`;
              if(items.length === 0){
                html += `<p>Sem itens.</p>`;
                continue;
              }
              html += `<table>
                <thead>
                  <tr>
                    <th>Modelo</th>
                    <th>Plano</th>
                    <th>Categoria</th>
                    <th>Cadastro</th>
                    <th>Status</th>
                    <th>Quantidade</th>
                  </tr>
                </thead>
                <tbody>`;
              const subAgg = {};
              items.forEach(i=>{
                let key = `${i.modelo}|${i.plano}|${i.categoria}|${i.cadastro}|${i.status}`;
                if(!subAgg[key]) subAgg[key] = { count: 0, somaCusto: 0, somaVenda: 0 };
                subAgg[key].count++;
                subAgg[key].somaCusto += (i.custo || 0);
                subAgg[key].somaVenda += (i.venda || 0);
              });
              for(let k in subAgg){
                let [md, pl, cat, cad, st] = k.split("|");
                let count = subAgg[k].count;
                let scusto = subAgg[k].somaCusto;
                let svenda = subAgg[k].somaVenda;
                totalCusto += scusto;
                totalVenda += svenda;
                html += `<tr>
                  <td>${md}</td>
                  <td>${pl}</td>
                  <td>${cat}</td>
                  <td>${cad}</td>
                  <td>${st}</td>
                  <td>${count}</td>
                </tr>`;
              }
              html += `</tbody></table>`;
            }
            let totalLiquido = totalVenda - totalCusto;
            html +=
              `<hr/>
               <h3>Total de Custo: R$ ${totalCusto.toFixed(2)}</h3>
               <h3>Total de Venda (Bruto): R$ ${totalVenda.toFixed(2)}</h3>
               <h3>Total Líquido: R$ ${totalLiquido.toFixed(2)}</h3>
               <label style="display:block;text-align:center;margin-top:10px;">
  <input type="checkbox" id="central-custo-toggle-model" style="margin-right:6px;">
  Exibir pizza por Modelos
</label>
<div style="max-width:500px;margin:20px auto;"><canvas id="central-custo-chart"></canvas></div>
               <br/>`;
            html += `<br/><button id="fechar-central-custo" type="button" class="central-btn central-custo-btn">Fechar</button>`;
            
  contentDiv.innerHTML = html;

  
  
  
  
  // === PIE CHART Central de Custo ===
  function rebuildCentralCustoChart(){
    const toggle = document.getElementById('central-custo-toggle-model');
    const byModel = toggle && toggle.checked;

    let labels = [];
    let counts = [];

    if(byModel){
      // Agrupa por Modelo - Categoria
      const map = {};
      estoque.forEach(e=>{
        const key = e.modelo + " - " + e.categoria;
        map[key] = (map[key]||0)+1;
      });
      labels = Object.keys(map);
      counts = labels.map(l=>map[l]);
    } else {
      // Agrupa por Status/Cadastro conforme regras
      let reservadas=0,bad=0,cpfPE=0,cnpjPE=0,cnpjTNM=0;
      estoque.forEach(e=>{
        const status=(e.status||"").toUpperCase();
        const cat=(e.categoria||"").toUpperCase();
        const cad=(e.cadastro||"").toUpperCase();

        if(status==="RESERVADO"){ reservadas++; return; }
        if(status==="BAD"){ bad++; return; }

        if(cat==="PRONTA ENTREGA"){
          if(cad.startsWith("CPF")) cpfPE++;
          else if(cad.startsWith("CNPJ")) cnpjPE++;
        } else if(cat==="TON NA MÃO"){
          if(cad.startsWith("CNPJ")) cnpjTNM++;
        }
      });
      function add(label,c){ if(c>0){ labels.push(label); counts.push(c);} }
      add("Reservadas", reservadas);
      add("BAD", bad);
      add("CPF • Pronta Entrega", cpfPE);
      add("CNPJ • Pronta Entrega", cnpjPE);
      add("CNPJ • Ton Na Mão", cnpjTNM);
    }

    const total = counts.reduce((a,b)=>a+b,0)||1;

    const bgColors = labels.map((_,i)=>`hsl(${Math.floor((360/labels.length)*i)},70%,60%)`);

    const ctx = document.getElementById('central-custo-chart');
    if(!ctx) return;

    if(window.centralCustoChart){ window.centralCustoChart.destroy(); }

    window.centralCustoChart = new Chart(ctx,{
      type:'pie',
      data:{ labels:labels, datasets:[{ data:counts, backgroundColor:bgColors }]},
      options:{
        responsive:true,
        plugins:{
          tooltip:{ callbacks:{ label:(context)=>{
            const i=context.dataIndex; const pct=((counts[i]/total)*100).toFixed(2)+'%';
            return `${labels[i]}: ${counts[i]} (${pct})`;
          }}},
          legend:{ position:'bottom' },
          title:{ display:true, text: byModel ? 'Distribuição por Modelo/Categoria' : 'Distribuição por Cadastro/Status' }
        }
      }
    });
  }

  // Aciona construção inicial e adiciona listener ao toggle
  function initCentralCustoChart(){
    const toggle = document.getElementById('central-custo-toggle-model');
    if(toggle){ toggle.addEventListener('change', rebuildCentralCustoChart); }
    rebuildCentralCustoChart();
  }

  if(typeof Chart==='undefined'){
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/chart.js';
    s.onload=initCentralCustoChart;
    document.head.appendChild(s);
  } else {
    initCentralCustoChart();
  }





            document.getElementById('fechar-central-custo').addEventListener('click', ()=>{
              modalCentralCusto.classList.add('hidden');
            });
            modalCentralCusto.classList.remove('hidden');
          }


          // Detalhes por Loja
          const btnDetalhesLojas = document.getElementById('btn-detalhes-lojas');
          const modalDetalhesLojas = document.getElementById('modal-detalhes-lojas');
          const detalhesLojaContent = document.getElementById('detalhes-lojas-content');
          const fecharDetalhesLojaBtn = document.getElementById('fechar-detalhes-lojas');
          btnDetalhesLojas.addEventListener('click', ()=>{
            exibirDetalhesPorLoja();
            modalDetalhesLojas.classList.remove('hidden');
          });
          if(fecharDetalhesLojaBtn){
            fecharDetalhesLojaBtn.addEventListener('click', ()=>{
              modalDetalhesLojas.classList.add('hidden');
            });
          }
          function exibirDetalhesPorLoja(){
            let lojas = [...new Set(estoque.map(item => item.alocacao))];
            lojas.sort();
            let filterHtml = `<label>Filtrar por Loja: </label>
                              <select id="filtro-loja">
                                <option value="">Todos</option>`;
            lojas.forEach(loja => {
              filterHtml += `<option value="${loja}">${loja}</option>`;
            });
            filterHtml += `</select>
                           <button id="aplicar-filtro-loja" type="button" class="central-btn">Filtrar</button>`;
            let summary = [];
            estoque.forEach(item => {
              let key = item.alocacao + "|" + item.modelo + "|" + item.plano + "|" + item.categoria + "|" + item.cadastro;
              let existing = summary.find(row => row.key === key);
              if(existing) {
                existing.count++;
              } else {
                summary.push({
                  key: key,
                  loja: item.alocacao,
                  modelo: item.modelo,
                  plano: item.plano,
                  categoria: item.categoria,
                  cadastro: item.cadastro,
                  count: 1
                });
              }
            });
            function renderSummary(filterLoja) {
              let filtered = summary;
              if(filterLoja) {
                filtered = summary.filter(row => row.loja === filterLoja);
              }
              let tableHtml = `<table>
                                 <thead>
                                   <tr>
                                     <th>Quantidade</th>
                                     <th>Loja</th>
                                     <th>Modelo</th>
                                     <th>Plano</th>
                                     <th>Categoria</th>
                                     <th>Cadastro</th>
                                   </tr>
                                 </thead>
                                 <tbody>`;
              if(filtered.length === 0) {
                tableHtml += `<tr><td colspan="6" style="text-align:center;">Nenhum registro encontrado.</td></tr>`;
              } else {
                filtered.forEach(row => {
                  tableHtml += `<tr>
                                  <td>${row.count}</td>
                                  <td>${row.loja}</td>
                                  <td>${row.modelo}</td>
                                  <td>${row.plano}</td>
                                  <td>${row.categoria}</td>
                                  <td>${row.cadastro}</td>
                                </tr>`;
                });
              }
              tableHtml += `</tbody></table>`;
              return tableHtml;
            }
            let html = `<h2>Resumo por Loja</h2>`;
            html += filterHtml;
            html += renderSummary("");
            detalhesLojaContent.innerHTML = html;
            document.getElementById('aplicar-filtro-loja').addEventListener('click', () => {
              let filtro = document.getElementById('filtro-loja').value;
              detalhesLojaContent.innerHTML = filterHtml + renderSummary(filtro);
              document.getElementById('aplicar-filtro-loja').addEventListener('click', () => {
                let filtro2 = document.getElementById('filtro-loja').value;
                detalhesLojaContent.innerHTML = filterHtml + renderSummary(filtro2);
              });
            });
          }


          // Logs
          const btnConsultarLogs = document.getElementById('btn-consultar-logs');
          btnConsultarLogs.addEventListener('click', (e)=>{
            e.stopPropagation();
            atualizarLogs();
            document.getElementById('modal-logs').classList.remove('hidden');
          });
          var fecharModalLogs = document.getElementById('fechar-modal-logs');
          if(fecharModalLogs){
            fecharModalLogs.addEventListener('click', ()=>{
              document.getElementById('modal-logs').classList.add('hidden');
            });
          }


          // Backup
          const btnBackupDados = document.getElementById('btn-backup-dados');
          const modalBackup = document.getElementById('modal-backup');
          var fecharModalBackupBtn = document.getElementById('fechar-modal-backup');
          const backupExportBtn = document.getElementById('backup-export-btn');
          const fileInputBackup = document.getElementById('file-input-backup');


          btnBackupDados.addEventListener('click', ()=>{
            const configAtual = JSON.parse(localStorage.getItem('systemConfig')) || {};
            showPrompt("Senha para Backup/Upload:", "", function(s){
              if(s.trim() !== configAtual.backupPassword.trim()){
                showAlert("Senha incorreta!");
                return;
              }
              modalBackup.classList.remove('hidden');
            });
          });
          if(fecharModalBackupBtn){
            fecharModalBackupBtn.addEventListener('click', ()=>{
              modalBackup.classList.add('hidden');
            });
          }
          backupExportBtn.addEventListener('click', async ()=>{
            try {
              let systemConfig = JSON.parse(localStorage.getItem('systemConfig')) || {};
        if (!systemConfig.bonusMode) {
          systemConfig.bonusMode = "porConsultor";
        }
              let estoqueData = JSON.parse(localStorage.getItem('estoque')) || [];
              let historicoData = JSON.parse(localStorage.getItem('historico')) || [];
              let chipsCount = JSON.parse(localStorage.getItem('chipsCount')) || {};
              let chipsDateLastUpdate = JSON.parse(localStorage.getItem('chipsDateLastUpdate')) || {};
              let valores = JSON.parse(localStorage.getItem('valores')) || {};


              const now = new Date();
              const dd = String(now.getDate()).padStart(2, '0');
              const mm = String(now.getMonth()+1).padStart(2, '0');
              const yy = String(now.getFullYear()).slice(-2);
              const userName = (systemConfig.username || "usuario").toLowerCase();
              const fileName = `backup.${userName}.${dd}.${mm}.${yy}.json`;


              const backupObj = {
                estoque: estoqueData,
                historico: historicoData,
                chipsCount,
                chipsDateLastUpdate,
                systemConfig,
                valores
              };
              const backupStr = JSON.stringify(backupObj, null, 2);


              if(!window.showDirectoryPicker){
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(backupStr);
                const a = document.createElement('a');
                a.setAttribute('href', dataStr);
                a.setAttribute('download', fileName);
                document.body.appendChild(a);
                a.click();
                a.remove();
                showAlert(`Backup gerado (download normal). Nome do arquivo: ${fileName}`);
              } else {
                const folderHandle = await window.showDirectoryPicker();
                if(!folderHandle){
                  showAlert("Seleção de pasta cancelada ou não suportada!");
                  return;
                }
                const newFileHandle = await folderHandle.getFileHandle(fileName, { create: true });
                const writable = await newFileHandle.createWritable();
                await writable.write(backupStr);
                await writable.close();
                showAlert(`Backup gerado dentro da pasta escolhida! Arquivo: ${fileName}`);
              }
            } catch(e){
              console.error("Erro ao exportar backup:", e);
              showAlert("Ocorreu um erro ao gerar o backup.");
            }
          });
          fileInputBackup.addEventListener('change', (e)=>{
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt)=>{
              try{
                const jsonData = JSON.parse(evt.target.result);
                // Validação da estrutura do backup
                if(jsonData.estoque && jsonData.historico && jsonData.chipsCount && jsonData.chipsDateLastUpdate && jsonData.systemConfig){
                  estoque = jsonData.estoque.filter(item => !jsonData.historico.some(h => h.serial === item.serial));
                  historico = jsonData.historico;
                  chipsCount = jsonData.chipsCount;
                  chipsDateLastUpdate = jsonData.chipsDateLastUpdate;
                  systemConfig = jsonData.systemConfig;
                  valores = jsonData.valores || {};
                  corrigirValoresEstoque();
                  localStorage.setItem('estoque', JSON.stringify(estoque));
                  localStorage.setItem('historico', JSON.stringify(historico));
                  localStorage.setItem('chipsCount', JSON.stringify(chipsCount));
                  localStorage.setItem('chipsDateLastUpdate', JSON.stringify(chipsDateLastUpdate));
                  localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                  localStorage.setItem('valores', JSON.stringify(valores));
                  showAlert("Backup restaurado com sucesso!");
                  inicializarCombos();
                  popularModelFilters();
                  atualizarTabelaChipsDetalhado();
                  atualizarHistorico();
                  atualizarTabelaPronta();
                  atualizarTabelaTon();
                } else {
                  showAlert("Arquivo de backup inválido!");
                }
              } catch{
                showAlert("Erro ao processar o arquivo!");
              }
            };
            reader.readAsText(file);
          });


          // Central do Cadastro
          const btnCentralCadastro = document.getElementById('btn-central-cadastro');
          const modalUsuario = document.getElementById('modal-usuario');
          var fecharModalUsuarioBtn = document.getElementById('fechar-modal-usuario');
          const salvarConfigBtn = document.getElementById('salvar-config');
          const systemUsernameInput = document.getElementById('system-username');
          btnCentralCadastro.addEventListener('click', ()=>{
            systemUsernameInput.value = systemConfig.username;
            modalUsuario.classList.remove('hidden');
          });
          if(fecharModalUsuarioBtn){
            fecharModalUsuarioBtn.addEventListener('click', ()=>{
              modalUsuario.classList.add('hidden');
            });
          }
          salvarConfigBtn.addEventListener('click', ()=>{
            systemConfig.username = systemUsernameInput.value;
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            document.getElementById('btn-user-info').textContent = `Usuário: ${systemConfig.username}`;
            inicializarCombos();
            showAlert("Configurações salvas!");
          });


          // Abas de gerenciar cadastros, planos, etc...
          document.getElementById('abrir-modal-cadastros').addEventListener('click', () => {
            atualizarListaCadastros();
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-cadastros').classList.remove('hidden');
          });
          document.getElementById('abrir-modal-planos').addEventListener('click', () => {
            atualizarListaPlanos();
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-planos').classList.remove('hidden');
          });
          document.getElementById('abrir-modal-modelos').addEventListener('click', () => {
            atualizarListaModelos();
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-modelos').classList.remove('hidden');
          });
          document.getElementById('abrir-modal-lojas').addEventListener('click', () => {
            atualizarListaLojas();
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-lojas').classList.remove('hidden');
          });
          document.getElementById('abrir-modal-usuarios').addEventListener('click', () => {
            if(loggedInUser && loggedInUser.nivel !== 1){
              showAlert("Você não tem permissão de acesso.");
              registrarLog("Acesso Indevido", "Requerido acesso nível 1 para Gerenciar Usuários");
              return;
            }
            atualizarListaUsuarios();
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-usuarios').classList.remove('hidden');
          });
          document.getElementById('abrir-modal-gerenciador-valores').addEventListener('click', () => {
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-gerenciador-valores').classList.remove('hidden');
            atualizarTabelaGerenciadorValores();
          });
          document.getElementById('abrir-modal-consultores').addEventListener('click', () => {
            atualizarListaConsultores();
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-consultores').classList.remove('hidden');
          });
          document.getElementById('plugin-central-senhas').addEventListener('click', () => {
            modalUsuario.classList.add('hidden');
            document.getElementById('modal-central-senhas').classList.remove('hidden');
          });
          document.getElementById('abrir-edicao-lote').addEventListener('click', () => {
            modalUsuario.classList.add('hidden');
            popularNovoPlanoLote();
            gerarListaGruposEdicaoLote();
            document.getElementById('modal-edicao-lote').classList.remove('hidden');
          });
          document.getElementById('abrir-edicao-lojas').addEventListener('click', () => {
            modalUsuario.classList.add('hidden');
            popularNovaLojaLote();
            gerarListaGruposEdicaoLojas();
            document.getElementById('modal-edicao-lojas').classList.remove('hidden');
          });


          const fecharModalCadastros = document.getElementById('fechar-modal-cadastros');
          if(fecharModalCadastros){
            fecharModalCadastros.addEventListener('click', ()=>{
              document.getElementById('modal-cadastros').classList.add('hidden');
            });
          }
          const fecharModalPlanos = document.getElementById('fechar-modal-planos');
          if(fecharModalPlanos){
            fecharModalPlanos.addEventListener('click', ()=>{
              document.getElementById('modal-planos').classList.add('hidden');
            });
          }
          const fecharModalModelos = document.getElementById('fechar-modal-modelos');
          if(fecharModalModelos){
            fecharModalModelos.addEventListener('click', ()=>{
              document.getElementById('modal-modelos').classList.add('hidden');
            });
          }
          const fecharModalLojas = document.getElementById('fechar-modal-lojas');
          if(fecharModalLojas){
            fecharModalLojas.addEventListener('click', ()=>{
              document.getElementById('modal-lojas').classList.add('hidden');
            });
          }
          const fecharModalUsuarios = document.getElementById('fechar-modal-usuarios');
          if(fecharModalUsuarios){
            fecharModalUsuarios.addEventListener('click', ()=>{
              document.getElementById('modal-usuarios').classList.add('hidden');
            });
          }
          const fecharModalConsultores = document.getElementById('fechar-modal-consultores');
          if(fecharModalConsultores){
            fecharModalConsultores.addEventListener('click', ()=>{
              document.getElementById('modal-consultores').classList.add('hidden');
            });
          }
          const fecharModalGerenciadorValores = document.getElementById('fechar-modal-gerenciador-valores');
          if(fecharModalGerenciadorValores){
            fecharModalGerenciadorValores.addEventListener('click', ()=>{
              document.getElementById('modal-gerenciador-valores').classList.add('hidden');
            });
          }
          const fecharModalEdicaoLoteBtn = document.getElementById('fechar-modal-edicao-lote');
          if(fecharModalEdicaoLoteBtn){
            fecharModalEdicaoLoteBtn.addEventListener('click', ()=>{
              document.getElementById('modal-edicao-lote').classList.add('hidden');
            });
          }
          const fecharModalEdicaoLojasBtn = document.getElementById('fechar-modal-edicao-lojas');
          if(fecharModalEdicaoLojasBtn){
            fecharModalEdicaoLojasBtn.addEventListener('click', ()=>{
              document.getElementById('modal-edicao-lojas').classList.add('hidden');
            });
          }
          const fecharModalCentralSenhas = document.getElementById('fechar-modal-central-senhas');
          if(fecharModalCentralSenhas){
            fecharModalCentralSenhas.addEventListener('click', ()=>{
              document.getElementById('modal-central-senhas').classList.add('hidden');
            });
          }


          function atualizarListaCadastros(){
            const div = document.getElementById('lista-cadastros');
            div.innerHTML = "";
            systemConfig.cadastros.forEach((cad, idx)=>{
              const p = document.createElement('p');
              p.textContent = cad;
              const btnRem = document.createElement('button');
              btnRem.textContent = "Remover";
              btnRem.style.marginLeft = "10px";
              btnRem.addEventListener('click', ()=>{
                systemConfig.cadastros.splice(idx,1);
                localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                atualizarListaCadastros();
                inicializarCombos();
              });
              p.appendChild(btnRem);
              div.appendChild(p);
            });
          }
          document.getElementById('adicionar-cadastro').addEventListener('click', ()=>{
            const val = document.getElementById('novo-cadastro').value.trim();
            if(!val) return;
            systemConfig.cadastros.push(val);
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            document.getElementById('novo-cadastro').value = "";
            atualizarListaCadastros();
            inicializarCombos();
          });


          function atualizarListaPlanos(){
            const div = document.getElementById('lista-planos');
            div.innerHTML = "";
            systemConfig.planos.forEach((plan, idx)=>{
              const p = document.createElement('p');
              p.textContent = plan;
              const btnRem = document.createElement('button');
              btnRem.textContent = "Remover";
              btnRem.style.marginLeft = "10px";
              btnRem.addEventListener('click', ()=>{
                systemConfig.planos.splice(idx,1);
                localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                atualizarListaPlanos();
                inicializarCombos();
              });
              p.appendChild(btnRem);
              div.appendChild(p);
            });
          }
          document.getElementById('adicionar-plano').addEventListener('click', ()=>{
            const val = document.getElementById('novo-plano').value.trim();
            if(!val) return;
            systemConfig.planos.push(val);
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            document.getElementById('novo-plano').value = "";
            atualizarListaPlanos();
            inicializarCombos();
          });


          function atualizarListaModelos(){
            const div = document.getElementById('lista-modelos');
            div.innerHTML = "";
            systemConfig.modelos.forEach((mod, idx)=>{
              const p = document.createElement('p');
              p.textContent = mod;
              const btnRem = document.createElement('button');
              btnRem.textContent = "Remover";
              btnRem.style.marginLeft = "10px";
              btnRem.addEventListener('click', ()=>{
                systemConfig.modelos.splice(idx,1);
                localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                atualizarListaModelos();
                inicializarCombos();
              });
              p.appendChild(btnRem);
              div.appendChild(p);
            });
          }
          document.getElementById('adicionar-modelo').addEventListener('click', ()=>{
            const val = document.getElementById('novo-modelo').value.trim();
            if(!val) return;
            systemConfig.modelos.push(val);
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            document.getElementById('novo-modelo').value = "";
            atualizarListaModelos();
            inicializarCombos();
          });


          function atualizarListaLojas(){
            const div = document.getElementById('lista-lojas');
            div.innerHTML = "";
            systemConfig.alocacoes.forEach((loj, idx)=>{
              const p = document.createElement('p');
              p.textContent = loj;
              const btnRem = document.createElement('button');
              btnRem.textContent = "Remover";
              btnRem.style.marginLeft = "10px";
              btnRem.addEventListener('click', ()=>{
                systemConfig.alocacoes.splice(idx,1);
                localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                atualizarListaLojas();
                inicializarCombos();
              });
              p.appendChild(btnRem);
              div.appendChild(p);
            });
          }
          document.getElementById('adicionar-loja').addEventListener('click', ()=>{
            const val = document.getElementById('nova-loja').value.trim();
            if(!val) return;
            systemConfig.alocacoes.push(val);
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            document.getElementById('nova-loja').value = "";
            atualizarListaLojas();
            inicializarCombos();
          });


          function atualizarListaUsuarios(){
            const div = document.getElementById('lista-usuarios');
            div.innerHTML = "";
            systemConfig.users.forEach((usr, idx)=>{
              const p = document.createElement('p');
              p.textContent = `Usuário: ${usr.name}, Nível: ${usr.nivel}`;
              if(usr.name.toLowerCase() !== 'sistema'){
                const btnRem = document.createElement('button');
                btnRem.textContent = "Remover";
                btnRem.style.marginLeft = "10px";
                btnRem.addEventListener('click', ()=>{
                  systemConfig.users.splice(idx,1);
                  localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                  atualizarListaUsuarios();
                });
                p.appendChild(btnRem);
              }
              div.appendChild(p);
            });
          }
          document.getElementById('adicionar-usuario').addEventListener('click', ()=>{
            const nome = document.getElementById('novo-usuario').value.trim();
            const pass = document.getElementById('nova-senha').value;
            const nv = document.getElementById('novo-usuario-nivel').value;
            if(!nome || !pass){
              showAlert("Informe usuário e senha!");
              return;
            }
            systemConfig.users.push({
              name: nome,
              password: pass,
              createDate: new Date().toLocaleDateString(),
              nivel: parseInt(nv,10)
            });
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            document.getElementById('novo-usuario').value = "";
            document.getElementById('nova-senha').value = "";
            atualizarListaUsuarios();
          });


          // CONSULTORES (inclui edição de loja)
          function atualizarListaConsultores(){
            const lista = document.getElementById('lista-consultores');
            lista.innerHTML = "";
            systemConfig.consultores.forEach((cons, index)=>{
              const div = document.createElement('div');
              div.style.borderBottom = "1px solid #ccc";
              div.style.padding = "5px";
              let bonusText = "";
              if(cons.bonusType === "upton") bonusText = "UPTON (R$150)";
              else if(cons.bonusType === "comum") bonusText = "COMUM (R$100)";
              else if(cons.bonusType === "sem") bonusText = "SEM BONUS";
              else bonusText = cons.bonusType;
              div.innerHTML = `${cons.name} - ${cons.loja} (${cons.comissao}%) | Bônus: ${bonusText}`;


              // Botão Remover
              const btnRemover = document.createElement('button');
              btnRemover.textContent = "Remover";
              btnRemover.classList.add("central-btn");
              btnRemover.style.marginLeft = "10px";
              btnRemover.addEventListener('click', ()=>{
                systemConfig.consultores.splice(index,1);
                localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                atualizarListaConsultores();
              });
              div.appendChild(btnRemover);


              // Botão Editar Bônus
              const btnEditarBonus = document.createElement('button');
              btnEditarBonus.textContent = "Editar Bônus";
              btnEditarBonus.classList.add("central-btn");
              btnEditarBonus.style.marginLeft = "10px";
              btnEditarBonus.addEventListener('click', ()=>{
                showSelectPrompt("Tipo de bônus do mês:", [
                  { value: "comum", text: "COMUM (R$100)" },
                  { value: "upton", text: "UPTON (R$150)" },
                  { value: "sem", text: "SEM BONUS" }
                ], cons.bonusType, function(newBonus){
                  if(newBonus !== null){
                    cons.bonusType = newBonus;
                    localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                    atualizarListaConsultores();
                  }
                });
              });
              div.appendChild(btnEditarBonus);


              // Botão Editar Loja
              const btnEditarLoja = document.createElement('button');
              btnEditarLoja.textContent = "Editar Loja";
              btnEditarLoja.classList.add("central-btn");
              btnEditarLoja.style.marginLeft = "10px";
              btnEditarLoja.addEventListener('click', ()=>{
                const lojasOpts = systemConfig.alocacoes.map(l => ({ value: l, text: l }));
                showSelectPrompt(`Escolha a nova loja para ${cons.name}:`, lojasOpts, cons.loja, function(novaLoja){
                  if(novaLoja !== null){
                    cons.loja = novaLoja;
                    localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
                    atualizarListaConsultores();
                    registrarLog("Editar Loja Consultor", `Consultor: ${cons.name}, Nova Loja: ${novaLoja}`);
                  }
                });
              });
              div.appendChild(btnEditarLoja);


              lista.appendChild(div);
            });
          }
          document.getElementById('adicionar-consultor').addEventListener('click', ()=>{
            const nome = document.getElementById('novo-consultor-nome').value.trim();
            const loja = document.getElementById('novo-consultor-loja').value.trim();
            const comissao = document.getElementById('novo-consultor-comissao').value.trim();
            const bonusType = document.getElementById('novo-consultor-bonus').value;
            if(nome === "" || loja === "" || comissao === ""){
              showAlert("Informe o nome, a loja e a comissão do novo consultor!");
              return;
            }
            systemConfig.consultores.push({
              name: nome,
              loja: loja,
              comissao: parseFloat(comissao),
              bonusType: bonusType
            });
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            atualizarListaConsultores();
            document.getElementById('novo-consultor-nome').value = "";
            document.getElementById('novo-consultor-loja').value = "";
            document.getElementById('novo-consultor-comissao').value = "";
          });


          // =================== NOVA MATRIZ DE COMISSÕES TNM (POR NÍVEL) ===================
          const TnmCommissionMatrix = {
            "Super": {
              "T1": {
                "Iniciantes": 5, "Especialista I": 5, "Especialista II e III": 5, "Referência e Embaixador": 5
              },
              "T2": {
                "Iniciantes": 40, "Especialista I": 40, "Especialista II e III": 50, "Referência e Embaixador": 60
              },
              "T3": {
                "Iniciantes": 90, "Especialista I": 100, "Especialista II e III": 100, "Referência e Embaixador": 110
              },
              "T3 SMART": {
                "Iniciantes": 110, "Especialista I": 110, "Especialista II e III": 120, "Referência e Embaixador": 130
              }
            },
            "Mega": {
              "T1": {
                "Iniciantes": 40, "Especialista I": 50, "Especialista II e III": 60, "Referência e Embaixador": 75
              },
              "T2": {
                "Iniciantes": 70, "Especialista I": 90, "Especialista II e III": 110, "Referência e Embaixador": 120
              },
              "T3": {
                "Iniciantes": 150, "Especialista I": 180, "Especialista II e III": 210, "Referência e Embaixador": 220
              },
              "T3 SMART": {
                "Iniciantes": 180, "Especialista I": 200, "Especialista II e III": 220, "Referência e Embaixador": 230
              }
            },
            "Pro": {
              "T1": {
                "Iniciantes": 60, "Especialista I": 70, "Especialista II e III": 90, "Referência e Embaixador": 100
              },
              "T2": {
                "Iniciantes": 90, "Especialista I": 110, "Especialista II e III": 130, "Referência e Embaixador": 140
              },
              "T3": {
                "Iniciantes": 200, "Especialista I": 270, "Especialista II e III": 310, "Referência e Embaixador": 320
              },
              "T3 SMART": {
                "Iniciantes": 250, "Especialista I": 300, "Especialista II e III": 330, "Referência e Embaixador": 340
              }
            },
            "Ton Pro MEI e PJ": {
              "T3": {
                "Iniciantes": 170, "Especialista I": 190, "Especialista II e III": 200, "Referência e Embaixador": 200
              },
              "T3 SMART": {
                "Iniciantes": 190, "Especialista I": 200, "Especialista II e III": 220, "Referência e Embaixador": 220
              }
            },
            "Turbo": {
              "T1": {
                "Iniciantes": 0, "Especialista I": 70, "Especialista II e III": 90, "Referência e Embaixador": 100
              },
              "T2": {
                "Iniciantes": 0, "Especialista I": 110, "Especialista II e III": 130, "Referência e Embaixador": 140
              },
              "T3": {
                "Iniciantes": 0, "Especialista I": 270, "Especialista II e III": 310, "Referência e Embaixador": 320
              },
              "T3 SMART": {
                "Iniciantes": 0, "Especialista I": 300, "Especialista II e III": 330, "Referência e Embaixador": 340
              }
            }
          };


          function atualizarTabelaGerenciadorValores() {
            const div = document.getElementById("tabela-gerenciador-valores");
            let html = `<table id="table-gerenciador-valores">
              <thead>
                <tr>
                  <th>Modelo</th>
                  <th>Plano</th>
                  <th>Custo</th>
                  <th>Venda</th>
                  <th>TNM Comissão</th>
                </tr>
              </thead>
              <tbody>`;
            systemConfig.modelos.forEach(modelo => {
              systemConfig.planos.forEach(plano => {
                let custo = 0, venda = 0, tnm = 0;
                if (valores[modelo] && valores[modelo][plano]) {
                  custo = valores[modelo][plano].custo || 0;
                  venda = valores[modelo][plano].venda || 0;
                  tnm = valores[modelo][plano].tnmComissao || 0;
                }
                html += `<tr>
                  <td><input type="text" value="${modelo}" class="gv-modelo" readonly></td>
                  <td><input type="text" value="${plano}" class="gv-plano" readonly></td>
                  <td><input type="number" step="0.01" value="${custo}" class="gv-custo"></td>
                  <td><input type="number" step="0.01" value="${venda}" class="gv-venda"></td>
                  <td><input type="number" step="0.01" value="${tnm}" class="gv-tnm"></td>
                </tr>`;
              });
            });
            html += `</tbody></table>`;
            div.innerHTML = html;
          }


          document.getElementById("salvar-gerenciador-valores").addEventListener("click", () => {
            const rows = document.querySelectorAll("#table-gerenciador-valores tbody tr");
            let newValores = {};
            rows.forEach(row => {
              const modelo = row.querySelector("input.gv-modelo").value.trim();
              const plano = row.querySelector("input.gv-plano").value.trim();
              const custo = parseFloat(row.querySelector("input.gv-custo").value) || 0;
              const venda = parseFloat(row.querySelector("input.gv-venda").value) || 0;
              const tnm = parseFloat(row.querySelector("input.gv-tnm").value) || 0;
              if (modelo && plano) {
                if (!newValores[modelo]) newValores[modelo] = {};
                newValores[modelo][plano] = { custo: custo, venda: venda, tnmComissao: tnm };
              }
            });
            valores = newValores;
            localStorage.setItem("valores", JSON.stringify(valores));
            showAlert("Valores salvos com sucesso!");
            registrarLog("Gerenciar Valores", "Valores atualizados");
            atualizarTabelaGerenciadorValores();
          });


          document.getElementById("copiar-gerenciador-valores").addEventListener("click", function(){
            try {
              const json = JSON.stringify(valores, null, 2);
              navigator.clipboard.writeText(json).then(() => {
                showAlert("Valores copiados para a área de transferência!");
              }).catch(err => {
                showAlert("Erro ao copiar valores: " + err);
              });
            } catch(e) {
              showAlert("Erro ao copiar valores: " + e);
            }
          });


          document.getElementById("colar-gerenciador-valores").addEventListener("click", function(){
            showPrompt("Cole os valores em formato JSON:", "", function(text){
              if(text !== null && text.trim() !== ""){
                try {
                  const newValores = JSON.parse(text);
                  valores = newValores;
                  localStorage.setItem("valores", JSON.stringify(valores));
                  atualizarTabelaGerenciadorValores();
                  showAlert("Valores colados com sucesso!");
                } catch(e){
                  showAlert("Erro ao colar valores. Verifique o formato JSON.");
                }
              }
            }, true);
          });


          const consultorLevelSelect = document.getElementById("consultor-level-select");
          consultorLevelSelect.addEventListener("change", function(){
            const level = this.value;
            if(!level) return;
            const rows = document.querySelectorAll("#table-gerenciador-valores tbody tr");
            rows.forEach(row => {
              const modelo = row.querySelector("input.gv-modelo").value.trim();
              const plano = row.querySelector("input.gv-plano").value.trim();
              let tnmField = row.querySelector("input.gv-tnm");
              if(!TnmCommissionMatrix[plano] || !TnmCommissionMatrix[plano][modelo]){
                tnmField.value = 0;
                return;
              }
              let valMatrix = TnmCommissionMatrix[plano][modelo][level];
              if(valMatrix === undefined || valMatrix === null){
                tnmField.value = 0;
              } else {
                tnmField.value = valMatrix;
              }
            });
          });


          function gerarGruposEdicaoLote() {
            const grupos = {};
            estoque.forEach(item => {
              const tipoCad = extrairTipoCadastro(item.cadastro);
              const chave = `${item.modelo}|${item.plano}|${item.categoria}|${tipoCad}`;
              if (!grupos[chave]) {
                grupos[chave] = { modelo: item.modelo, planoAtual: item.plano, category: item.categoria, tipoCadastro: tipoCad, quantidade: 0 };
              }
              grupos[chave].quantidade++;
            });
            return grupos;
          }
          function popularNovoPlanoLote() {
            const sel = document.getElementById('novo-plano-lote');
            sel.innerHTML = "";
            systemConfig.planos.forEach(p => {
              let o = document.createElement('option');
              o.value = p;
              o.textContent = p;
              sel.appendChild(o);
            });
          }
          function gerarListaGruposEdicaoLote() {
            const tbody = document.getElementById('grupo-edicao-lote');
            tbody.innerHTML = "";
            const grupos = gerarGruposEdicaoLote();
            for (const chave in grupos) {
              const g = grupos[chave];
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${g.modelo}</td>
                              <td>${g.planoAtual}</td>
                              <td>${g.category}</td>
                              <td>${g.tipoCadastro}</td>
                              <td>${g.quantidade}</td>`;
              const tdAcao = document.createElement('td');
              const btn = document.createElement('button');
              btn.textContent = "Alterar";
              btn.className = "central-btn";
              btn.style.maxWidth = "150px";
              btn.addEventListener("click", function() {
                const novoPlano = document.getElementById('novo-plano-lote').value;
                if (novoPlano === g.planoAtual) {
                  showAlert("O novo plano deve ser diferente do atual.");
                  return;
                }
                showConfirm(`Você irá alterar ${g.quantidade} máquina(s), do plano ${g.planoAtual} para o plano ${novoPlano}. Deseja continuar?`, function(confirmado) {
                  if (confirmado) {
                    estoque = estoque.map(item => {
                      const tipoCad = extrairTipoCadastro(item.cadastro);
                      const chaveItem = item.modelo + "|" + item.plano + "|" + item.categoria + "|" + tipoCad;


                      if (chaveItem === chave) {
                        // IMPLEMENTAÇÃO #1
                        const novoItem = { ...item, plano: novoPlano };
                        const valRef = valores[item.modelo]?.[novoPlano];
                        if (valRef) {
                          if (novoItem.categoria === "Pronta Entrega") {
                            novoItem.custo = valRef.custo || 0;
                            novoItem.venda = valRef.venda || 0;
                          } else if (novoItem.categoria === "Ton Na Mão") {
                            novoItem.tnmComissao = valRef.tnmComissao || 0;
                          }
                        }
                        return novoItem;
                      }
                      return item;
                    });
                    localStorage.setItem("estoque", JSON.stringify(estoque));
                    showAlert("Edição em Lote realizada com sucesso!");
                    registrarLog("Edição em Lote", "Grupo " + chave + " atualizado para plano " + novoPlano);
                    popularModelFilters();
                    atualizarTabelaPronta();
                    atualizarTabelaTon();
                    gerarListaGruposEdicaoLote();
                  }
                });
              });
              tdAcao.appendChild(btn);
              tr.appendChild(tdAcao);
              tbody.appendChild(tr);
            }
          }


          function gerarGruposEdicaoLojas() {
            const grupos = {};
            estoque.forEach(item => {
              const lojaAtual = item.alocacao;
              if(!grupos[lojaAtual]) {
                grupos[lojaAtual] = { loja: lojaAtual, quantidade: 0 };
              }
              grupos[lojaAtual].quantidade++;
            });
            return grupos;
          }
          function popularNovaLojaLote(){
            const sel = document.getElementById('nova-loja-lote');
            sel.innerHTML = "";
            systemConfig.alocacoes.forEach(loja => {
              let o = document.createElement('option');
              o.value = loja;
              o.textContent = loja;
              sel.appendChild(o);
            });
          }
          function gerarListaGruposEdicaoLojas() {
            const tbody = document.getElementById('grupo-edicao-lojas');
            tbody.innerHTML = "";
            const grupos = gerarGruposEdicaoLojas();
            for (const lojaAtual in grupos) {
              const g = grupos[lojaAtual];
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${g.loja}</td>
                              <td>${g.quantidade}</td>`;
              const tdAcao = document.createElement('td');
              const btn = document.createElement('button');
              btn.textContent = "Alterar";
              btn.className = "central-btn";
              btn.style.maxWidth = "150px";
              btn.addEventListener("click", function() {
                const novaLoja = document.getElementById('nova-loja-lote').value;
                if(novaLoja === g.loja){
                  showAlert("A nova loja deve ser diferente da atual.");
                  return;
                }
                showConfirm(`Você irá alterar ${g.quantidade} máquina(s), da loja ${g.loja} para a loja ${novaLoja}. Deseja continuar?`, function(confirmado) {
                  if(confirmado){
                    estoque = estoque.map(item => {
                      if(item.alocacao === g.loja){
                        return {...item, alocacao: novaLoja};
                      }
                      return item;
                    });
                    localStorage.setItem('estoque', JSON.stringify(estoque));
                    showAlert("Edição em Lote realizada com sucesso!");
                    registrarLog("Edição em Lote", "Grupo de lojas " + g.loja + " atualizado para " + novaLoja);
                    popularModelFilters();
                    atualizarTabelaPronta();
                    atualizarTabelaTon();
                    gerarListaGruposEdicaoLojas();
                  }
                });
              });
              tdAcao.appendChild(btn);
              tr.appendChild(tdAcao);
              tbody.appendChild(tr);
            }
          }


          // Dashboard do Consultor
          const btnDashboardConsultor = document.getElementById('btn-dashboard-consultor');
          const modalDashboardConsultor = document.getElementById('modal-dashboard-consultor');
          const fecharDashboardConsultor = document.getElementById('fechar-dashboard-consultor');
          const dashConsultorSelect = document.getElementById('dash-consultor-select');
          const dashTabela = document.querySelector('#dash-tabela tbody');
          const dashTotalComissao = document.getElementById('dash-total-comissao');
          const dashTotalBonus = document.getElementById('dash-total-bonus');
          const dashTotalBonusLoja = document.getElementById('dash-total-bonus-loja');
          const dashSomaComissaoBonusLoja = document.getElementById('dash-soma-comissao-bonus-loja');
          const dashConsultorBonusList = document.getElementById('dash-consultor-bonus-list');
          const dashDataInicio = document.getElementById('dash-consultor-data-inicio');
          const dashDataFim = document.getElementById('dash-consultor-data-fim');
          const dashDataPersonalizadaDiv = document.getElementById('dash-data-personalizada');
          const dashTogglePersonalizado = document.getElementById('dash-toggle-personalizado');


          dashTogglePersonalizado.addEventListener('click', ()=>{
            dashDataPersonalizadaDiv.style.display = (dashDataPersonalizadaDiv.style.display==="none") ? "block" : "none";
          });
          btnDashboardConsultor.addEventListener('click', ()=>{
            dashConsultorSelect.innerHTML = `<option value="">Todos</option>`;
            systemConfig.consultores.forEach(cons=>{
              let opt = document.createElement('option');
              opt.value = cons.name;
              opt.textContent = `${cons.name} - ${cons.loja} (${cons.comissao}%)`;
              dashConsultorSelect.appendChild(opt);
            });
            dashDataInicio.value = "";
            dashDataFim.value = "";
            dashDataPersonalizadaDiv.style.display = "none";
            dashTabela.innerHTML = "";
            dashTotalComissao.textContent = "Total de Comissão: R$ 0,00";
            dashTotalBonus.textContent = "Bônus do Consultor: R$ 0,00";
            dashTotalBonusLoja.textContent = "Bônus da Loja: R$ 0,00";
            dashSomaComissaoBonusLoja.textContent = "Valor total = R$ 0,00";
            dashConsultorBonusList.innerHTML = "";
            const hoje = new Date();
            let dtStart = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 0,0,0);
            let dtEnd = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23,59,59);
            filtrarDashboardConsultor(dtStart, dtEnd, dashConsultorSelect.value);
            modalDashboardConsultor.classList.remove('hidden');
          });
          if(fecharDashboardConsultor){
            fecharDashboardConsultor.addEventListener('click', ()=>{
              modalDashboardConsultor.classList.add('hidden');
            });
          }
          document.getElementById('dash-hoje-btn').addEventListener('click', ()=>{
            const hoje = new Date();
            let dtStart = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 0,0,0);
            let dtEnd = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23,59,59);
            filtrarDashboardConsultor(dtStart, dtEnd, dashConsultorSelect.value);
          });
          document.getElementById('dash-ontem-btn').addEventListener('click', ()=>{
            const hoje = new Date();
            hoje.setDate(hoje.getDate() - 1);
            const yyyy = hoje.getFullYear();
            const mm = String(hoje.getMonth() + 1).padStart(2, '0');
            const dd = String(hoje.getDate()).padStart(2, '0');
            let dtStart = new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
            let dtEnd = new Date(`${yyyy}-${mm}-${dd}T23:59:59`);
            filtrarDashboardConsultor(dtStart, dtEnd, dashConsultorSelect.value);
          });
          document.getElementById('dash-esta-semana-btn').addEventListener('click', ()=>{
            const now = new Date();
            let day = now.getDay();
            let offset = day===0 ? 6 : (day-1);
            let dtStart = new Date(now);
            dtStart.setHours(0,0,0,0);
            dtStart.setDate(dtStart.getDate() - offset);
            let dtEnd = new Date(now);
            dtEnd.setHours(23,59,59,999);
            filtrarDashboardConsultor(dtStart, dtEnd, dashConsultorSelect.value);
          });
          document.getElementById('dash-semana-passada-btn').addEventListener('click', ()=>{
            const now = new Date();
            let day = now.getDay();
            let offset = day===0 ? 6 : (day-1);
            let dtEnd = new Date(now);
            dtEnd.setHours(23,59,59,999);
            dtEnd.setDate(dtEnd.getDate() - offset -1);
            let dtStart = new Date(dtEnd);
            dtStart.setHours(0,0,0,0);
            dtStart.setDate(dtStart.getDate()-6);
            filtrarDashboardConsultor(dtStart, dtEnd, dashConsultorSelect.value);
          });
          document.getElementById('dash-este-mes-btn').addEventListener('click', ()=>{
            const hoje = new Date();
            const yyyy = hoje.getFullYear();
            const mm = hoje.getMonth();
            let dtStart = new Date(yyyy, mm, 1, 0,0,0,0);
            let dtEnd = new Date(yyyy, mm, hoje.getDate(), 23,59,59,999);
            filtrarDashboardConsultor(dtStart, dtEnd, dashConsultorSelect.value);
          });
          document.getElementById('dash-filtrar-btn').addEventListener('click', ()=>{
            let di = dashDataInicio.value;
            let df = dashDataFim.value;
            if(!di || !df){
              showAlert("Selecione Data Início e Data Fim!");
              return;
            }
            let diBR = formatDateBR(di);
            let dfBR = formatDateBR(df);
            let dtStart = parseDateBR(diBR);
            let dtEnd = parseDateBR(dfBR);
            filtrarDashboardConsultor(dtStart, dtEnd, dashConsultorSelect.value);
          });


          function filtrarDashboardConsultor(dtStart, dtEnd, nomeConsultorSel){
            dashTabela.innerHTML = "";
            let totalCom = 0;
            let bonusCounters = {};


            const regFiltrados = historico.filter(h=>{
              if(h.origem === "BAIXADO POR DEVOLUÇÃO" || h.origem === "DEVOLUÇÃO BAD") return false;
              const responsavel = (h.consultor || h.vendedor || "").trim().toLowerCase();
              if(nomeConsultorSel && responsavel !== nomeConsultorSel.trim().toLowerCase()){
                return false;
              }
              let hDate = h.data.includes("/") ? parseDateBR(h.data) : new Date(h.data);
              if(!hDate) return false;
              return (hDate >= dtStart && hDate <= dtEnd);
            });
            if(regFiltrados.length === 0){
              let tr = document.createElement('tr');
              tr.innerHTML = `<td colspan="6" style="text-align:center;">Sem registros</td>`;
              dashTabela.appendChild(tr);
              dashTotalComissao.textContent = "Total de Comissão: R$ 0,00";
              dashTotalBonus.textContent = "Bônus do Consultor: R$ 0,00";
              dashTotalBonusLoja.textContent = "Bônus da Loja: R$ 0,00";
              dashSomaComissaoBonusLoja.textContent = "Valor total = R$ 0,00";
              dashConsultorBonusList.innerHTML = "";
              return;
            }
            regFiltrados.forEach(r=>{
              let tr = document.createElement('tr');
              const consultor = (r.consultor || r.vendedor || "").trim();
              let bonusApplicable = false;
              if(r.origem === "TNM" || r.origem === "AD LINK" || r.origem === "PE-1"){
                if(!(r.origem === "TNM" && normalizeModelo(r.modelo)==="T1")){
                  bonusApplicable = true;
                }
              }
              if((r.categoria || "").trim().toUpperCase() === "PRONTA ENTREGA"){ bonusApplicable = false; }
              let bonusTxt = bonusApplicable ? "Sim" : "Não";


              let highlightClass = "";
              if(bonusApplicable){
                bonusCounters[consultor] = (bonusCounters[consultor] || 0) + 1;
                if(bonusCounters[consultor] % 3 === 0){
                  highlightClass = "bonus-alcancado";
                }
              }


              tr.innerHTML = `
                <td>${r.data}</td>
                <td>${r.cliente || ""}</td>
                <td>${consultor}</td>
                <td>R$ ${r.valorVenda || "0.00"}</td>
                <td>R$ ${parseFloat(r.comissao).toFixed(2)}</td>
                <td class="${highlightClass}">${bonusTxt}</td>
              `;
              dashTabela.appendChild(tr);
              totalCom += parseFloat(r.comissao) || 0;
            });
            dashTotalComissao.textContent = `Total de Comissão: R$ ${totalCom.toFixed(2)}`;

  // Cálculo de comissões separadas
  let comissaoTNM = 0, comissaoPE = 0, comissaoADLINK = 0;

  regFiltrados.forEach(i => {
    const origem = (i.origem || "").toUpperCase();
    const tipo = (i.tipoBaixa || "").toLowerCase();
    const categoria = (i.categoria || "").toUpperCase();
    const comissao = parseFloat(i.comissao || 0);
    const venda = parseFloat(i.valorVenda || 0);
    const custo = parseFloat(i.custo || 0);

    if (origem === "TNM") comissaoTNM += comissao;
    if (tipo === "adlink") comissaoADLINK += comissao;
    if (origem.includes("PE") || categoria.includes("PRONTA ENTREGA")) {
      const comissaoPEcalc = venda - custo;
      if (comissaoPEcalc > 0) comissaoPE += comissaoPEcalc;
    }
  });

  // Atualiza DOM com as comissões por tipo
  document.getElementById('comissao-tnm').textContent = `COMISSÃO TNM: R$ ${comissaoTNM.toFixed(2)}`;
  document.getElementById('comissao-pe').textContent = `COMISSÃO PE: R$ ${comissaoPE.toFixed(2)}`;
  document.getElementById('comissao-adlink').textContent = `COMISSÃO AD LINK: R$ ${comissaoADLINK.toFixed(2)}`;


  // Lógica final de cálculo de adesões baseada nos dados filtrados
  let adesaoTNM = 0, adesaoPE = 0, adesaoAdLink = 0;

  regFiltrados.forEach(i => {
    const origem = (i.origem || "").toUpperCase();
    const tipo = (i.tipoBaixa || "").toLowerCase();
    const categoria = (i.categoria || "").toUpperCase();
    const comissao = parseFloat(i.comissao || 0);
    const venda = parseFloat(i.valorVenda || 0);
    const custo = parseFloat(i.custo || 0);

    if (origem === "TNM") adesaoTNM += comissao;
    if (tipo === "adlink") adesaoAdLink += comissao;
    if (origem.includes("PE") || categoria.includes("PRONTA ENTREGA")) {
      adesaoPE += venda - custo;
    }
  });

  document.getElementById('dash-adesoes-tnm').textContent = `ADESÕES TNM: R$ ${adesaoTNM.toFixed(2)}`;
  document.getElementById('dash-adesoes-pe').textContent = `ADESÕES PE: R$ ${adesaoPE.toFixed(2)}`;
  document.getElementById('dash-adesoes-adlink').textContent = `ADESÕES AD LINK: R$ ${adesaoAdLink.toFixed(2)}`;


  // Cálculo de adesões por tipo usando registros filtrados
  const totalTNM = regFiltrados
    .filter(i => (i.origem || "").toUpperCase() === "TNM")
    .reduce((s, i) => s + Number(i.valorVenda || 0), 0);

  const totalPE = regFiltrados
    .filter(i => (i.origem || "").toUpperCase().includes("PE"))
    .reduce((s, i) => s + Number(i.valorVenda || 0), 0);

  const totalAdLink = regFiltrados
    .filter(i => (i.tipoBaixa || "").toLowerCase() === "adlink")
    .reduce((s, i) => s + Number(i.valorVenda || 0), 0);

  document.getElementById('dash-adesoes-tnm').textContent = `ADESÕES TNM: R$ ${totalTNM.toFixed(2)}`;
  document.getElementById('dash-adesoes-pe').textContent = `ADESÕES PE: R$ ${totalPE.toFixed(2)}`;
  document.getElementById('dash-adesoes-adlink').textContent = `ADESÕES AD LINK: R$ ${totalAdLink.toFixed(2)}`;



            const bonusRegs = regFiltrados.filter(r => {
                if((r.categoria || "").trim().toUpperCase() === "PRONTA ENTREGA") return false;
                return ((r.origem === "TNM" && normalizeModelo(r.modelo)!=="T1") ||
                        r.origem === "AD LINK" ||
                        r.origem === "PE-1");
              });
            const bonusPorConsultor = {};
            const hoje = new Date();
            const hojeBR = `${hoje.getDate().toString().padStart(2,'0')}/${(hoje.getMonth()+1).toString().padStart(2,'0')}/${hoje.getFullYear()}`;
            const bonusPorConsultorDia = {};
            bonusRegs.forEach(r=>{
              const cons = (r.consultor || "").trim();
              bonusPorConsultor[cons] = (bonusPorConsultor[cons] || 0) + 1;
              if(r.data.trim() === hojeBR){
                bonusPorConsultorDia[cons] = (bonusPorConsultorDia[cons] || 0) + 1;
              }
            });
            let bonusConsultorTotal = 0;
            let bonusLojaTotal = 0;
            let bonusListHtml = "";
            for(let cons in bonusPorConsultor){
              const count = bonusPorConsultor[cons];
              let bonusQtd = Math.floor(count / 3);
              let consultorConfig = systemConfig.consultores.find(c => c.name.trim().toLowerCase() === cons.toLowerCase());
              let bonusValorConsultor = 0;
              if(consultorConfig && consultorConfig.bonusType !== "sem"){
                bonusValorConsultor = (consultorConfig.bonusType === "upton" ? 150 : 100);
              }
              let bonusConsultor = bonusQtd * bonusValorConsultor;
              let bonusValorLoja = (consultorConfig && consultorConfig.bonusType !== "sem") ? bonusValorConsultor : 100;
              let bonusLojaConsultor = bonusQtd * bonusValorLoja;
              bonusConsultorTotal += bonusConsultor;
              bonusLojaTotal += bonusLojaConsultor;
              let countDia = bonusPorConsultorDia[cons] || 0;
              let bonusQtdDia = Math.floor(countDia / 3);
              let bonusDia = bonusQtdDia * bonusValorConsultor;
              if(consultorConfig && consultorConfig.bonusType !== "sem"){
                bonusListHtml += `<p>Bônus: ${cons}<br/>Acumulado/Mês: R$ ${bonusConsultor.toFixed(2)}<br/>Bônus do Dia: R$ ${bonusDia.toFixed(2)}</p>`;
              }
            }
            if(nomeConsultorSel){
              let cons = nomeConsultorSel.trim();
              let count = bonusPorConsultor[cons] || 0;
              let bonusQtd = Math.floor(count / 3);
              let consultorConfig = systemConfig.consultores.find(c => c.name.trim().toLowerCase() === cons.toLowerCase());
              let bonusValorConsultor = (consultorConfig && consultorConfig.bonusType !== "sem") ? (consultorConfig.bonusType === "upton" ? 150 : 100) : 0;
              let bonusConsultor = bonusQtd * bonusValorConsultor;
              let countDia = bonusPorConsultorDia[cons] || 0;
              let bonusQtdDia = Math.floor(countDia / 3);
              let bonusDia = bonusQtdDia * bonusValorConsultor;
              dashTotalBonus.textContent = `Bônus do Consultor: R$ ${bonusConsultor.toFixed(2)}`;
              dashConsultorBonusList.innerHTML = `<p>${cons} - Acumulado/Mês: R$ ${bonusConsultor.toFixed(2)} | Bônus do Dia: R$ ${bonusDia.toFixed(2)}</p>`;
              dashTotalBonusLoja.textContent = `Bônus da Loja: R$ ${bonusLojaTotal.toFixed(2)}`;
            } else {
              dashTotalBonusLoja.textContent = `Bônus da Loja: R$ ${bonusLojaTotal.toFixed(2)}`;
              dashTotalBonus.textContent = "";
              dashConsultorBonusList.innerHTML = bonusListHtml;
            }


            const valorTotalLoja = totalCom + bonusLojaTotal;
            dashSomaComissaoBonusLoja.textContent = `Valor total = R$ ${valorTotalLoja.toFixed(2)}`;
          }


          function calcularBonusRegistros(records, consultores){
            const bonusSubset = records.filter(r => {
              if(r.origem==="TNM" && normalizeModelo(r.modelo)!=="T1") return true;
              if(r.origem==="AD LINK") return true;
              if(r.origem==="PE-1") return true;
              return false;
            });
            const mapCons = {};
            bonusSubset.forEach(r=>{
              let c = (r.consultor || "").trim();
              if(!mapCons[c]) mapCons[c] = 0;
              mapCons[c]++;
            });
            let totalBonus = 0;
            for(let c in mapCons){
              const count = mapCons[c];
              let consultorConfig = consultores.find(cx => cx.name.trim().toLowerCase() === c.toLowerCase());
              if(!consultorConfig) continue;
              if(consultorConfig.bonusType==="sem") continue;
              let bonusValor = (consultorConfig.bonusType==="upton") ? 150 : 100;
              let bonusQtd = Math.floor(count / 3);
              totalBonus += (bonusQtd * bonusValor);
            }
            return totalBonus;
          }


          // ADS
          const btnADS = document.getElementById('btn-ads');
          btnADS.addEventListener('click', ()=>{
            document.getElementById('ads-valor-investido').value = "";
            document.getElementById('ads-resultados').innerHTML = "";
            document.getElementById('ads-vendas-tnm').innerHTML = "";
            document.getElementById('ads-vendas-tnm-org').innerHTML = "";
            document.getElementById('modal-ads').classList.remove('hidden');
          });
          document.getElementById('fechar-modal-ads').addEventListener('click', ()=>{
            document.getElementById('modal-ads').classList.add('hidden');
          });
          document.getElementById('ads-personalizado').addEventListener('click', ()=>{
            document.getElementById('ads-data-personalizada').classList.remove('hidden');
          });


          const adsHojeBtn = document.getElementById('ads-hoje');
          const adsOntemBtn = document.getElementById('ads-ontem');
          const adsEstaSemanaBtn = document.getElementById('ads-esta-semana');
          const adsSemanaPassadaBtn = document.getElementById('ads-semana-passada');
          const adsMesBtn = document.getElementById('ads-mes');
          const adsPersonalizadoBtn = document.getElementById('ads-filtrar-personalizado');
          const adsDataInicio = document.getElementById('ads-data-inicio');
          const adsDataFim = document.getElementById('ads-data-fim');
          const adsCalcularBtn = document.getElementById('ads-calcular');


          adsHojeBtn.addEventListener('click', () => {
            const hoje = new Date();
            const yyyy = hoje.getFullYear();
            const mm = String(hoje.getMonth() + 1).padStart(2, '0');
            const dd = String(hoje.getDate()).padStart(2, '0');
            adsDataInicio.value = `${yyyy}-${mm}-${dd}`;
            adsDataFim.value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('ads-data-personalizada').classList.add('hidden');
            adsCalcularBtn.click();
          });
          adsOntemBtn.addEventListener('click', () => {
            const hoje = new Date();
            hoje.setDate(hoje.getDate() - 1);
            const yyyy = hoje.getFullYear();
            const mm = String(hoje.getMonth() + 1).padStart(2, '0');
            const dd = String(hoje.getDate()).padStart(2, '0');
            adsDataInicio.value = `${yyyy}-${mm}-${dd}`;
            adsDataFim.value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('ads-data-personalizada').classList.add('hidden');
            adsCalcularBtn.click();
          });
          adsEstaSemanaBtn.addEventListener('click', () => {
            const now = new Date();
            let day = now.getDay();
            let offset = day===0 ? 6 : (day-1);
            let start = new Date(now);
            start.setHours(0,0,0,0);
            start.setDate(start.getDate() - offset);
            let end = new Date(now);
            end.setHours(23,59,59,999);


            const yyyyS = start.getFullYear();
            const mmS = String(start.getMonth() + 1).padStart(2, '0');
            const ddS = String(start.getDate()).padStart(2, '0');
            const yyyyE = end.getFullYear();
            const mmE = String(end.getMonth() + 1).padStart(2, '0');
            const ddE = String(end.getDate()).padStart(2, '0');


            adsDataInicio.value = `${yyyyS}-${mmS}-${ddS}`;
            adsDataFim.value = `${yyyyE}-${mmE}-${ddE}`;
            document.getElementById('ads-data-personalizada').classList.add('hidden');
            adsCalcularBtn.click();
          });
          adsSemanaPassadaBtn.addEventListener('click', () => {
            const now = new Date();
            let day = now.getDay();
            let offset = day===0 ? 6 : (day-1);
            let end = new Date(now);
            end.setHours(23,59,59,999);
            end.setDate(end.getDate() - offset -1);
            let start = new Date(end);
            start.setHours(0,0,0,0);
            start.setDate(start.getDate() - 6);


            const yyyyS = start.getFullYear();
            const mmS = String(start.getMonth() + 1).padStart(2, '0');
            const ddS = String(start.getDate()).padStart(2, '0');
            const yyyyE = end.getFullYear();
            const mmE = String(end.getMonth() + 1).padStart(2, '0');
            const ddE = String(end.getDate()).padStart(2, '0');


            adsDataInicio.value = `${yyyyS}-${mmS}-${ddS}`;
            adsDataFim.value = `${yyyyE}-${mmE}-${ddE}`;
            document.getElementById('ads-data-personalizada').classList.add('hidden');
            adsCalcularBtn.click();
          });
          adsMesBtn.addEventListener('click', () => {
            const hoje = new Date();
            const yyyy = hoje.getFullYear();
            const mm = hoje.getMonth();
            const inicio = new Date(yyyy, mm, 1);
            const fim = new Date(yyyy, mm, hoje.getDate());


            const yyyyI = inicio.getFullYear();
            const mmI = String(inicio.getMonth() + 1).padStart(2, '0');
            const ddI = String(inicio.getDate()).padStart(2, '0');
            const yyyyF = fim.getFullYear();
            const mmF = String(fim.getMonth() + 1).padStart(2, '0');
            const ddF = String(fim.getDate()).padStart(2, '0');


            adsDataInicio.value = `${yyyyI}-${mmI}-${ddI}`;
            adsDataFim.value = `${yyyyF}-${mmF}-${ddF}`;
            document.getElementById('ads-data-personalizada').classList.add('hidden');
            adsCalcularBtn.click();
          });
          adsPersonalizadoBtn.addEventListener('click', () => {
            adsCalcularBtn.click();
          });


          adsCalcularBtn.addEventListener('click', ()=>{
            let tpCount = 0, orgCount = 0;
            let inicio, fim;
            const di = adsDataInicio.value;
            const df = adsDataFim.value;
            if(di && df){
              inicio = parseDateBR(formatDateBR(di));
              fim = parseDateBR(formatDateBR(df));
            } else {
              inicio = new Date(0);
              fim = new Date();
            }
            historico.forEach(r=>{
              let rDate = parseDateBR(r.data);
              if(rDate && rDate >= inicio && rDate <= fim){
                if(r.ads === "TP") tpCount++;
                else if(r.ads === "ORG") orgCount++;
              }
            });
            const valorInvestido = parseFloat(document.getElementById('ads-valor-investido').value) || 0;
            let cpl = tpCount > 0 ? (valorInvestido / tpCount).toFixed(2) : "0.00";
            let htmlRes = `<p>Leads via Tráfego Pago: ${tpCount}</p>
                           <p>Leads Orgânicos: ${orgCount}</p>
                           <p>CPL (Custo por Lead) = R$ ${cpl}</p>`;
            document.getElementById('ads-resultados').innerHTML = htmlRes;


            const regsAds = historico.filter(r => {
              let rd = parseDateBR(r.data);
              return rd && rd >= inicio && rd <= fim;
            });
            const regsTP = regsAds.filter(r => r.ads==="TP");
            let somaTPComissoes = regsTP.reduce((acc, r) => acc + (parseFloat(r.comissao) || 0), 0);
            let bonusTP = calcularBonusRegistros(regsTP, systemConfig.consultores);
            let totalTP = somaTPComissoes + bonusTP;
            let resultadoTP = totalTP - valorInvestido;


            const regsORG = regsAds.filter(r => r.ads==="ORG");
            let somaORGComissoes = regsORG.reduce((acc, r) => acc + (parseFloat(r.comissao) || 0), 0);
            let bonusORG = calcularBonusRegistros(regsORG, systemConfig.consultores);
            let totalORG = somaORGComissoes + bonusORG;
            let resultadoORG = totalORG - valorInvestido;


            let somaAllComissoes = somaTPComissoes + somaORGComissoes;
            let bonusAll = bonusTP + bonusORG;
            let totalAll = somaAllComissoes + bonusAll;
            let resultadoAll = totalAll - valorInvestido;


            document.getElementById('ads-vendas-tnm').innerHTML =
              `<p>TOTAL DE COMISSÕES (TP) VIA TNM, AD LINK, PE E BÔNUS = R$ ${totalTP.toFixed(2)}<br/>
              - (Valor Investido: R$ ${valorInvestido.toFixed(2)}) = R$ ${resultadoTP.toFixed(2)}</p>`;


            document.getElementById('ads-vendas-tnm-org').innerHTML =
              `<p>TOTAL DE COMISSÕES (ORG) VIA TNM, AD LINK, PE E BÔNUS = R$ ${totalORG.toFixed(2)}</p>
               <p>TOTAL DE COMISSÕES GERAIS (TP + ORG) - VALOR INVESTIDO = R$ ${resultadoAll.toFixed(2)}</p>`;
          });


          // Acompanhar / Concluídos
          function atualizarModalAcompanhar(){
            const serialFilter = document.getElementById('filtro-serial').value.trim().toLowerCase();
            const categoriaFilter = document.getElementById('filtro-categoria').value;
            const cadastroFilter = document.getElementById('filtro-cadastro').value;
            const listaContainer = document.getElementById('acompanhar-lista');
            listaContainer.innerHTML = "";
            let encontrou = false;
            estoque.forEach(item => {
              if(item.notas && item.notas.includes("CONCLUÍD")) return;
              if(!item.status) return;
              if(!(item.status === "BAD" || (item.notas && item.notas.trim() !== ""))) return;
              const itemSerialLC = item.serial.toLowerCase();
              if(serialFilter && !itemSerialLC.includes(serialFilter)) return;
              if(categoriaFilter && item.categoria !== categoriaFilter) return;
              if(cadastroFilter && item.cadastro !== cadastroFilter) return;
              encontrou = true;
              const itemDiv = document.createElement('div');
              itemDiv.style.borderBottom = "1px solid #ccc";
              itemDiv.style.padding = "10px 0";
              const serialP = document.createElement('p');
              serialP.innerHTML = `<strong>Serial:</strong> ${item.serial}`;
              itemDiv.appendChild(serialP);
              const notaP = document.createElement('p');
              notaP.innerHTML = `<strong>Anotação:</strong> ${item.notas || ""}`;
              itemDiv.appendChild(notaP);
              const btnEditarNota = document.createElement('button');
              btnEditarNota.textContent = "Editar Informação";
              btnEditarNota.style.marginTop = "5px";
              btnEditarNota.style.fontSize = "0.8rem";
              btnEditarNota.addEventListener('click', () => {
                if(notaP.querySelector('textarea')) return;
                const currentNota = item.notas || "";
                const textarea = document.createElement('textarea');
                textarea.style.width = "95%";
                textarea.style.height = "80px";
                textarea.style.fontSize = "1rem";
                textarea.value = currentNota;
                const btnSalvar = document.createElement('button');
                btnSalvar.textContent = "Salvar";
                btnSalvar.style.fontSize = "0.8rem";
                btnSalvar.classList.add("modal-btn-small");
                btnSalvar.style.marginLeft = "5px";
                btnSalvar.addEventListener('click', () => {
                  const novaNota = textarea.value;
                  item.notas = novaNota;
                  localStorage.setItem('estoque', JSON.stringify(estoque));
                  registrarLog("Edição Anotação", `Serial ${item.serial} anotação atualizada`);
                  atualizarModalAcompanhar();
                });
                notaP.innerHTML = `<strong>Anotação:</strong> `;
                notaP.appendChild(textarea);
                notaP.appendChild(btnSalvar);
              });
              itemDiv.appendChild(btnEditarNota);
              const btnConcluido = document.createElement('button');
              btnConcluido.textContent = "Concluído ✅";
              btnConcluido.style.marginTop = "5px";
              btnConcluido.style.marginLeft = "5px";
              btnConcluido.style.fontSize = "0.8rem";
              btnConcluido.addEventListener('click', () => {
                const today = new Date();
                const dd = today.getDate().toString().padStart(2, '0');
                const mm = (today.getMonth() + 1).toString().padStart(2, '0');
                const yyyy = today.getFullYear();
                const dataBR = `${dd}/${mm}/${yyyy}`;
                item.notas = (item.notas ? item.notas + " " : "") + `CONCLUÍDIDO ✅ em ${dataBR}`;
                localStorage.setItem('estoque', JSON.stringify(estoque));
                registrarLog("Concluir Anotação", `Serial ${item.serial} marcada como concluída`);
                atualizarModalAcompanhar();
              });
              itemDiv.appendChild(btnConcluido);
              listaContainer.appendChild(itemDiv);
            });
            if (!encontrou) {
              listaContainer.innerHTML = "<p>Não há itens pendentes para acompanhamento.</p>";
            }
          }
          document.getElementById('aplicar-filtros-acompanhar').addEventListener('click', atualizarModalAcompanhar);
          var fecharModalAcompanhar = document.getElementById('fechar-modal-acompanhar');
          if(fecharModalAcompanhar){
            fecharModalAcompanhar.addEventListener('click', ()=>{
              document.getElementById('modal-acompanhar').classList.add('hidden');
            });
          }
          document.getElementById('btn-acompanhar').addEventListener('click', () => {
            const filtroCadastro = document.getElementById('filtro-cadastro');
            filtroCadastro.innerHTML = '<option value="">Todos</option>';
            systemConfig.cadastros.forEach(cad => {
              let opt = document.createElement('option');
              opt.value = cad;
              opt.textContent = cad;
              filtroCadastro.appendChild(opt);
            });
            atualizarModalAcompanhar();
            document.getElementById('modal-acompanhar').classList.remove('hidden');
          });


          function atualizarModalConcluidos(){
            const listaContainer = document.getElementById('lista-concluidos');
            listaContainer.innerHTML = "";
            let encontrou = false;
            estoque.forEach(item => {
              if(item.notas && item.notas.includes("CONCLUÍD")){
                encontrou = true;
                const itemDiv = document.createElement('div');
                itemDiv.style.borderBottom = "1px solid #ccc";
                itemDiv.style.padding = "10px 0";
                const serialP = document.createElement('p');
                serialP.innerHTML = `<strong>Serial:</strong> ${item.serial}`;
                itemDiv.appendChild(serialP);
                const notaP = document.createElement('p');
                notaP.innerHTML = `<strong>Anotação:</strong> <span class="nota-text">${item.notas}</span>`;
                itemDiv.appendChild(notaP);
                const btnReverter = document.createElement('button');
                btnReverter.textContent = "Reverter";
                btnReverter.style.marginTop = "5px";
                btnReverter.style.fontSize = "0.8rem";
                btnReverter.addEventListener('click', () => {
                  item.notas = item.notas.replace(/CONCLU[IÍ]D(?:O|A|IDO) ✅ em \d{2}\/\d{2}\/\d{4}/i, "").trim();
                  localStorage.setItem('estoque', JSON.stringify(estoque));
                  registrarLog("Reverter Concluído", `Serial ${item.serial} revertida`);
                  atualizarModalConcluidos();
                  atualizarModalAcompanhar();
                });
                itemDiv.appendChild(btnReverter);
                listaContainer.appendChild(itemDiv);
              }
            });
            if(!encontrou) {
              listaContainer.innerHTML = "<p>Não há itens concluídos.</p>";
            }
          }
          document.getElementById('btn-visualizar-concluidos').addEventListener('click', () => {
            atualizarModalConcluidos();
            document.getElementById('modal-concluidos').classList.remove('hidden');
          });
          var fecharModalConcluidos = document.getElementById('fechar-modal-concluidos');
          if(fecharModalConcluidos){
            fecharModalConcluidos.addEventListener('click', ()=>{
              document.getElementById('modal-concluidos').classList.add('hidden');
            });
          }


          // Botão Buscar Serial
          document.getElementById('btn-busca-serial').addEventListener('click', function(){
            document.getElementById('busca-serial-input').value = "";
            document.getElementById('resultado-busca-serial').innerHTML = "";
            document.getElementById('modal-busca-serial').classList.remove('hidden');
          });
          var fecharModalBuscaSerial = document.getElementById('fechar-modal-busca-serial');
          if(fecharModalBuscaSerial){
            fecharModalBuscaSerial.addEventListener('click', function(){
              document.getElementById('modal-busca-serial').classList.add('hidden');
            });
          }
          document.getElementById('buscar-serial-btn').addEventListener('click', function(){
            const searchSerial = document.getElementById('busca-serial-input').value.trim();
            const resultadoDiv = document.getElementById('resultado-busca-serial');
            resultadoDiv.innerHTML = "";
            if(!searchSerial) {
              resultadoDiv.textContent = "Por favor, informe um serial.";
              return;
            }
            const foundEstoque = estoque.find(item => item.serial === searchSerial);
            const baixasDoSerial = historico.filter(h => h.serial === searchSerial);
            let foundHistorico = null;
            if(baixasDoSerial.length > 0) {
              foundHistorico = baixasDoSerial[baixasDoSerial.length - 1];
            }
            if(foundEstoque) {
              const tipoCad = extrairTipoCadastro(foundEstoque.cadastro || "");
              let statusStr = foundEstoque.status === "BAD" ? "❌ BAD" : "✅ GOOD";
              let html = `
                <p><strong>Serial:</strong> ${foundEstoque.serial}</p>
                <p><strong>Data da Adição:</strong> ${foundEstoque.data || "N/A"}</p>
                <p><strong>Categoria:</strong> ${foundEstoque.categoria || "N/A"}</p>
                <p><strong>Tipo de Cadastro:</strong> ${tipoCad}</p>
                <p><strong>Modelo:</strong> ${foundEstoque.modelo || "N/A"}</p>
                <p><strong>Plano:</strong> ${foundEstoque.plano || "N/A"}</p>
                <p><strong>Loja (Alocação):</strong> ${foundEstoque.alocacao || "N/A"}</p>
                <p><strong>Status:</strong> ${statusStr}</p>
                <p><strong>ADS:</strong> ${foundEstoque.ads || ""}</p>
              `;
              if(foundEstoque.notas && foundEstoque.notas.trim() !== ""){
                html += `<p><strong>Anotação:</strong> ${foundEstoque.notas}</p>`;
              }
              resultadoDiv.innerHTML = html;
            }
            else if(foundHistorico) {
              const tipoCad = extrairTipoCadastro(foundHistorico.cadastro || "");
              let statusStr = (foundHistorico.status === "BAD") ? "❌ (Baixada para devolução)" : "❌ (Indisponível - Baixado)";
              let html = `
                <p><strong>Serial:</strong> ${foundHistorico.serial}</p>
                <p><strong>Data da Baixa:</strong> ${foundHistorico.data || "N/A"}</p>
                <p><strong>Cliente:</strong> ${foundHistorico.cliente || "N/A"}</p>
                <p><strong>Consultor:</strong> ${foundHistorico.consultor || "N/A"}</p>
                <p><strong>Categoria:</strong> ${foundHistorico.categoria || "N/A"}</p>
                <p><strong>Tipo de Cadastro:</strong> ${tipoCad}</p>
                <p><strong>Modelo:</strong> ${foundHistorico.modelo || "N/A"}</p>
                <p><strong>Plano:</strong> ${foundHistorico.plano || "N/A"}</p>
                <p><strong>Loja (Baixa):</strong> ${foundHistorico.loja || "N/A"}</p>
                <p><strong>Status:</strong> ${statusStr}</p>
                <p><strong>ADS:</strong> ${foundHistorico.ads || ""}</p>
              `;
              // Exibir eventual anotação do histórico:
              if(foundHistorico.notas && foundHistorico.notas.trim() !== ""){
                html += `<p><strong>Anotação:</strong> ${foundHistorico.notas}</p>`;
              }
              resultadoDiv.innerHTML = html;
            }
            else {
              resultadoDiv.textContent = "Serial não encontrado.";
            }
          });


          // Senhas e Reset
          document.getElementById('salvar-senhas').addEventListener('click', function(){
            let alterarLogin = document.getElementById('alterar-login').value;
            if(alterarLogin === "sim"){
              let senhaAtual = document.getElementById('senha-login-atual').value;
              let senhaNova = document.getElementById('senha-login-nova').value;
              let senhaConfirmar = document.getElementById('senha-login-confirmar').value;
              if(senhaAtual.trim() !== systemConfig.password.trim()){
                showAlert("Senha atual de login incorreta!");
                return;
              }
              if(senhaNova !== senhaConfirmar){
                showAlert("As novas senhas de login não conferem!");
                return;
              }
              systemConfig.password = senhaNova;
              let sistemaUser = systemConfig.users.find(u => u.name.toLowerCase() === "sistema");
              if(sistemaUser) sistemaUser.password = senhaNova;
            }
            let backupNova = document.getElementById('senha-backup-nova').value;
            let backupConfirmar = document.getElementById('senha-backup-confirmar').value;
            if(backupNova || backupConfirmar){
              if(backupNova !== backupConfirmar){
                showAlert("As novas senhas de backup não conferem!");
                return;
              }
              systemConfig.backupPassword = backupNova;
            }
            let centralNova = document.getElementById('senha-central-nova').value;
            let centralConfirmar = document.getElementById('senha-central-confirmar').value;
            if(centralNova || centralConfirmar){
              if(centralNova !== centralConfirmar){
                showAlert("As novas senhas da Central de Custo não conferem!");
                return;
              }
              systemConfig.centralCustoPassword = centralNova;
            }
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            showAlert("Senhas atualizadas com sucesso!");
          });


          document.getElementById('btn-reset-dados').addEventListener('click', function(){
            showConfirm("Tem certeza que deseja resetar os dados do sistema? Será realizado um backup automático antes do reset.", function(confirmado) {
              if(confirmado) {
                backupAndReset();
              }
            });
          });
          function backupAndReset(){
            const currentSystemConfig = JSON.parse(localStorage.getItem('systemConfig')) || {};
            const estoque = JSON.parse(localStorage.getItem('estoque')) || [];
            const historico = JSON.parse(localStorage.getItem('historico')) || [];
            const chipsCount = JSON.parse(localStorage.getItem('chipsCount')) || {};
            const chipsDateLastUpdate = JSON.parse(localStorage.getItem('chipsDateLastUpdate')) || {};
            const valores = JSON.parse(localStorage.getItem('valores')) || {};
            const backupObj = { estoque, historico, chipsCount, chipsDateLastUpdate, systemConfig: currentSystemConfig, valores };
            const backupStr = JSON.stringify(backupObj, null, 2);
            const now = new Date();
            const dd = String(now.getDate()).padStart(2, '0');
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yy = String(now.getFullYear()).slice(-2);
            const userName = (currentSystemConfig.username || "usuario").toLowerCase();
            const fileName = `backup.${userName}.${dd}.${mm}.${yy}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(backupStr);
            const a = document.createElement('a');
            a.setAttribute('href', dataStr);
            a.setAttribute('download', fileName);
            document.body.appendChild(a);
            a.click();
            a.remove();
            localStorage.clear();
            showAlert("Sistema resetado com sucesso! A página será recarregada.", function(){
              location.reload();
            });
          }


          // BOTÃO CAMPEÕES DE MÊS
          const btnCampeoesMes = document.getElementById('btn-campeoes-mes');
          const modalCampeoes = document.getElementById('modal-campeoes-mes');
          const fecharCampeoesModal = document.getElementById('fechar-modal-campeoes');
          const campeoesMesSelect = document.getElementById('campeoes-mes');
          const campeoesAnoSelect = document.getElementById('campeoes-ano');
          const filtrarCampeoesBtn = document.getElementById('filtrar-campeoes-btn');
          const campeoesRankingDiv = document.getElementById('campeoes-ranking');


          function initCampeoesMesAno(){
            campeoesMesSelect.innerHTML = "";
            campeoesAnoSelect.innerHTML = "";
            const now = new Date();
            for(let i=0; i<12; i++){
              const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
              let m = String(d.getMonth()+1).padStart(2,'0');
              let y = d.getFullYear();
              if(!Array.from(campeoesAnoSelect.options).some(o => o.value === String(y))){
                let anoOpt = document.createElement('option');
                anoOpt.value = String(y);
                anoOpt.textContent = String(y);
                campeoesAnoSelect.appendChild(anoOpt);
              }
            }
            campeoesAnoSelect.value = String(now.getFullYear());
            for(let mm=1; mm<=12; mm++){
              const mmStr = String(mm).padStart(2,'0');
              let mesOpt = document.createElement('option');
              mesOpt.value = mmStr;
              mesOpt.textContent = mmStr;
              campeoesMesSelect.appendChild(mesOpt);
            }
            campeoesMesSelect.value = String(now.getMonth()+1).padStart(2,'0');
          }


          btnCampeoesMes.addEventListener('click', ()=>{
            initCampeoesMesAno();
            campeoesRankingDiv.innerHTML = "";
            modalCampeoes.classList.remove('hidden');
          });
          if(fecharCampeoesModal){
            fecharCampeoesModal.addEventListener('click', ()=>{
              modalCampeoes.classList.add('hidden');
            });
          }
          filtrarCampeoesBtn.addEventListener('click', ()=>{
            const mesSel = campeoesMesSelect.value;
            const anoSel = campeoesAnoSelect.value;
            exibirCampeoesMes(mesSel, anoSel);
          });


          function exibirCampeoesMes(mes, ano){
            campeoesRankingDiv.innerHTML = "";
            let intMes = parseInt(mes,10);
            let intAno = parseInt(ano,10);
            const registros = historico.filter(r => {
              let dt = parseDateBR(r.data);
              if(!dt) return false;
              if((dt.getMonth()+1) !== intMes || dt.getFullYear() !== intAno) return false;
              if(r.origem === "TNM"){
                if(normalizeModelo(r.modelo) === "T1") return false;
                return true;
              }
              if(r.origem === "AD LINK") return true;
              if(r.origem === "PE-1") return true;
              return false;
            });


            if(registros.length === 0){
              campeoesRankingDiv.innerHTML = `<p>Nenhuma adesão computável para ${mes}/${ano}.</p>`;
              return;
            }


            let mapaConsultores = {};
            registros.forEach(r => {
              let c = (r.consultor || "").trim();
              if(!mapaConsultores[c]) mapaConsultores[c] = [];
              mapaConsultores[c].push({
                cliente: r.cliente,
                modelo: r.modelo,
                data: r.data,
                serial: r.serial
              });
            });
            let lista = Object.keys(mapaConsultores).map(cons => {
              return {
                consultor: cons,
                count: mapaConsultores[cons].length,
                detalhes: mapaConsultores[cons]
              };
            });
            lista.sort((a,b) => b.count - a.count);


            let maxCount = lista[0].count;
            let html = `<p>Total de consultores: ${lista.length}</p><br/>`;
            lista.forEach((c,index) => {
              let emoji = "";
              if(index===0) emoji = "🏆 ";
              else if(index===1) emoji = "🥇 ";
              else if(index===2) emoji = "🥈 ";
              let pct = (c.count / maxCount)*100;
              if(pct < 0) pct = 0; if(pct>100) pct=100;
              let divId = `consultor-detalhe-${index}`;
              html += `
                <div style="margin-bottom: 10px;">
                  ${emoji}<strong>${c.consultor || "N/A"}</strong>: ${c.count} adesões
                  <div class="progress-bar">
                    <div class="progress-fill" style="width:${pct.toFixed(1)}%;">
                      ${c.count}
                    </div>
                  </div>
                  <span class="toggle-consultor-detalhe">[+]</span>
                  <div id="${divId}" class="campeoes-detalhe-list hidden">
                  </div>
                </div>
              `;
            });
            campeoesRankingDiv.innerHTML = html;


            let toggles = campeoesRankingDiv.querySelectorAll('.toggle-consultor-detalhe');
            toggles.forEach((t,i)=>{
              t.addEventListener('click', ()=>{
                let divId = `consultor-detalhe-${i}`;
                let detailDiv = document.getElementById(divId);
                if(detailDiv.classList.contains('hidden')){
                  detailDiv.classList.remove('hidden');
                  t.textContent = '[-]';
                  let dados = lista[i].detalhes;
                  let inner = "";
                  dados.forEach(d=>{
                    inner += `<p>Cliente: <strong>${d.cliente||""}</strong> | Modelo: ${d.modelo||""} | Data: ${d.data||""} | Serial: ${d.serial||""}</p>`;
                  });
                  detailDiv.innerHTML = inner;
                } else {
                  detailDiv.classList.add('hidden');
                  t.textContent = '[+]';
                }
              });
            });
          }


        }); // DOMContentLoaded end


        window.showAlert = function(message, callback) {
          const modal = document.getElementById('modal-alert');
          document.getElementById('modal-alert-message').textContent = message;
          modal.classList.remove('hidden');
          var modalAlertClose = document.getElementById('modal-alert-close');
          if(modalAlertClose){
            modalAlertClose.onclick = function(){
              modal.classList.add('hidden');
              if(callback) callback();
            };
          }
        };
        window.showConfirm = function(message, callback) {
          const modal = document.getElementById('modal-confirm');
          document.getElementById('modal-confirm-message').textContent = message;
          modal.classList.remove('hidden');
          var modalConfirmYes = document.getElementById('modal-confirm-yes');
          var modalConfirmNo = document.getElementById('modal-confirm-no');
          if(modalConfirmYes){
            modalConfirmYes.onclick = function(){
              modal.classList.add('hidden');
              callback(true);
            };
          }
          if(modalConfirmNo){
            modalConfirmNo.onclick = function(){
              modal.classList.add('hidden');
              callback(false);
            };
          }
        };
 
window.reservarItem = function(idx) {
  const item = estoque[idx];
  if(item.status !== "GOOD"){
        showAlert("Este item não está disponível para reserva!");
        return;
  }
  let consultoresOpts = systemConfig.consultores.map(c => {
        return { value: c.name, text: c.name + " - " + c.loja };
  });
  showSelectPrompt("Escolha o consultor para reserva:", consultoresOpts, "", function(consultorEscolhido){
        if(!consultorEscolhido) return;
        item.status = "RESERVADO";
        item.reservaConsultor = consultorEscolhido;
        item.reservaData = new Date().toLocaleString("pt-BR");
        localStorage.setItem("estoque", JSON.stringify(estoque));
        showAlert("Item reservado com sucesso!");
        atualizarTabelaPronta();
        atualizarTabelaTon();
  });
};




function excluirReserva(idx){
  const item = estoque[idx];
  item.status = "GOOD";
  item.reservaConsultor = "";
  item.reservaData = "";
  localStorage.setItem("estoque", JSON.stringify(estoque));
  showAlert("Reserva excluída. Este item agora está novamente disponível!");
  atualizarModalReservas();
  atualizarTabelaPronta();
  atualizarTabelaTon();
}




function atualizarModalReservas(){
  const lista = document.getElementById('lista-reservas');
  lista.innerHTML = "";
  const reservados = estoque.filter(e => e.status === "RESERVADO");
  if(reservados.length === 0){
        lista.innerHTML = "<p>Nenhum item reservado no momento.</p>";
        return;
  }
  reservados.forEach(item => {
        const idx = estoque.indexOf(item);
        let div = document.createElement('div');
        div.style.borderBottom = "1px solid #ccc";
        div.style.padding = "5px";
        div.innerHTML = `
          <p><strong>Serial:</strong> ${item.serial}</p>
          <p><strong>Modelo:</strong> ${item.modelo}</p>
          <p><strong>Categoria:</strong> ${item.categoria}</p>
          <p><strong>Tipo de Cadastro:</strong> ${item.cadastro}</p>
          <p><strong>Consultor:</strong> ${item.reservaConsultor || ""}</p>
          <p><strong>Data da Reserva:</strong> ${item.reservaData || ""}</p>
          <button onclick="showAlert('Item já reservado!')">Indisponível 🚫</button>
          <button onclick="excluirReserva(${idx})">Excluir Reserva</button>
        `;
        lista.appendChild(div);
  });
}


</script>
</body>
</html>

<!-- Início do trecho modificado da lógica JavaScript para cálculo e atualização dinâmica -->
<script>
function calcularIndicadoresDashboard(registros) {
  var totalComissao = 0;
  var bonusConsultor = 0;
  var bonusLoja = 0;
  var adesoesTNM = 0;
  var adesoesPE = 0;
  var adesoesAdLink = 0;

  registros.forEach(function(registro) {
    totalComissao += registro.comissao || 0;
    bonusConsultor += registro.bonusConsultor || 0;
    bonusLoja += registro.bonusLoja || 0;

    if (registro.cadastro === "TNM") {
      adesoesTNM += registro.valorVenda || 0;
    } else if (registro.cadastro === "Pronta Entrega" || registro.cadastro === "PE") {
      adesoesPE += registro.valorVenda || 0;
    } else if (registro.cadastro === "AD LINK") {
      adesoesAdLink += registro.valorVenda || 0;
    }
  });

  return {
    totalComissao: totalComissao,
    bonusConsultor: bonusConsultor,
    bonusLoja: bonusLoja,
    adesoesTNM: adesoesTNM,
    adesoesPE: adesoesPE,
    adesoesAdLink: adesoesAdLink
  };
}

function atualizarDashboard(dados) {
  document.getElementById('dash-adesoes-tnm').textContent = "ADESÕES TNM: R$ " + dados.adesoesTNM.toFixed(2);
  document.getElementById('dash-adesoes-pe').textContent = "ADESÕES PE: R$ " + dados.adesoesPE.toFixed(2);
  document.getElementById('dash-adesoes-adlink').textContent = "ADESÕES AD LINK: R$ " + dados.adesoesAdLink.toFixed(2);
  document.getElementById('dash-total-comissao').textContent = "Total de Comissão: R$ " + dados.totalComissao.toFixed(2);
  document.getElementById('dash-total-bonus').textContent = "Bônus do Consultor: R$ " + dados.bonusConsultor.toFixed(2);
  document.getElementById('dash-total-bonus-loja').textContent = "Bônus da Loja: R$ " + dados.bonusLoja.toFixed(2);
  var valorTotal = dados.totalComissao + dados.bonusLoja;
  document.getElementById('dash-soma-comissao-bonus-loja').textContent = "Valor total = R$ " + valorTotal.toFixed(2);

  if (dados.consultorInfo) {
    document.getElementById('dash-consultor-bonus-list').textContent =
      dados.consultorInfo.nome + " - Acumulado/Mês: R$ " + dados.consultorInfo.acumuladoMes.toFixed(2) +
      " | Bônus do Dia: R$ " + dados.consultorInfo.bonusDia.toFixed(2);
  }
}

function atualizarDashboardComDadosFiltrados() {
  var registrosFiltrados = obterRegistrosFiltrados();
  var indicadores = calcularIndicadoresDashboard(registrosFiltrados);
  atualizarDashboard(indicadores);
}
</script>
<!-- Fim do trecho modificado da lógica JavaScript -->


<!-- Início do trecho atualizado para cálculo dinâmico de adesões por data -->
<script>
function parseDateBR(dataStr) {
  if (!dataStr || typeof dataStr !== "string") return null;
  const partes = dataStr.split("/");
  if (partes.length !== 3) return null;
  return new Date(Number(partes[2]), Number(partes[1]) - 1, Number(partes[0]));
}


function calcularAdesoes(registros) {
  let adesoesTNM = 0;
  let adesoesPE = 0;
  let adesoesAdLink = 0;

  registros.forEach(registro => {
    // Verifica todos os campos possíveis
    let camposPossiveis = [
      registro.origem,
      registro.cadastro,
      registro.categoria,
      registro.tipo_baixa
    ];

    let tipo = camposPossiveis
      .filter(Boolean) // remove undefined/null
      .map(c => c.toUpperCase().trim())
      .join(" ");

    const valor = parseFloat(registro.valorVenda) || 0;

    console.log("Verificando tipo:", tipo);

    if (tipo.includes("TON NA MÃO") || tipo.includes("TNM")) {
      adesoesTNM += valor;
    } else if (tipo.includes("PRONTA ENTREGA") || tipo.includes("PE")) {
      adesoesPE += valor;
    } else if (tipo.includes("AD LINK") || tipo.includes("ADLINK")) {
      adesoesAdLink += valor;
    }
  });

  console.log("Adesões finais:", {
    adesoesTNM, adesoesPE, adesoesAdLink
  });

  return { adesoesTNM, adesoesPE, adesoesAdLink };
}

function filtrarDashboardConsultor(dtStart, dtEnd, nomeConsultorSel) {
  dashTabela.innerHTML = "";
  let totalCom = 0;

  const regFiltrados = historico.filter(h => {
    const origem = (h.origem || "").trim().toUpperCase();
    if (origem === "BAIXADO POR DEVOLUÇÃO" || origem === "DEVOLUÇÃO BAD") return false;

    const responsavel = (h.consultor || h.vendedor || "").trim().toLowerCase();
    if (nomeConsultorSel && responsavel !== nomeConsultorSel.trim().toLowerCase()) return false;

    const hDate = parseDateBR(h.data);
    if (!hDate) return false;

    const dentroIntervalo = hDate >= dtStart && hDate <= dtEnd;
    return dentroIntervalo;
  });

  console.log("Registros filtrados:", regFiltrados);

  const adesoes = calcularAdesoes(regFiltrados);
  document.getElementById('dash-adesoes-tnm').textContent = "ADESÕES TNM: R$ " + adesoes.adesoesTNM.toFixed(2);
  document.getElementById('dash-adesoes-pe').textContent = "ADESÕES PE: R$ " + adesoes.adesoesPE.toFixed(2);
  document.getElementById('dash-adesoes-adlink').textContent = "ADESÕES AD LINK: R$ " + adesoes.adesoesAdLink.toFixed(2);

  if (regFiltrados.length === 0) {
    let tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="text-align:center;">Sem registros</td>`;
    dashTabela.appendChild(tr);

    dashTotalComissao.textContent = "Total de Comissão: R$ 0,00";
    dashTotalBonus.textContent = "Bônus do Consultor: R$ 0,00";
    dashTotalBonusLoja.textContent = "Bônus da Loja: R$ 0,00";
    dashSomaComissaoBonusLoja.textContent = "Valor total = R$ 0,00";
    dashConsultorBonusList.innerHTML = "";
    return;
  }

  regFiltrados.forEach(r => {
    let tr = document.createElement("tr");
    const consultor = (r.consultor || r.vendedor || "").trim();
    tr.innerHTML = `
      <td>${r.data || ""}</td>
      <td>${r.cliente || ""}</td>
      <td>${consultor}</td>
      <td>R$ ${(parseFloat(r.valorVenda) || 0).toFixed(2)}</td>
      <td>R$ ${(parseFloat(r.comissao) || 0).toFixed(2)}</td>
      <td></td>
    `;
    dashTabela.appendChild(tr);
    totalCom += parseFloat(r.comissao) || 0;
  });

  dashTotalComissao.textContent = `Total de Comissão: R$ ${totalCom.toFixed(2)}`;

  // Cálculo de comissões separadas
  let comissaoTNM = 0, comissaoPE = 0, comissaoADLINK = 0;

  regFiltrados.forEach(i => {
    const origem = (i.origem || "").toUpperCase();
    const tipo = (i.tipoBaixa || "").toLowerCase();
    const categoria = (i.categoria || "").toUpperCase();
    const comissao = parseFloat(i.comissao || 0);
    const venda = parseFloat(i.valorVenda || 0);
    const custo = parseFloat(i.custo || 0);

    if (origem === "TNM") comissaoTNM += comissao;
    if (tipo === "adlink") comissaoADLINK += comissao;
    if (origem.includes("PE") || categoria.includes("PRONTA ENTREGA")) {
      const comissaoPEcalc = venda - custo;
      if (comissaoPEcalc > 0) comissaoPE += comissaoPEcalc;
    }
  });

  // Atualiza DOM com as comissões por tipo
  document.getElementById('comissao-tnm').textContent = `COMISSÃO TNM: R$ ${comissaoTNM.toFixed(2)}`;
  document.getElementById('comissao-pe').textContent = `COMISSÃO PE: R$ ${comissaoPE.toFixed(2)}`;
  document.getElementById('comissao-adlink').textContent = `COMISSÃO AD LINK: R$ ${comissaoADLINK.toFixed(2)}`;


  // Lógica final de cálculo de adesões baseada nos dados filtrados
  let adesaoTNM = 0, adesaoPE = 0, adesaoAdLink = 0;

  regFiltrados.forEach(i => {
    const origem = (i.origem || "").toUpperCase();
    const tipo = (i.tipoBaixa || "").toLowerCase();
    const categoria = (i.categoria || "").toUpperCase();
    const comissao = parseFloat(i.comissao || 0);
    const venda = parseFloat(i.valorVenda || 0);
    const custo = parseFloat(i.custo || 0);

    if (origem === "TNM") adesaoTNM += comissao;
    if (tipo === "adlink") adesaoAdLink += comissao;
    if (origem.includes("PE") || categoria.includes("PRONTA ENTREGA")) {
      adesaoPE += venda - custo;
    }
  });

  document.getElementById('dash-adesoes-tnm').textContent = `ADESÕES TNM: R$ ${adesaoTNM.toFixed(2)}`;
  document.getElementById('dash-adesoes-pe').textContent = `ADESÕES PE: R$ ${adesaoPE.toFixed(2)}`;
  document.getElementById('dash-adesoes-adlink').textContent = `ADESÕES AD LINK: R$ ${adesaoAdLink.toFixed(2)}`;


  // Cálculo de adesões por tipo usando registros filtrados
  const totalTNM = regFiltrados
    .filter(i => (i.origem || "").toUpperCase() === "TNM")
    .reduce((s, i) => s + Number(i.valorVenda || 0), 0);

  const totalPE = regFiltrados
    .filter(i => (i.origem || "").toUpperCase().includes("PE"))
    .reduce((s, i) => s + Number(i.valorVenda || 0), 0);

  const totalAdLink = regFiltrados
    .filter(i => (i.tipoBaixa || "").toLowerCase() === "adlink")
    .reduce((s, i) => s + Number(i.valorVenda || 0), 0);

  document.getElementById('dash-adesoes-tnm').textContent = `ADESÕES TNM: R$ ${totalTNM.toFixed(2)}`;
  document.getElementById('dash-adesoes-pe').textContent = `ADESÕES PE: R$ ${totalPE.toFixed(2)}`;
  document.getElementById('dash-adesoes-adlink').textContent = `ADESÕES AD LINK: R$ ${totalAdLink.toFixed(2)}`;

}
</script>
<!-- Fim do trecho atualizado -->


<script>
// Exemplo de integração com os botões de filtro
document.getElementById("dash-hoje-btn").addEventListener("click", () => {
  const hoje = new Date();
  console.log("Filtro: Hoje");
  filtrarDashboardConsultor(hoje, hoje, "");
});

document.getElementById("dash-ontem-btn").addEventListener("click", () => {
  const ontem = new Date();
  ontem.setDate(ontem.getDate() - 1);
  console.log("Filtro: Ontem");
  filtrarDashboardConsultor(ontem, ontem, "");
});

document.getElementById("dash-este-mes-btn").addEventListener("click", () => {
  const hoje = new Date();
  const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  console.log("Filtro: Este Mês");
  filtrarDashboardConsultor(inicioMes, hoje, "");
});
</script>
